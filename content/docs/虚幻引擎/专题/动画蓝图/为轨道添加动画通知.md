---
title: "为轨道添加动画通知"
date: 2023-09-12T16:16:52
lastmod: 2023-09-12T16:19:11+08:00
draft: false
weight: 2003
---

`Track` `Animation Notify`  <br/>


## 便签 {#便签}

| -                                                                                 |      |
|-----------------------------------------------------------------------------------|------|
| [AnimNotify类](/docs/虚幻引擎/api/虚幻c++/动画/animnotify类/#animnotify类)        | 动画通知 |
| [AnimSequenceBase类](/docs/虚幻引擎/api/虚幻c++/动画/animsequencebase类/#animsequencebase类) | 动画 |


## 动画通知 {#动画通知}

通常在动画通知中, 对事件进行处理 <br/>

实现委托机制, 在AnimNotify中定义委托, 添加委托对象, 在Notify函数中通知客户端 <br/>

`ShootThemUp: Animations/STUAnimNotify.h` <br/>

```cpp
DECLARE_MULTICAST_DELEGATE_OneParam(FOnNotifiedSignature, USkeletalMeshComponent*);

UCLASS()
class SHOOTTHEMUP_API USTUAnimNotify : public UAnimNotify
{
    GENERATED_BODY()

public:
    FOnNotifiedSignature OnNotified;
    virtual void Notify(USkeletalMeshComponent *MeshComp, UAnimSequenceBase *Animation, const FAnimNotifyEventReference& EventReference) override;	
};
```

`ShootThemUp: Animation/STUAnimNotify.cpp` <br/>

```cpp
void USTUAnimNotify::Notify(USkeletalMeshComponent *MeshComp, UAnimSequenceBase *Animation, const FAnimNotifyEventReference& EventReference)
{
    OnNotified.Broadcast(MeshComp);
    Super::Notify(MeshComp, Animation, EventReference);
}
```


## 在轨道中添加通知事件 {#在轨道中添加通知事件}

以动画剪辑为例 <br/>

1.  在通知下属轨道的合适位置右键, 添加指定类型通知 <br/>
    
    <img src="/pic/专题/动画蓝图/为轨道添加动画通知/添加动画通知.png" width="1000" /> <br/> <br/>
    
    <img src="/pic/专题/动画蓝图/为轨道添加动画通知/通知类型.png" width="500" /> <br/> <br/>

2.  动画剪辑播放到事件所在帧时, 调用UAnimNotify::Notify <br/>


## 订阅委托服务 {#订阅委托服务}


### 遍历给定动画的通知事件, 获取指针, 指向指定类型的通知对象 {#遍历给定动画的通知事件-获取指针-指向指定类型的通知对象}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
template<typename T>
T* FindFirstNotifyByClass(UAnimSequenceBase *Animation)
{
    if (!Animation) return nullptr;

    const auto NotifyEvents = Animation->Notifies;
    for (auto NotifyEvent : NotifyEvents)
    {
        auto AnimNotify = Cast<T>(NotifyEvent.Notify);
        if (AnimNotify)
        {
            return AnimNotify;
        }
    }
    return nullptr;
}
```


### 注册处理函数 {#注册处理函数}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
auto EquipFinishedNotify = FindFirstNotifyByClass<USTUEquipFinishedAnimNotify>(EquipAnimMontage);
if (EquipFinishedNotify)
{
    EquipFinishedNotify->OnNotified.AddUObject(this, &USTUWeaponComponent::OnEquipFinished);
}
```

