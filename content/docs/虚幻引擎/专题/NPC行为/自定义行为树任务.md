---
title: "自定义行为树任务"
date: 2023-10-29T21:08:56
lastmod: 2023-10-29T21:31:38+08:00
draft: false
weight: 2003
---

生成随机点, 并设置到黑板变量 <br/>


## 说明 {#说明}

-   派生自C++类BTTaskNode <br/>
-   依赖模块 `GameplayTasks` 和 `NavigationSystem` <br/>


## 在构造函数中设置任务名 {#在构造函数中设置任务名}

`STUNextLocationTask` <br/>

```cpp
USTUNextLocationTask::USTUNextLocationTask()
{
    NodeName = "Next Location";
}
```


## 任务逻辑 {#任务逻辑}


### 原型 {#原型}

```cpp
virtual EBTNodeResult::Type ExecuteTask(UBehaviorTreeComponent& OwnerComp, uint8* NodeMemory);
```


### 返回值 {#返回值}

-   成功 <br/>
    ```cpp
    return EBTNodeResult::Succeeded;
    ```
-   失败 <br/>
    ```cpp
    return EBTNodeResult::Failed;
    ```


### 生成随机点 {#生成随机点}

```cpp
#include "AIController.h"
#include "NavigationSystem.h"

const auto Controller = OwnerComp.GetAIOwner();
if (!Controller) return EBTNodeResult::Failed;

const auto Pawn = Controller->GetPawn();
if (!Pawn) return EBTNodeResult::Failed;

const auto NavSys = UNavigationSystemV1::GetCurrent(Pawn);
if (!NavSys) return EBTNodeResult::Failed;

FNavLocation NavLocation;
const auto Found = NavSys->GetRandomReachablePointInRadius(Pawn->GetActorLocation(), 1000, NavLocation);
if (!Found) return EBTNodeResult::Failed;
```


### 设置黑板变量 {#设置黑板变量}

-   添加属性: 存放黑板变量信息 <br/>
    ```cpp
    UPROPERTY(EditAnywhere, BlueprintReadWrite)
    FBlackboardKeySelector AimLocationKey;
    ```
-   设置黑板变量 <br/>
    ```cpp
    #include "BehaviorTree/BlackboardComponent.h"
    
    const auto Blackboard = OwnerComp.GetBlackboardComponent();
    if (!Blackboard) return EBTNodeResult::Failed;
    Blackboard->SetValueAsVector(AimLocationKey.SelectedKeyName, NavLocation.Location);
    ```


### 完整实现 {#完整实现}

```cpp
#include "BehaviorTree/BlackboardComponent.h"
#include "AIController.h"
#include "NavigationSystem.h"

EBTNodeResult::Type USTUNextLocationTask::ExecuteTask(UBehaviorTreeComponent &OwnerComp, uint8 *NodeMemory)
{
    const auto Controller = OwnerComp.GetAIOwner();
    const auto Blackboard = OwnerComp.GetBlackboardComponent();
    if (!Controller || !Blackboard) return EBTNodeResult::Failed;

    const auto Pawn = Controller->GetPawn();
    if (!Pawn) return EBTNodeResult::Failed;

    const auto NavSys = UNavigationSystemV1::GetCurrent(Pawn);
    if (!NavSys) return EBTNodeResult::Failed;

    FNavLocation NavLocation;
    const auto Found = NavSys->GetRandomReachablePointInRadius(Pawn->GetActorLocation(), 1000, NavLocation);
    if (!Found) return EBTNodeResult::Failed;

    Blackboard->SetValueAsVector(AimLocationKey.SelectedKeyName, NavLocation.Location);
    return EBTNodeResult::Succeeded;
}
```


## 在行为树中使用该任务 {#在行为树中使用该任务}


### 添加黑板变量 {#添加黑板变量}

`BB_STUCharacter` <br/>

<img src="/pic/专题/NPC行为/自定义行为树任务/add-bb-key.png" width="200" /> <br/> <br/>


### 设置行为树 {#设置行为树}

-   添加节点: `Next Location` ; 设置待设置黑板变量 <br/>
    
    <img src="/pic/专题/NPC行为/自定义行为树任务/next-location.png" width="400" /> <br/> <br/>
-   添加节点: `Move To` ; 设置目的黑板变量 <br/>
    
    <img src="/pic/专题/NPC行为/自定义行为树任务/move-to.png" width="400" /> <br/> <br/>
-   完整行为树 <br/>
    
    <img src="/pic/专题/NPC行为/自定义行为树任务/bt.png" width="600" /> <br/> <br/>

