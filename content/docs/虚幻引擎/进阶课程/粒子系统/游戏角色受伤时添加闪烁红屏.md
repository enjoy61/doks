---
title: "游戏角色受伤时添加闪烁红屏"
date: 2023-10-15T23:17:32
lastmod: 2023-10-16T00:35:32+08:00
draft: false
weight: 2008
---

## 说明 {#说明}

`UMG Damage Effect` <br/>
通过窗口部件实现. 游戏角色受伤时添加闪烁红屏, 作为流血特效 <br/>


## 窗口部件 {#窗口部件}

`WBP_PlayerHUD` <br/>

-   添加图片 `Image` 元素, 命名为DamageImage, 移动到层级结构上方 <br/>
    
    <img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/image-top.png" width="300" /> <br/> <br/>
-   铺满视口 <br/>
    `Details > Anchors` , 选择铺满 <br/>
    
    <img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/anchors-fill.png" width="500" /> <br/> <br/>
    
    设置Offset Left = Offset Top = Offset Right = Offset Bottom = 0 <br/>
    
    <img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/offset.png" width="1000" /> <br/> <br/>
-   设置颜色 <br/>
    `Details > Appearance > Color and Opacity` , 设置为红色; 设置Alpha分量为0 <br/>
    
    <img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/red.png" width="1000" /> <br/> <br/>


### 为DamageImage添加动画 {#为damageimage添加动画}

选中DamageImage, 打开Animations窗口 <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/open-animation-editor.png" width="500" /> <br/> <br/>

点击 `+Animation` , 命名为DamageAnimation <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/click-animation.png" width="500" /> <br/> <br/>

为DamageAnimation添加Track <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/add-track-for.png" width="500" /> <br/> <br/>

选择DamageImage <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/for-damage-image.png" width="500" /> <br/> <br/>


#### 设置关键帧0.25 {#设置关键帧0-dot-25}

在DamageImage这一栏, 点击 `+Track` <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/add-track.png" width="500" /> <br/> <br/>

选择Color and Opacity <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/color-and-opacity.png" width="500" /> <br/> <br/>

设置Alpha通道为0.6 <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/0.25.png" width="800" /> <br/> <br/>


#### 设置关键帧0.5 {#设置关键帧0-dot-5}

同上, 设置Alpha通道为0 <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/0.5.png" width="800" /> <br/> <br/>


## 播放DamageImage动画 {#播放damageimage动画}

`WBP_PlayerHUD > Event Graph` <br/>

-   稍后在C++中定义事件 <br/>
-   添加DamageAnimation变量 <br/>
    
    <img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/damage-animation.png" width="600" /> <br/> <br/>
-   作为PlayAnimation的输入 <br/>
    
    <img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/play-animation.png" width="600" /> <br/> <br/>


## 生命值减少触发事件 {#生命值减少触发事件}


### 定义蓝图事件 {#定义蓝图事件}

使用宏声明符创建蓝图事件, 该函数只声明不定义 <br/>
`ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>
`public` <br/>

```cpp
UFUNCTION(BlueprintImplementableEvent)
void OnTakeDamage();
```


### 生命值减少通知 {#生命值减少通知}

两种方法 <br/>

-   [ ] 定义委托, 游戏角色受伤时通知客户端 <br/>
-   [X] 修改当前委托定义, 添加额外参数, 显示生命值变化 <br/>


#### 修改委托 {#修改委托}

<!--list-separator-->

-  修改委托定义

    `STUCoreTypes.h` <br/>
    
    ```cpp
    DECLARE_MULTICAST_DELEGATE_OneParam(FChangeHealthSignature, float);
    ```

<!--list-separator-->

-  修改服务端广播

    `ShootThemUp: Components/STUHealthComponent.cpp` <br/>
    
    ```cpp
    // SetHealth
    
    const auto NextHealth = FMath::Clamp(NewHealth, 0.0f, MaxHealth);
    const auto HealthDelta = NextHealth - Health;
    
    Health = NextHealth;
    OnChangeHealth.Broadcast(HealthDelta);
    ```

<!--list-separator-->

-  修改客户端

    -   处理函数声明 <br/>
        `ShootThemUp: Player/STUBaseCharacter.h` <br/>
        ```cpp
        void OnChangeHealth(float HealthDelta);
        ```
    -   处理函数定义 <br/>
        `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>


#### 窗口部件类订阅生命值减少委托, 并触发事件 {#窗口部件类订阅生命值减少委托-并触发事件}

<!--list-separator-->

-  处理函数

    `ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>
    `private` <br/>
    
    ```cpp
    void OnChangeHealth(float HealthDelta);
    ```
    
    触发事件 <br/>
    `ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>
    
    ```cpp
    void USTUPlayerHUDWidget::OnChangeHealth(float HealthDelta)
    {
        if (HealthDelta < 0.0f)
        {
            OnTakeDamage();
        }
    }
    ```

<!--list-separator-->

-  在Initialize函数中完成订阅

    `ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>
    `private` <br/>
    
    ```cpp
    virtual bool Initialize() override;
    ```
    
    `ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>
    
    ```cpp
    bool USTUPlayerHUDWidget::Initialize()
    {
        const auto HealthComponent = STUUtils::GetSTUPlayerComponent<USTUHealthComponent>(GetOwningPlayerPawn());
        if (HealthComponent)
        {
            HealthComponent->OnChangeHealth.AddUObject(this, &USTUPlayerHUDWidget::OnChangeHealth);
        }
        return Super::Initialize();
    }
    ```


## 在蓝图中添加事件 {#在蓝图中添加事件}

`WBP_PlayerHUD > EventGraph` <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/add-event.png" width="600" /> <br/> <br/>

事件发生时播放DamageAnimation动画 <br/>


## 受到伤害时, 有序播放动画 {#受到伤害时-有序播放动画}

`WBP_PlayerHUD > EventGraph` <br/>

添加节点 `IsAnimationPlaying` 判断当前动画播放状态; 添加分支: 事件发生时, 若未播放动画, 播放动画 <br/>

<img src="/pic/粒子系统/游戏角色受伤时添加闪烁红屏/branch.png" width="800" /> <br/> <br/>


## 其他: 修改武器组件注册弹匣为空委托的处理函数名 {#其他-修改武器组件注册弹匣为空委托的处理函数名}

由OnEmptyClip改为OnClipEmpty, 和委托成员一致 <br/>

-   声明 <br/>
    `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    ```cpp
    void OnClipEmpty(ASTUBaseWeapon *AmmoEmptyWeapon);
    ```
-   定义 <br/>
    `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    void USTUWeaponComponent::OnClipEmpty(ASTUBaseWeapon *AmmoEmptyWeapon)
    {
        // ...
    }
    ```
-   注册处理函数 <br/>
    `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    Weapon->OnClipEmpty.AddUObject(this, &USTUWeaponComponent::OnClipEmpty);
    ```

