---
title: "枪口特效"
date: 2023-10-16T06:00:02
lastmod: 2023-10-16T06:08:22+08:00
draft: false
weight: 2010
---

## 说明 {#说明}

创建一个发射器NE_LauncherFlash, 两个粒子系统NS_LauncherMuzzle和NS_RiffleMuzzle <br/>

发射器的枪口特效较简单. 步枪的射击涉及定时器, 只创建一次粒子系统, 开始射击时, 令其开始并将其渲染, 停止射击时令其暂停, 不再对其进行渲染 <br/>


## 创建Niagara粒子发射器 {#创建niagara粒子发射器}

创建文件夹 `Content/VFX/Muzzles` <br/>

-   创建Niagara粒子发射器 <br/>
    
    <img src="/pic/粒子系统/枪口特效/create-ne.png" width="600" /> <br/> <br/>

-   使用模板 <br/>
    
    <img src="/pic/粒子系统/枪口特效/from-template.png" width="400" /> <br/> <br/>

-   选择 `Simple Sprite Burst` , 命名为NE_LauncherFlash <br/>
    
    <img src="/pic/粒子系统/枪口特效/sprite.png" width="400" /> <br/> <br/>

-   设置纹理 <br/>
    
    <img src="/pic/粒子系统/枪口特效/set-material.png" width="900" /> <br/> <br/>

-   使用默认发射器状态: 不循环; 设置时长 <br/>
    
    <img src="/pic/粒子系统/枪口特效/ne-duration.png" width="900" /> <br/> <br/>

-   设置粒子数 <br/>
    
    <img src="/pic/粒子系统/枪口特效/设置粒子数.png" width="900" /> <br/> <br/>

-   设置外观 <br/>
    生存时间, 颜色, 聚集方式, 分布, 旋转模式 <br/>
    
    <img src="/pic/粒子系统/枪口特效/规格.png" width="900" /> <br/> <br/>

-   添加属性: `Scale Sprite Size` <br/>
    
    <img src="/pic/粒子系统/枪口特效/add-scale-sprite-size.png" width="900" /> <br/> <br/>
    
    起点 <br/>
    
    <img src="/pic/粒子系统/枪口特效/start.png" width="900" /> <br/> <br/>
    
    终点 <br/>
    
    <img src="/pic/粒子系统/枪口特效/end.png" width="900" /> <br/> <br/>

-   添加属性: `Sprite Rotation Rate` <br/>
    
    <img src="/pic/粒子系统/枪口特效/sprite-rotation-rate.png" width="900" /> <br/> <br/>
    
    设置Rotation Rate为 `Particles > Initial > MaterialRandom` <br/>
    
    <img src="/pic/粒子系统/枪口特效/rotation-rate.png" width="900" /> <br/> <br/>


## 基于NE_LauncherFlash创建发射器使用的Niagara粒子系统资产 {#基于ne-launcherflash创建发射器使用的niagara粒子系统资产}

右键NE_LauncherFlash, 命名为NS_LauncherMuzzle <br/>

<img src="/pic/粒子系统/枪口特效/create-ns.png" width="600" /> <br/> <br/>

设置不变, 只播放一次 <br/>

<img src="/pic/粒子系统/枪口特效/ns-launcher.png" width="1000" /> <br/> <br/>


## 基于NE_LauncherFlash创建步枪使用的Niagara粒子系统资产 {#基于ne-launcherflash创建步枪使用的niagara粒子系统资产}

命名为NS_RifleMuzzle <br/>

循环播放, 设置时长 <br/>

<img src="/pic/粒子系统/枪口特效/ns-rifle-state.png" width="1000" /> <br/> <br/>

添加属性: `Spawn Rate` <br/>

<img src="/pic/粒子系统/枪口特效/add-spawn-rate.png" width="500" /> <br/> <br/>

设置为90 <br/>

<img src="/pic/粒子系统/枪口特效/spawn-rate.png" width="800" /> <br/> <br/>

设置颜色 <br/>

<img src="/pic/粒子系统/枪口特效/ns-rifle-color.png" width="1000" /> <br/> <br/>


## 优化榴弹冲击特效 {#优化榴弹冲击特效}

`NS_ProjectileImpact` <br/>

设置粒子数 <br/>

<img src="/pic/粒子系统/枪口特效/projectile-count.png" width="600" /> <br/> <br/>

设置分布 <br/>

<img src="/pic/粒子系统/枪口特效/distribution.png" width="600" /> <br/> <br/>


## 枪口特效 {#枪口特效}


### 武器基类: 在枪口生成特效, 返回Niagara组件 {#武器基类-在枪口生成特效-返回niagara组件}


#### 添加属性: 保存特效类型 {#添加属性-保存特效类型}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
`protected` <br/>

```cpp
class UNiagaraSystem;

UPROPERTY(EDitDefaultsOnly, BlueprintReadWrite)
UNiagaraSystem *MuzzleFX;
```


#### 添加接口: 在枪口生成特效, 播放完自动销毁, 返回Niagara组件 {#添加接口-在枪口生成特效-播放完自动销毁-返回niagara组件}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
`protected` <br/>

```cpp
class UNiagaraComponent;

UNiagaraComponent *SpawnMuzzleFX();
```

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
#include "NiagaraFunctionLibrary.h"
#include "NiagaraComponent.h"

UNiagaraComponent *ASTUBaseWeapon::SpawnMuzzleFX()
{
    return UNiagaraFunctionLibrary::SpawnSystemAttached(MuzzleFX, //
                                                        WeaponMeshComponent, //
                                                        MuzzleSocketName, //
                                                        FVector::ZeroVector, //
                                                        FRotator::ZeroRotator, //
                                                        EAttachLocation::SnapToTarget,//
                                                        true);
}
```

<!--list-separator-->

-  UNiagaraFunctionLibrary::SpawnSystemAttached

    Niagaram粒子系统的变换与上级组件变换保持一致 <br/>
    
    ```cpp
    static UNiagaraComponent* SpawnSystemAttached(UNiagaraSystem* SystemTemplate,
                                                  USceneComponent* AttachToComponent,
                                                  FName AttachPointName,
                                                  FVector Location,
                                                  FRotator Rotation,
                                                  EAttachLocation::Type LocationType,
                                                  bool bAutoDestroy,
                                                  bool bAutoActivate = true,
                                                  ENCPoolMethod PoolingMethod = ENCPoolMethod::None,
                                                  bool bPreCullCheck = true);
    ```
    
    | -                 |                |
    |-------------------|----------------|
    | SystemTemplate    | 粒子特效类型   |
    | AttachToComponent | 上级组件       |
    | AttachPointName   | 挂载点         |
    | Location          | 位置           |
    | Rotation          | 方向向量       |
    | LocationType      | 挂载方式       |
    | bAutoDestroy      | 特效若没有循环, 结束后销毁 |


### 榴弹发射器 {#榴弹发射器}

射击后生成枪口特效 <br/>
`ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>

```cpp
// MakeShot
SpawnMuzzleFX();
```


### 步枪 {#步枪}


#### 添加属性: 保存Niagara组件 {#添加属性-保存niagara组件}

`ShootThemUp: Weapon/STURifleWeapon.h` <br/>
`private` <br/>

```cpp
class UNiagaraComponent;

UPROPERTY()
UNiagaraComponent *MuzzleFXComponent;
```


#### 添加接口: 根据标志位设置特效 {#添加接口-根据标志位设置特效}

`ShootThemUp: Weapon/STURifleWeapon.h` <br/>
`private` <br/>

```cpp
void SetMuzzleFXVisibility(bool Visible);
```

`ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>

```cpp
#include "NiagaraComponent.h"
void ASTURifleWeapon::SetMuzzleFXVisibility(bool Visible)
{
    if (MuzzleFXComponent)
    {
        MuzzleFXComponent->SetPaused(!Visible);
        MuzzleFXComponent->SetVisibility(Visible, true);
    }
}
```

<!--list-separator-->

-  SetPaused

    设置粒子系统暂停或继续, 即, 与Tick函数有关 <br/>

<!--list-separator-->

-  SetVisibility

    设置是否渲染粒子系统 <br/>
    
    第二个参数影响子节点的渲染, 此处设为true或false无影响 <br/>


#### 添加接口: 在枪口生成特效, 设置特效可见 {#添加接口-在枪口生成特效-设置特效可见}

`ShootThemUp: Weapon/STURifleWeapon.h` <br/>
`private` <br/>

```cpp
void InitMuzzleFX();
```

`ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>

```cpp
void ASTURifleWeapon::InitMuzzleFX()
{
    if (!MuzzleFXComponent)
    {
        MuzzleFXComponent = SpawnMuzzleFX();
    }
    SetMuzzleFXVisibility(true);
}
```


#### 射击时生成特效或设置特效可见 {#射击时生成特效或设置特效可见}

```cpp
// FireStart
InitMuzzleFX();
```


#### 停止射击时设置特效不可见 {#停止射击时设置特效不可见}

```cpp
// FireStop
SetMuzzleFXVisibility(false);
```


## 查看 {#查看}

设置步枪枪口动画 <br/>

<img src="/pic/粒子系统/枪口特效/rifle.png" width="900" /> <br/> <br/>

设置发射器枪口动画 <br/>

<img src="/pic/粒子系统/枪口特效/launcher.png" width="900" /> <br/> <br/>

步枪射击时移动, 有神龙甩尾的效果... <br/>

