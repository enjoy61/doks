---
title: "撞击特效组件"
date: 2023-10-12T20:05:28
lastmod: 2023-10-12T20:53:51+08:00
draft: false
weight: 2003
---

## 说明 {#说明}

子弹和榴弹击中时, 生成特效 <br/>


## 创建VFX组件 {#创建vfx组件}

武器的下级组件 <br/>

| -  |                      |
|----|----------------------|
| 基类 | ActorComponent       |
|    | STUWeaponFXComponent |
|    | Weapon/Components    |

<img src="/pic/粒子系统/撞击特效组件/create-stuweaponfxcomponent.png" width="800" /> <br/> <br/>


### 添加到头文件搜索路径 {#添加到头文件搜索路径}

`ShootThemUp: ShootThemUp.Build.cs` <br/>

```cpp
PublicIncludePaths.AddRange(new string[]
{
    "ShootThemUp/Public/Player",
    "ShootThemUp/Public/Components",
    "ShootThemUp/Public/Dev",
    "ShootThemUp/Public/Weapon",
    "ShootThemUp/Public/UI",
    "ShootThemUp/Public/Animations",
    "ShootThemUp/Public/Pickups",
    "ShootThemUp/Public/Weapon/Components"            
});
```


### 添加依赖模块 {#添加依赖模块}

`ShootThemUp: ShootThemUp.Build.cs` <br/>

```cpp
PublicDependencyModuleNames.AddRange(new string[]
{ "Core",
  "CoreUObject",
  "Engine",
  "InputCore",
  "Niagara"
});
```

编译项目 <br/>


## 实现撞击特效组件 {#实现撞击特效组件}

`ShootThemUp: Weapon/Components/STUWeaponFXComponent.h` <br/>

```cpp
class UNiagaraSystem;

// public
void PlayImpactFX(const FHitResult &Hit);

// protected
UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
UNiagaraSystem *Effect;
```

碰撞信息结构体包含生成特效的所有信息: 位置, 法向量等 <br/>
`ShootThemUp: Weapon/Components/STUWeaponFXComponent.cpp` <br/>

```cpp
#include "NiagaraFunctionLibrary.h"

void USTUWeaponFXComponent::PlayImpactFX(const FHitResult &Hit)
{
    UNiagaraFunctionLibrary::SpawnSystemAtLocation(GetWorld(), Effect, Hit.ImpactPoint, Hit.ImpactNormal.Rotation());
}
```


### UNiagaraFunctionLibrary::SpawnSystemAtLocation {#uniagarafunctionlibrary-spawnsystematlocation}

`Engine/Plugins` <br/>

```cpp
static UNiagaraComponent* SpawnSystemAtLocation(const UObject* WorldContextObject, class UNiagaraSystem* SystemTemplate, FVector Location, FRotator Rotation = FRotator::ZeroRotator, FVector Scale = FVector(1.f), bool bAutoDestroy = true, bool bAutoActivate = true, ENCPoolMethod PoolingMethod = ENCPoolMethod::None, bool bPreCullCheck = true);
```

-   在指定位置生成特效 <br/>
-   会检查粒子系统指针和上下文指针 <br/>

| -                  |                         |
|--------------------|-------------------------|
| WorldContentObject | 上下文, 传入GetWorld()或this |
| SystemTemplate     | 指向Niagara System的指针 |
| SpawnLocation      | 生成地点                |
| Rotation           | 朝向                    |
| bAutoDestroy       | 为true时, 粒子系统特效结束即从世界中移除 |


## 为步枪添加碰撞特效组件 {#为步枪添加碰撞特效组件}

`ShootThemUp: Weapon/STURifleWeapon.h` <br/>

```cpp
class USTUWeaponFXComponent;

// protected
UPROPERTY(VisibleAnywhere)
USTUWeaponFXComponent *WeaponFXComponent;

// public
ASTURifleWeapon();

// protected
virtual void BeginPlay() override;
```

`ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
屏蔽绘制子弹轨迹和击中点 <br/>

```cpp
#include "Weapon/Components/STUWeaponFXComponent.h"

ASTURifleWeapon::ASTURifleWeapon()
{
    WeaponFXComponent = CreateDefaultSubobject<USTUWeaponFXComponent>("WeaponFXComponent");
}

void ASTURifleWeapon::BeginPlay()
{
    Super::BeginPlay();
    check(WeaponFXComponent);
}

// MakeShot
if (HitResult.bBlockingHit)
{
    // ...
    WeaponFXComponent->PlayImpactFX(HitResult);
}
```


## 为榴弹添加碰撞特效组件 {#为榴弹添加碰撞特效组件}

`ShootThemUp: Weapon/STUProjectile.h` <br/>

```cpp
class USTUWeaponFXComponent;

// protected
UPROPERTY(VisibleAnywhere)
USTUWeaponFXComponent *WeaponFXComponent;
```

`ShootThemUp: Weapon/STUProjectile.cpp` <br/>

```cpp
#include "Weapon/Components/STUWeaponFXComponent.h"

// ASTUProjectile
WeaponFXComponent = CreateDefaultSubobject<USTUWeaponFXComponent>("WeaponFXComponent");

// BeginPlay
check(WeaponFXComponent);

// OnProjectileHit
WeaponFXComponent->PlayImpactFX(Hit);
```


## 查看 {#查看}

设置步枪和榴弹的粒子系统指针类型 <br/>

-   步枪 <br/>
    
    <img src="/pic/粒子系统/撞击特效组件/rifle.png" width="800" /> <br/> <br/>
-   榴弹 <br/>
    
    <img src="/pic/粒子系统/撞击特效组件/projectile.png" width="1000" /> <br/> <br/>

设置粒子系统 <br/>
`NS_BaseImpact` <br/>

-   粒子个数 <br/>
    
    <img src="/pic/粒子系统/撞击特效组件/spawn-count.png" width="700" /> <br/> <br/>
-   颜色 <br/>
    
    <img src="/pic/粒子系统/撞击特效组件/color.png" width="700" /> <br/> <br/>
-   方向: 修改速度方向 <br/>
    
    <img src="/pic/粒子系统/撞击特效组件/direction.png" width="700" /> <br/> <br/>

