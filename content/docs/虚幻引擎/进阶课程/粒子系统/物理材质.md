---
title: "物理材质"
date: 2023-10-13T21:10:56
lastmod: 2023-10-13T21:15:02+08:00
draft: false
weight: 2004
---

## 说明 {#说明}

-   实现: 与不同材质的表面发生碰撞时, 产生不同的撞击特效 <br/>
-   三类物理材质: 地面和楼梯, 游戏角色身体部分, 游戏角色头部 <br/>
    也是击中游戏角色不同部位造成不同伤害数值的另一种实现 <br/>
-   为网格体设置物理材质 `Physical Material` <br/>
-   获取撞击物体的物理材质, 生成对应特效 <br/>


## 物理材质 {#物理材质}

如果对物体使能物理仿真, 其会根据设置与其他物体互动 <br/>

设置物体的物理特性, 对应一种表面类型 <br/>

通过物理材质, 创建表面类型, 根据撞击物体的表面类型, 产生对应特效 <br/>

目前只使用物理材质来定义表面类型, 而不用于物理仿真 <br/>


## 创建多种特效 {#创建多种特效}

-   未设定当前物理材质对应的特效时, 生成默认特效 <br/>
    重命名NS_BaseImpact为NS_DefaultImpact, 设置颜色为黑色 <br/>
    
    <img src="/pic/粒子系统/物理材质/set-color-dark.png" width="1000" /> <br/> <br/>
-   按下 `Ctrl-D` 复制NS_DefaultImpact, 命名为NS_GroundImpact、NS_HeadImpact和NS_BodyImpact <br/>
-   设置NS_GroundImpact <br/>
    设置为绿色 <br/>
    
    <img src="/pic/粒子系统/物理材质/set-color-green.png" width="800" /> <br/> <br/>
-   设置NS_HeadImpact <br/>
    设置为暗红色 <br/>
    
    <img src="/pic/粒子系统/物理材质/set-color-dark-red.png" width="800" /> <br/> <br/>
    
    设置粒子数 <br/>
    
    <img src="/pic/粒子系统/物理材质/set-spawn-count.png" width="800" /> <br/> <br/>
-   设置NS_BodyImpact <br/>
    设置为红色 <br/>
    
    <img src="/pic/粒子系统/物理材质/set-color-red.png" width="800" /> <br/> <br/>


## 创建物理材质 {#创建物理材质}

创建文件夹 `Content/PhysMaterials` <br/>

<img src="/pic/粒子系统/物理材质/create-physical-materials.png" width="800" /> <br/> <br/>

选择类, 命名为PhysMat_Ground <br/>

<img src="/pic/粒子系统/物理材质/set-phymats-class.png" width="600" /> <br/> <br/>

复制PhysMat_Ground, 命名为PhysMat_Head和PhysMat_Body <br/>


## 为物体设置物理材质 {#为物体设置物理材质}

物理材质只能应用到网格体, 而地板和楼梯使用几何体笔刷构造, 并不是网格体. 我们可以将其转换为网格体 <br/>

目前, 击中地板和楼梯时, 生成默认特效 <br/>

添加几何网格体 `Place Actors > Shapes > Cube` , 设置物理材质为PhysMat_Ground <br/>

<img src="/pic/粒子系统/物理材质/cube-physmat-ground.png" width="500" /> <br/> <br/>


## 为游戏角色设置物理材质 {#为游戏角色设置物理材质}

打开 `Content > ExternalContent > Animation > Characters > HeroTPP > HeroTPP_Physics` <br/>

-   为头部设置物理材质 <br/>
    
    <img src="/pic/粒子系统/物理材质/head-physmat.png" width="1000" /> <br/> <br/>
-   为身体其他部位挨个设置物理材质 <br/>
    
    <img src="/pic/粒子系统/物理材质/body-physmat.png" width="1000" /> <br/> <br/>


## 获取物理材质信息生成对应类型特效 {#获取物理材质信息生成对应类型特效}


### 添加依赖模块PhysicsCore {#添加依赖模块physicscore}

`ShootThemUp: ShootThemUp.Build.cs` <br/>

```cpp
PublicDependencyModuleNames.AddRange(new string[]
{
    "Core",
    "CoreUObject",
    "Engine",
    "InputCore",
    "Niagara",
    "PhysicsCore"
});
```


### 发生碰撞时, 传递物理材质信息 {#发生碰撞时-传递物理材质信息}

FHitResult结构体的PhysMaterial字段存放物理材质信息, 其类型为TWeakObjectPtr, 是Weak指针在虚幻引擎的内部实现 <br/>

同样, 使用前需检查有效性, 使用时通过Get <br/>

使能标志位, 在FHitResult结构体中保存物理材质信息 <br/>


#### 步枪 {#步枪}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
// MakeHit
CollisionParams.bReturnPhysicalMaterial = true;
```


#### 榴弹 {#榴弹}

`ShootThemUp: Weapon/STUProjectile.cpp` <br/>

```cpp
// ASTUProjectile
CollisionComponent->bReturnMaterialOnMove = true;
```


### 撞击特效组件: 保存物理材质和特效类型的对应关系 {#撞击特效组件-保存物理材质和特效类型的对应关系}

将Effect属性重命名为DefaultEffect, 作为默认特效类型 <br/>


#### 使用TMap类型保存对应关系 {#使用tmap类型保存对应关系}

关联容器类型Map在虚幻引擎的内部实现 <br/>
`ShootThemUp: Weapon/Components/STUWeaponFXComponent.h`        <br/>
`protected` <br/>

```cpp
class UPhysicalMaterial;

UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
TMap<UPhysicalMaterial*, UNiagaraSystem*> EffectsMap;
```


#### 发生碰撞时, 查询特效类型并使用 {#发生碰撞时-查询特效类型并使用}

`ShootThemUp: Weapon/Components/STUWeaponFXComponent.cpp` <br/>

```cpp
#include "PhysicalMaterials/PhysicalMaterial.h"

// PlayImpactFX

auto Effect = DefaultEffect;

if (Hit.PhysMaterial.IsValid())
{
    const auto PhysMat = Hit.PhysMaterial.Get();
    if (EffectsMap.Contains(PhysMat))
    {
        Effect = EffectsMap[PhysMat];
    }
}
```


## 查看 {#查看}

设置步枪和榴弹的默认特效为NS_DefaultImpact <br/>


### 步枪 {#步枪}

设置物理材质和特效的对应关系 <br/>

| -              |                 |
|----------------|-----------------|
| PhysMat_Body   | NS_BodyImpact   |
| PhysMat_Head   | NS_HeadImpact   |
| PhysMat_Ground | NS_GroundImpact |

<img src="/pic/粒子系统/物理材质/rifle-effect-map.png" width="800" /> <br/> <br/>

-   拷贝设置小技巧 <br/>
    右键EffectsMap, 选择Copy; 去到另一个EffectsMap, 右键粘贴 <br/>
    
    <img src="/pic/粒子系统/物理材质/trick.png" width="400" /> <br/> <br/>


### 榴弹 {#榴弹}


#### 新建Niagara粒子系统资产用于榴弹 {#新建niagara粒子系统资产用于榴弹}

-   如果模板中有 `Simple Explosion` , 使用现有模板 <br/>
    
    <img src="/pic/粒子系统/物理材质/use-template.png" width="400" /> <br/> <br/>
-   否则, 选择现有发射器 <br/>
    
    <img src="/pic/粒子系统/物理材质/selected-emitters.png" width="600" /> <br/> <br/>
    
    依次添加 `OmnidirectionalBurst` `UpwardMeshBurst` `SimpleSpriteBurst` <br/>
    
    <img src="/pic/粒子系统/物理材质/add-emitters.png" width="600" /> <br/> <br/>
-   命名为NS_ProjectileImpact <br/>


#### 查看单个发射器效果 {#查看单个发射器效果}

点击图标 <br/>

<img src="/pic/粒子系统/物理材质/lp.png" width="300" /> <br/> <br/>


#### 设置速度方向 {#设置速度方向}

`Add Velocity from Point > Origin Offset` , 对调X和Z的值 <br/>

<!--list-separator-->

-  如果使用现有发射器创建粒子系统

    -   OmnidirectionalBurst <br/>
        Velocity Mode : From Point <br/>
        Velocity Speed : Random Range Float; Minimum = 350, Maximum = 550 <br/>
        Offet &gt; Origin Offset : X = -24, Z = 0 <br/>
        
        <img src="/pic/粒子系统/物理材质/omn.png" width="800" /> <br/> <br/>
    -   UpwardMeshBurst <br/>
        Velocity Mode : In Cone <br/>
        Velocity Speed : Random Range Float; Minimum = 100, Maximum = 400 <br/>
        Cone &gt; Axis : X = 1, Z = 0 <br/>
        Cone &gt; Angle : 66 <br/>
        
        <img src="/pic/粒子系统/物理材质/up.png" width="800" /> <br/> <br/>
    -   SimpleSpriteBurst <br/>
        Velocity Mode : From Point <br/>
        Velocity Speed : Random Range Float; Minimum = 50, Maximum = 200 <br/>
        Offet &gt; Origin Offset : X = -85, Z = 0 <br/>
        
        <img src="/pic/粒子系统/物理材质/sim.png" width="600" /> <br/> <br/>


#### 设置榴弹默认特效为NS_ProjectileImpact {#设置榴弹默认特效为ns-projectileimpact}


## 添加插件的方法 {#添加插件的方法}

`Edit > Plugin` <br/>

勾选NiagaraFluids, 重启 <br/>

<img src="/pic/粒子系统/物理材质/select-niagarafluids.png" width="800" /> <br/>      <br/>

