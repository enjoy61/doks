---
title: "使用贴花实现弹痕"
date: 2023-10-15T16:49:35
lastmod: 2023-10-15T16:57:41+08:00
draft: false
weight: 2005
---

## 说明 {#说明}

使用贴花实现弹痕 <br/>


## 从ShooterGame获取贴花资产 {#从shootergame获取贴花资产}

`Content/Effects/materials/Weapon/M_Impact_Decal` , 右键 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/migrate.png" width="600" /> <br/> <br/>

文件夹结构 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/folder-struct.png" width="600" /> <br/> <br/>


## 导入ShootThemUp {#导入shootthemup}

将Effect重命名为BulletDecal, 移动到 `ExternalContent` , 设置文件夹颜色 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/folder-color.png" width="500" /> <br/> <br/>

用来实现弹痕 <br/>


## 重新构造光照 {#重新构造光照}

有对应提示时 <br/>

-   设置光照质量 <br/>
    `Build > Lighting Quality` <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/light-quality.png" width="400" /> <br/> <br/>
-   构造光照 <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/build-light.png" width="300" /> <br/> <br/>


## 贴花 {#贴花}

可以投影到网格体的特殊材质. 支持静态网格体和骨骼网格体 <br/>

可以设置贴花的体积大小, 纹理, 隐入隐出相关参数 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/decal-param.png" width="500" /> <br/> <br/>

贴花Actor对应一个立方体, 立方体与包含物体的相交面作为投影面 <br/>

我们可以使用贴花在墙上画涂鸦, 在不同表面上生成不同子弹特效 <br/>


## 测试贴花Actor {#测试贴花actor}


### 创建测试纹理 {#创建测试纹理}

-   创建文件夹 `Content/Dev` <br/>
-   从网络下载虚幻引擎Logo作为纹理, 保存到Content/Dev <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/UnrealLogo.png" width="200" /> <br/> <br/>
-   右键图片, 创建纹理, 命名为M_TestDecal <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/create-test-material.png" width="500" /> <br/> <br/>
-   和之前的材质比较, 图片作为BaseColor的输入 <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/texture-input.png" width="500" /> <br/> <br/>
-   将材质作为贴花使用的设置 <br/>
    延后贴花; 半透明渲染: `Details > Material > Material Domain` , 设置为 `Deferred Decal` ;  `Blend Mode` 设置为 `Translucent` <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/material-set.png" width="400" /> <br/> <br/>
    
    Alpha通道作为透明度的输入 <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/a-opacity.png" width="400" /> <br/> <br/>


### 设置贴花 {#设置贴花}

-   添加贴花Actor到关卡中 <br/>
    `Place Actors > Visual Effects > Decal Actor` <br/>
-   使用M_TestDecal <br/>
    选中贴花, 点击应用图标 <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/apply-decal.png" width="1200" /> <br/> <br/>
    
    <img src="/pic/粒子系统/使用贴花实现弹痕/test-decal.png" width="1000" /> <br/> <br/>
-   设置贴花体积 <br/>
    选中DecalActor, `Details > Decal > Decal Size` , 设置X = 10, Y = Z = 20 <br/>


## 查看弹痕贴花 {#查看弹痕贴花}

`Content/ExternalContent/BulletDecal/Materials/Weapon/M_Impact_Decal` <br/>
双击打开, 较M_TestDecal更为复杂, 添加了法向量和饱和度设置, 用以提高视觉质量 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/m-impact-decal.png" width="1000" /> <br/> <br/>


## 击中时生成贴花 {#击中时生成贴花}

产生冲击特效时生成贴花 <br/>


### 添加数据结构 {#添加数据结构}

`STUCoreTypes.h`       <br/>


#### 贴花信息 {#贴花信息}

-   贴花材质 <br/>
-   立方体体积参数 <br/>
-   留存时间 <br/>
-   贴花Alpha分量的动画时长 <br/>
    在给定时长, 贴花从场景中消失 <br/>

<!--listend-->

```cpp
// VFX
class UMaterialInterface;
USTRUCT(BlueprintType)
struct FDecalData
{
    GENERATED_USTRUCT_BODY()

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    UMaterialInterface *Material;

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    FVector Size = FVector(10.0f);

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    float LifeTime = 5.0f;

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    float FadeOutTime = 0.7f;
};
```


#### 特效信息整合: 包含Niagara粒子系统和贴花 {#特效信息整合-包含niagara粒子系统和贴花}

```cpp
class NiagaraSystem;

USTRUCT(BlueprintType)
struct FImpactData
{
    GENERATED_USTRUCT_BODY()

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    UNiagaraSystem *NiagaraEffect;

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    FDecalData DecalData;
};
```


### 使用特效数据结构 {#使用特效数据结构}

`ShootThemUp: Weapon/Components/STUWeaponFXComponent.h` <br/>
`protected` <br/>

```cpp
#include "STUCoreTypes.h"

UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
FImpactData DefaultImpactData;

UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
TMap<UPhysicalMaterial*, FImpactData> ImpactDataMap;
```

`ShootThemUp: Weapon/Components/STUWeaponFXComponent.cpp` <br/>

```cpp
auto ImpactData = DefaultImpactData;

if (ImpactDataMap.Contains(PhysMat))
{
    ImpactData = ImpactDataMap[PhysMat];
}

// Niagara
UNiagaraFunctionLibrary::SpawnSystemAtLocation(GetWorld(), //
                                               ImpactData.NiagaraEffect, //
                                               Hit.ImpactPoint, //
                                               Hit.ImpactNormal.Rotation());
```


### 生成贴花 {#生成贴花}

2个函数可以生成贴花 <br/>

-   [X] SpawnDecalAtLocation : 在给定世界座标生成贴花 <br/>
    
    | -                  |        |
    |--------------------|--------|
    | WorldContextObject | 世界上下文 |
    | DecalMaterial      | 贴花材质 |
    | DecalSize          | 贴花体积参数 |
    | Location           | 位置   |
    | Rotation           | 方向向量 |
    
    ```cpp
    static UDecalComponent* SpawnDecalAtLocation(const UObject* WorldContextObject, class UMaterialInterface* DecalMaterial, FVector DecalSize, FVector Location, FRotator Rotation = FRotator(-90, 0, 0), float LifeSpan = 0);
    ```
-   [ ] SpawnDecalAttached : 生成贴花后设置上级组件 <br/>

设置隐入隐出 <br/>

-   SetFadeIn : 贴花出现 <br/>
-   SetFadeOut <br/>
    StartDelay参数: 贴花出现后多久开始播放消失动画 <br/>
    DestroyOwnerAfterFade参数: 使用SpawnDecalAttached生成贴花时, 该参数有效; 从上级组件移除贴花 <br/>
    ```cpp
    void UDecalComponent::SetFadeOut(float StartDelay, float Duration, bool DestroyOwnerAfterFade /*= true*/);
    ```

`ShootThemUp: Weapon/Components/STUWeaponFXComponent.cpp` <br/>

```cpp
#include "Kismet/GameplayStatics.h"
#include "Components/DecalComponent.h"

// PlayImpactFX

// decal
auto DecalComponent = UGameplayStatics::SpawnDecalAtLocation(GetWorld(), //
                                                             ImpactData.DecalData.Material, //
                                                             ImpactData.DecalData.Size, //
                                                             Hit.ImpactPoint, //
                                                             Hit.ImpactNormal.Rotation());
if (DecalComponent)
{
    DecalComponent->SetFadeOut(ImpactData.DecalData.LifeTime, ImpactData.DecalData.FadeOutTime);
}
```


## 设置特效数据属性 {#设置特效数据属性}


### 步枪 {#步枪}

默认特效数据 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/rifle-default.png" width="1000" /> <br/> <br/>

映射: 拷贝DecalData属性 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/rifle-map.png" width="1000" /> <br/> <br/>


### 榴弹 {#榴弹}

设置贴花体积参数 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/projectile-default.png" width="400" /> <br/> <br/>


### 效果 {#效果}

<img src="/pic/粒子系统/使用贴花实现弹痕/rifle-bullet.png" width="1000" /> <br/> <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/projectile-bullet.png" width="1000" /> <br/> <br/>


## 设置弹痕消失动画 {#设置弹痕消失动画}

`M_Impact_Decal` <br/>
为Alpha通道添加动画 <br/>
使用 `Utils > DecalLifetimeOpacity` 节点, 该变量存储贴花透明变量, 开始播放贴花隐出动画时, 该变量由1变为0 <br/>
节点输出和纹理的Alpha分量相乘, 作为Opacity的输入 <br/>

<img src="/pic/粒子系统/使用贴花实现弹痕/alpha-animation.png" width="1000" /> <br/> <br/>

