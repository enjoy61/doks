---
title: "自定义行为树服务"
date: 2023-10-31T18:43:41
lastmod: 2023-10-31T18:43:43+08:00
draft: false
weight: 2007
---

## 说明 {#说明}

AI Service / AIDecorator <br/>


## BTService {#btservice}

添加到行为树节点的特殊类. 自带Tick函数, 在其中实现游戏逻辑. <br/>

在给定条件, 可以修改黑板中的变量值. <br/>

本节将通过服务重写定位敌人逻辑, 当敌人出现在NPC的捕捉范围内, 计算得到敌人附近一点, 使NPC跑去该位置. <br/>

可以添加到行为树的任意节点 <br/>


## 添加黑板变量 {#添加黑板变量}

`BB_STUCharacter` <br/>

添加类型为Object的变量, 命名为EnemyActor; 存放选中敌人 <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/add-enemy-actor.png" width="300" /> <br/> <br/>


## 创建行为树服务类 {#创建行为树服务类}

| -  |                     |
|----|---------------------|
|    | AI/Services         |
| 基类 | BTService           |
|    | Public              |
| 名称 | STUFindEnemyService |

每秒搜索距离NPC最近的敌人 <br/>


### 修改头文件搜索路径 {#修改头文件搜索路径}

`ShootThemUp: ShootThemUp.Build.cs` <br/>

```cpp
PublicIncludePaths.AddRange(new string[]
{
    "ShootThemUp/Public/Player",
    "ShootThemUp/Public/Components",
    "ShootThemUp/Public/Dev",
    "ShootThemUp/Public/Weapon",
    "ShootThemUp/Public/UI",
    "ShootThemUp/Public/Animations",
    "ShootThemUp/Public/Pickups",
    "ShootThemUp/Public/Weapon/Components",
    "ShootThemUp/Public/AI",
    "ShootThemUp/Public/AI/Tasks",
    "ShootThemUp/Public/AI/Services"            
});
```


### 添加构造函数 {#添加构造函数}

`public` <br/>
`ShootThemUp: AI/Services/STUFindEnemyService.h` <br/>

```cpp
USTUFindEnemyService();
```

设置服务名称 <br/>
`ShootThemUp: AI/Services/STUFindEnemyService.cpp` <br/>

```cpp
USTUFindEnemyService::USTUFindEnemyService()
{
    NodeName = "Find Enemy";
}
```


### 添加属性: 存放黑板变量信息 {#添加属性-存放黑板变量信息}

`protected` <br/>
`ShootThemUp: AI/Services/STUFindEnemyService.h` <br/>

```cpp
UPROPERTY(EditAnywhere, BlueprintReadWrite)
FBlackboardKeySelector EnemyActorKey;
```


### 添加TickNode函数 {#添加ticknode函数}

可以设置调用频率; 在此定位敌人 <br/>

`protected` <br/>
`ShootThemUp: AI/Services/STUFindEnemyService.h` <br/>

```cpp
virtual void TickNode(UBehaviorTreeComponent &OwnerComp, uint8 *NodeMemory, float DeltaSeconds) override;
```

`ShootThemUp: AI/Services/STUFindEnemyService.cpp` <br/>

```cpp
#include "BehaviorTree/BlackboardComponent.h"
#include "AIController.h"
#include "STUUtils.h"
#include "Components/STUAIPerceptionComponent.h"

void USTUFindEnemyService::TickNode(UBehaviorTreeComponent &OwnerComp, uint8 *NodeMemory, float DeltaSeconds)
{
    const auto Blackboard = OwnerComp.GetBlackboardComponent();
    if (Blackboard)
    {
        const auto Controller = OwnerComp.GetAIOwner();
        const auto PerceptionComponent = STUUtils::GetSTUPlayerComponent<USTUAIPerceptionComponent>(Controller);
        if (PerceptionComponent)
        {
            Blackboard->SetValueAsObject(EnemyActorKey.SelectedKeyName, PerceptionComponent->GetClosestEnemy());
        }
    }
    Super::TickNode(OwnerComp, NodeMemory, DeltaSeconds);
}
```


#### SetValueAsObject函数 {#setvalueasobject函数}

第一个参数: 变量名 <br/>
第二个参数: 给出指向敌人的UObject指针 <br/>


## 在AIController中使用服务 {#在aicontroller中使用服务}


### 添加属性: 存放变量名 {#添加属性-存放变量名}

无法使用选择器, Controller不涉及黑板变量逻辑 <br/>

`ShootThemUp: AI/STUAIController.h` <br/>

```cpp
UPROPERTY(EditAnywhere, BlueprintReadWrite)
FName FocusOnKeyName = "EnemyActor";
```


### 添加接口: 返回敌人对象 {#添加接口-返回敌人对象}

`private` <br/>
`ShootThemUp: AI/STUAIController.h` <br/>

```cpp
AActor *GetFocusOnActor() const;
```

`ShootThemUp: AI/STUAIController.cpp` <br/>

```cpp
#include "BehaviorTree/BlackboardComponent.h"

AActor *ASTUAIController::GetFocusOnActor() const
{
    if (!GetBlackboardComponent()) return nullptr;
    return Cast<AActor>(GetBlackboardComponent()->GetValueAsObject(FocusOnKeyName));
}
```


### 在Tick函数中使用服务 {#在tick函数中使用服务}

不直接使用感知组件接口 <br/>
`ShootThemUp: AI/STUAIController.cpp` <br/>

```cpp
// Tick
const auto AimActor = GetFocusOnActor();
```


## NPC行为树 {#npc行为树}

`BT_STUCharacter` <br/>
NPC有两个职责: <br/>

-   [X] 在地图上巡逻 <br/>
    将序列命名为Random roam <br/>
-   [ ] 攻击 <br/>
    添加节点: Sequence, 命名为Attack <br/>


### 添加节点: Selector {#添加节点-selector}

从左到右运行子树. 若排行较前的子树返回Fail, 则执行下一子树 <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/selector.png" width="600" /> <br/> <br/>


### 为Selector添加服务: 一直查找敌人 {#为selector添加服务-一直查找敌人}

右键 `Selector` , `Add Service > STUFindEnemyService` <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/add-service.png" width="600" /> <br/> <br/>


#### 设置STUFindEnemyService {#设置stufindenemyservice}

| -                            |            | 说明           |
|------------------------------|------------|--------------|
| EnemyActorKey                | EnemyActor |                |
| Service &gt; Interval        |            | Tick调用频率上限F |
| Service &gt; RandomDeviation |            | Tick调用频率活动范围FR |

Tick实际调用频率在F-FR ~ F+FR之间 <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/set-service.png" width="800" /> <br/> <br/>


### 为Attack添加任务: MoveTo {#为attack添加任务-moveto}

Blackboard Key无法选择EnemyActor <br/>


#### 设置黑板变量EnemyActor {#设置黑板变量enemyactor}

`BB_STUCharacter > Enemy Actor > Blackboard Details > Key Type > Base Class` , 设置为Actor : UObject对象在世界中不具有变化属性 <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/enemy-actor-base-class.png" width="800" /> <br/> <br/>


#### 设置MoveTo目的地为EnemyActor; 勾选 `Observe Blackboard Value` {#设置moveto目的地为enemyactor-勾选-observe-blackboard-value}

变量值发生改变时, 新目的地立即生效 <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/attack-move-to.png" width="600" /> <br/> <br/>


### 查看 {#查看}

UE4.27: 当Find Enemy不为空, 且无法找到AimLocation时, 才会执行Attack序列 <br/>

UE5.1: 定时执行Find Enemy, 从左到右执行Attack和Rand roam; Enemy Actor不为空, 靠近选中敌人, 为空, 去到随机生成的位置 <br/>


## 使用Decorator {#使用decorator}

Decorator包含逻辑判断, 类似switch, 可以中断整棵子树 <br/>

根据EnemyActor的设置情况, 决定执行哪个序列 <br/>


### 为Attack添加Decorator: Blackboard {#为attack添加decorator-blackboard}

Blackboard会检查黑板变量的值 <br/>

<img src="/pic/非玩家游戏角色行为/自定义行为树服务/add-decorator.png" width="500" /> <br/> <br/>

-   选中 `Blackboard Based Condition` <br/>
    `Details > Description > Node Name` 命名为 `Has Enemy` <br/>
    
    `Details > Blackboard > Blackboard Key` , 选中EnemyActor <br/>
    
    `Details > Blackboard > Key Query` , 选择IsSet分支 <br/>
    
    `Details > Flow Control > Observer aborts` , 选择Self <br/>
    
    <img src="/pic/非玩家游戏角色行为/自定义行为树服务/set-has-enemy.png" width="600" /> <br/> <br/>
-   若EnemyActor有值, 执行Attack, 否则中止序列 <br/>


### 为Random roam添加Decorator {#为random-roam添加decorator}

-   命名为No Enemy <br/>
    
    `Details > Blackboard > Blackboard Key` , 选中EnemyActor <br/>
    
    `Details > Blackboard > Key Query` , 选择IsNotSet分支 <br/>
    
    `Details > Flow Control > Observer aborts` , 选择Self <br/>
    
    <img src="/pic/非玩家游戏角色行为/自定义行为树服务/set-no-enemy.png" width="600" /> <br/> <br/>
-   若EnemyActor没有值, 执行Random roam, 否则中止序列 <br/>


## 使NPC移动到敌人附近 {#使npc移动到敌人附近}

-   添加标志位: 以自身为圆心寻找随机点 `巡逻` ; 以敌人为圆心寻找随机点 `攻击` <br/>
    `protected` <br/>
    `ShootThemUp: AI/Tasks/STUNextLocationTask.h` <br/>
    ```cpp
    UPROPERTY(EditAnywhere, BlueprintReadWrite)
    bool SelfCenter = true;
    ```
-   添加属性: 如果以敌人为圆心寻找随机点, 保存敌人信息 <br/>
    `protected` <br/>
    `ShootThemUp: AI/Tasks/STUNextLocationTask.h` <br/>
    ```cpp
    UPROPERTY(EditAnywhere, BlueprintReadWrite, meta = (EditCondition = "!SelfCenter"))
    FBlackboardKeySelector CenterActorKey;
    ```
-   设置随机位置中心点 <br/>
    `ShootThemUp: AI/Tasks/STUNextLocationTask.cpp` <br/>
    ```cpp
    // ExecuteTask
    
    auto Location = Pawn->GetActorLocation();
    if (!SelfCenter)
    {
        auto CenterActor = Cast<AActor>(Blackboard->GetValueAsObject(CenterActorKey.SelectedKeyName));
        if (!CenterActor) return EBTNodeResult::Failed;
        Location = CenterActor->GetActorLocation();
    }
    
    const auto Found = NavSys->GetRandomReachablePointInRadius(Location, Radius, NavLocation);
    ```


## 设置Attack序列 {#设置attack序列}

-   添加任务: STUNextLocationTask <br/>
    进行如下设置 <br/>
    
    <img src="/pic/非玩家游戏角色行为/自定义行为树服务/set-attack-nl.png" width="600" /> <br/> <br/>
-   设置MoveTo目的地 <br/>
    
    <img src="/pic/非玩家游戏角色行为/自定义行为树服务/set-attack-move-to.png" width="1000" /> <br/> <br/>

