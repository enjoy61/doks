---
title: "视觉感知"
date: 2023-10-26T20:18:25
lastmod: 2023-10-26T20:19:30+08:00
draft: false
weight: 2006
---

## 说明 {#说明}

AI Perception Component <br/>

允许NPC游戏角色感知给定范围内的世界中的其他Actor, 通过视觉和听觉感知敌人, 对伤害作出反应 <br/>


## 创建C++类 {#创建c-plus-plus-类}

| -  |                          |
|----|--------------------------|
| 基类 | AIPerceptionComponent    |
|    | Components               |
|    | Public                   |
|    | STUAIPerceptionComponent |


## 为AIController添加感知组件 {#为aicontroller添加感知组件}

-   添加构造函数 <br/>
    `ShootThemUp: AI/STUAIController.h`        <br/>
    `public` <br/>
    ```cpp
    ASTUAIController();
    ```

-   添加组件 <br/>
    `ShootThemUp: AI/STUAIController.h` <br/>
    `protected` <br/>
    ```cpp
    class USTUAIPerceptionComponent;
    
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USTUAIPerceptionComponent *STUAIPerceptionComponent;
    ```

-   初始化组件 <br/>
    `ShootThemUp: AI/STUAIController.cpp` <br/>
    ```cpp
    #include "Components/STUAIPerceptionComponent.h"
    
    ASTUAIController::ASTUAIController()
    {
        STUAIPerceptionComponent = CreateDefaultSubobject<USTUAIPerceptionComponent>("STUPerceptionComponent");
        SetPerceptionComponent(*STUAIPerceptionComponent);
    }
    ```


## 设置感知组件 {#设置感知组件}

`BP_STUAIController > STUAIPerceptionComponent > Details` <br/>

`AI Perception > Senses Config` : 对游戏角色的感官进行配置, 可以感知的有伤害, 听觉, 视觉等 <br/>


### 添加AI视觉 {#添加ai视觉}

<img src="/pic/非玩家游戏角色行为/视觉感知/senses-config-add-ele.png" width="1000" /> <br/> <br/>

选择 `AI Sight config` <br/>

<img src="/pic/非玩家游戏角色行为/视觉感知/add-ai-sight-config.png" width="500" /> <br/> <br/>

设置捕捉可视半径为1000 `Sense > Sight Radius` <br/>

设置监控释放半径为1500 `Sense > Lose Sight Radius` <br/>

设置可视半角为60 `Sense > PeripheralVisionHalfAngleDegrees` <br/>

设置调试颜色为蓝色 `Sense > Debug Color` <br/>

`Sense > Detection by Affiliation` , 勾选 `Detect Enemies` , `Detect Neutrals` , `Detect Friendlies` ; 当前没有分队别 <br/>

设置MaxAge为1: Actor从视野中消失多久后不再保存相关信息 <br/>

<img src="/pic/非玩家游戏角色行为/视觉感知/sense.png" width="500" /> <br/> <br/>


### 设置感官优先级 {#设置感官优先级}

可以将 `Sense > DominantSense` 设置为None或 `AISense_Sight` <br/>

<img src="/pic/非玩家游戏角色行为/视觉感知/dominant-sense.png" width="500" /> <br/> <br/>


### 查看 {#查看}

-   关闭行为树 <br/>
    `BP_STUCharactr` <br/>
    
    按下 `Option` , 左键点击箭头 <br/>
    
    <img src="/pic/非玩家游戏角色行为/视觉感知/bt.png" width="600" /> <br/> <br/>

-   在新窗口运行游戏 <br/>
    
    <img src="/pic/非玩家游戏角色行为/视觉感知/pie.png" width="500" /> <br/> <br/>

-   按下 `'` 打开AI调试信息; 在小写键盘按下数字4, 使能 `Perception` 信息 <br/>

-   绿色圆柱体表示捕捉可视边界; 粉色圆柱体表示监控释放边界 <br/>
    
    <img src="/pic/非玩家游戏角色行为/视觉感知/cylinder.png" width="1000" /> <br/> <br/>

-   进入到捕捉可视区域, 游戏角色所处位置出现蓝色调试球体, 表明游戏角色被NPC捕捉到; 绿色可视角 <br/>
    
    <img src="/pic/非玩家游戏角色行为/视觉感知/debug-ball-and-half-angle.png" width="1000" /> <br/> <br/>

-   蓝色调试球体的活动范围由可视角和监控释放边界组成 <br/>
    进入到捕捉可视区域, 被NPC捕捉, 之后只要在活动范围内, 其移动就会被NPC捕捉到 <br/>
    活动范围内, 位于障碍物之后, MaxAge时间后, 蓝色调试球消失 <br/>
    移动到活动范围外, MaxAge时间后, 蓝色调试球消失 <br/>

-   在场景中添加另一个NPC <br/>


## 场景中有多个游戏角色: NPC靠近和他距离最近的游戏角色 {#场景中有多个游戏角色-npc靠近和他距离最近的游戏角色}


### 获取组件 {#获取组件}

GetComponentByClass也是AActor的成员函数: 修改传参类型 <br/>
`STUUtils.h` <br/>

```cpp
static T *GetSTUPlayerComponent(AActor *PlayerPawn)
{
    // ...
}
```

AActor提供成员函数FindComponentByClass <br/>


### 返回最近的Actor {#返回最近的actor}

`ShootThemUp: Components/STUAIPerceptionComponent.h` <br/>
`public` <br/>

```cpp
AActor *GetClosestEnemy() const;
```


#### 获取所有捕捉的Actor {#获取所有捕捉的actor}

```cpp
TArray<AActor*> PercieveActors;
GetCurrentlyPerceivedActors(UAISense_Sight::StaticClass(), PercieveActors);
if (!PercieveActors.Num()) return nullptr;
```


#### 计算最近Actor {#计算最近actor}

```cpp
const auto Controller = Cast<AAIController>(GetOwner());
if (!Controller) return nullptr;

const auto Pawn = Controller->GetPawn();
if (!Pawn) return nullptr;
const auto LocalPos = Pawn->GetActorLocation();

float BestDistance = MAX_FLT;
AActor *BestPawn = nullptr;
for (const auto PercieveActor: PercieveActors)
{
    const auto HealthComponent = STUUtils::GetSTUPlayerComponent<USTUHealthComponent>(PercieveActor);
    if (HealthComponent && !HealthComponent->IsDead()) // TODO: check if enemies or not
    {
        const auto CurrentDistance = (PercieveActor->GetActorLocation() - LocalPos).Size();

        if (CurrentDistance < BestDistance)
        {
            BestDistance = CurrentDistance;
            BestPawn = PercieveActor;
        }
    }
}
```


#### 完整实现 {#完整实现}

`ShootThemUp: Components/STUAIPerceptionComponent.cpp` <br/>

```cpp
#include "AIController.h"
#include "STUUtils.h"
#include "Components/STUHealthComponent.h"
#include "Perception/AISense_Sight.h"

AActor *USTUAIPerceptionComponent::GetClosestEnemy() const
{
    TArray<AActor*> PercieveActors;
    GetCurrentlyPerceivedActors(UAISense_Sight::StaticClass(), PercieveActors);
    if (!PercieveActors.Num()) return nullptr;

    const auto Controller = Cast<AAIController>(GetOwner());
    if (!Controller) return nullptr;

    const auto Pawn = Controller->GetPawn();
    if (!Pawn) return nullptr;
    const auto LocalPos = Pawn->GetActorLocation();

    float BestDistance = MAX_FLT;
    AActor *BestPawn = nullptr;
    for (const auto PercieveActor: PercieveActors)
    {
        const auto HealthComponent = STUUtils::GetSTUPlayerComponent<USTUHealthComponent>(PercieveActor);
        if (HealthComponent && !HealthComponent->IsDead()) // TODO: check if enemies or not                 
        {
            const auto CurrentDistance = (PercieveActor->GetActorLocation() - LocalPos).Size();
            if (CurrentDistance < BestDistance)
            {
                BestDistance = CurrentDistance;
                BestPawn = PercieveActor;
            }
        }
    }
    return BestPawn;
}
```


### 添加Tick函数: 每秒计算一次最近Actor, 旋转NPC朝向被捕捉对象 {#添加tick函数-每秒计算一次最近actor-旋转npc朝向被捕捉对象}

暂时不检查STUAIPerceptionComponent是否有效 <br/>

`ShootThemUp: AI/STUAIController.h` <br/>
`protected` <br/>

```cpp
virtual void Tick(float DeltaTime) override;
```

`ShootThemUp: AI/STUAIController.cpp` <br/>

```cpp
void ASTUAIController::Tick(float DeltaTime)
{
    Super::Tick(DeltaTime);
    const auto AimActor = STUAIPerceptionComponent->GetClosestEnemy();
    SetFocus(AimActor);
}
```


#### SetFocus函数 {#setfocus函数}

设置控制器旋转, 使之前进向量朝向给定Actor <br/>


## 查看 {#查看}

打开AI调试信息, 使能Perception <br/>

在监控释放半径限定的圆内, 除非躲在障碍物之后, 不会脱离NPC捕捉 <br/>

