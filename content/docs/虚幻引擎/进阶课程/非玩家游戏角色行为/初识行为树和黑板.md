---
title: "初识行为树和黑板"
date: 2023-10-19T23:16:00
lastmod: 2023-10-29T14:44:18+08:00
draft: false
weight: 2003
---

## 说明 {#说明}

Behavior Tree / Blackboard <br/>

在控制器对游戏角色行为逻辑进行描述 <br/>

数学建模, 直接 非循环 图表, 可能的行为作为节点 <br/>

虚幻引擎提供行为树编辑器使数学模型可视化 <br/>

行为树是游戏角色的大脑: 设置了一系列的规则, 迁移条件 `Transition` , 和NPC状态 <br/>

黑板作为数据库: 一系列变量, 当我们在代码中将其设置为不同值, 行为树会作出对应反应 <br/>


## 创建行为树资产和黑板资产 {#创建行为树资产和黑板资产}

`Content/AI` <br/>

右键, `Artificial Intelligence > Behavior Tree` , 命名为BT_STUCharacter <br/>

右键, `Artificial Intelligence > Blackboard` , 命名为BB_STUCharacter <br/>


## 介绍行为树资产 {#介绍行为树资产}

双击打开BT_STUCharacter, 对游戏角色行为逻辑进行配置 <br/>

行为树由控制节点组成, 任务作为叶子节点; 任务即游戏角色的直接动作 <br/>

初始只有一个根节点, 作为行为树的入口 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-root.png" width="600" /> <br/> <br/>

第二层有三个选项 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-composites.png" width="600" /> <br/> <br/>

| -               |              |
|-----------------|--------------|
| Sequence        | 按次序执行的多个任务序列 |
| Selector        |              |
| Simple Parallel |              |

第三层可以选任务 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-tasks.png" width="600" /> <br/> <br/>

| -      |                            |
|--------|----------------------------|
| MoveTo | 找到路径去到指定位置; MoveAITo的另一种表示 |
| Wait   | 游戏角色暂停指定秒数       |


### MoveTo任务 {#moveto任务}

在细节面板进行配置 <br/>
`Blackboard > Blackboard Key` : 决定世界座标系的某个位置, 或者游戏角色将要移动到的Actor <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/move-to-bb.png" width="1000" /> <br/> <br/>


## 使用黑板资产 {#使用黑板资产}

通过 `New Key` 按钮添加各种类型变量 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bb-new.png" width="500" /> <br/> <br/>

添加两个 `Vector` 类型变量: Location1和Location2; 将在这两点间移动 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bb-loc2.png" width="200" /> <br/> <br/>


## 配置行为树资产 {#配置行为树资产}

-   点击图表的空白处会显示细节面板, 设置黑板资产 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-bb.png" width="1000" /> <br/> <br/>
-   添加节点: Sequence <br/>
-   添加任务: MoveTo <br/>
    选中 `MoveTo` 节点, 可以在 `Details > Blackboard > Blackboard Key` 看到刚刚添加的变量, 选择Location1作为目的地 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-loc-1.png" width="1000" /> <br/> <br/>
-   添加任务: Wait; 设置秒数为2 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-wait-1.png" width="1000" /> <br/> <br/>
-   添加任务: MoveTo; 选择Location2作为目的地 <br/>
-   添加任务: Wait; 设置秒数为2 <br/>

当前NPC逻辑: &gt; 去到Location1 &gt; 等待2s &gt; 去到Location2 &gt; 等待2s; 循环 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-cycle.png" width="700" /> <br/> <br/>

行为树从上到下、从左到右顺序执行; 左边的优先级更高 <br/>

任务具有执行状态: 是否成功完成; 成功则运行下一个任务, 否则中止 <br/>


## 设置AIController {#设置aicontroller}


### 运行行为树 {#运行行为树}

-   移除BP_STUAIController蓝图中的逻辑 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/remove-move-ai.png" width="400" /> <br/> <br/>

-   添加节点: RunBehaviorTree; 在BeginPlay之后执行; 设置行为树资产 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/add-run-bt.png" width="400" /> <br/> <br/>


### 设置黑板中变量的位置值 {#设置黑板中变量的位置值}

-   在场景另一角添加Actor, 指示Location2 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/actor2.png" width="400" /> <br/> <br/>
-   设置变量值: 对Location1和Location2进行设置 <br/>
    
    添加节点: GetBlackboard; 获取黑板指针 <br/>
    
    添加节点: SetValueAsVector; 对黑板中的变量进行设置 <br/>
    
    添加节点: MakeLiteralName; 给出变量名 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/bt-set-val.png" width="800" /> <br/> <br/>
-   根据两个指示Actor的座标, 填写到Location1和Location2 <br/>
    
    <img src="/pic/非玩家游戏角色行为/初识行为树和黑板/2loc.png" width="800" /> <br/> <br/>


## 查看 {#查看}

保持行为树资产打开, 可以看见行为树逻辑执行的过程 <br/>

按下 `'` 显示调试信息; 按下小写键盘的数字关闭 / 打开AI该类别调试信息 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/debug.png" width="1000" /> <br/> <br/>


### 切换到NPC {#切换到npc}

1.  `Shift-F1` 释放鼠标 <br/>
2.  在世界大纲选中BP_STUAICharacter <br/>
3.  按下 `'` <br/>

`Active Task` : NPC当前执行的任务 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/ai-debug.png" width="1200" /> <br/> <br/>


## 设置AI调试信息相关热键 {#设置ai调试信息相关热键}

`Hotkey` <br/>
显示 / 关闭AI调试窗口 : `Project Settings > Engine > Gameplay Debugger > Input > Activation Key` ; 可以更换为F10 <br/>

显示 / 关闭调试信息: `Project Settings > Engine > Gameplay Debugger > Extensions > ToggleMessages` ; 设置为Ctrl + Z; 原先和切换应用快捷键重复, 因而无法生效 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/cz.png" width="800" /> <br/> <br/>


## 释放鼠标 {#释放鼠标}

当运行模式为视口和新建编辑器窗口时, 可按下F8释放鼠标控制 <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/run-mode.png" width="300" /> <br/> <br/>

<img src="/pic/非玩家游戏角色行为/初识行为树和黑板/f8.png" width="700" /> <br/>        <br/>

