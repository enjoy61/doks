---
title: "清除行为树"
date: 2023-11-03T09:40:16
lastmod: 2023-11-03T11:27:19+08:00
draft: false
weight: 2011
---

## 说明 {#说明}

Behavior Tree Cleanup <br/>

NPC死亡后清除行为树 <br/>


## 验证NPC死亡后, 行为树仍在运行 {#验证npc死亡后-行为树仍在运行}


### 添加调试信息 {#添加调试信息}

-   每次运行寻找敌人服务时, 输出日志 <br/>
    `ShootThemUp: AI/Services/STUFindEnemyService.cpp` <br/>
    ```cpp
    // TickNode
    UE_LOG(LogTemp, Display, TEXT("find enemy"));
    ```
-   游戏角色死亡后输入日志 <br/>
    `ShootThemUp: Components/STUHealthComponent.cpp` <br/>
    ```cpp
    // OnTakeAnyDamage
    UE_LOG(LogTemp, Display, TEXT("character dead"));
    ```


### 设置NPC生命值 {#设置npc生命值}

`BP_STUAICharacter > Health Component > Details > Max Health` <br/>
设置为5 <br/>


### 查看 {#查看}

NPC死亡后, 行为树仍在运行: 直到Character的Destroy函数被调用 <br/>

<img src="/pic/非玩家游戏角色行为/清除行为树/loop.png" width="300" /> <br/> <br/>


## AIController::RunBehaviorTree {#aicontroller-runbehaviortree}

1.  UBehaviorTreeComponent派生自BrainComponent <br/>
2.  调用UBrainComponent::StartTree实现 <br/>


## UBrainComponent::Cleanup {#ubraincomponent-cleanup}

停止行为树运行 <br/>


## 在AICharacter中覆写OnDeath {#在aicharacter中覆写ondeath}


### 修改基类声明 {#修改基类声明}

-   使之为虚函数 <br/>
-   移动到protected <br/>
    派生类可以覆写基类私有函数, 但无法调用基类实现 <br/>

`ShootThemUp: Player/STUBaseCharacter.h` <br/>

```cpp
virtual void OnDeath();
```


### 在派生类覆写 {#在派生类覆写}

`protected` <br/>
`ShootThemUp: AI/STUAICharacter.h` <br/>

```cpp
virtual void OnDeath() override;
```

`ShootThemUp: AI/STUAICharacter.cpp` <br/>

```cpp
#include "BrainComponent.h"

void ASTUAICharacter::OnDeath()
{
    Super::OnDeath();

    const auto STUController = Cast<AAIController>(Controller);
    if (STUController && STUController->BrainComponent)
    {
        STUController->BrainComponent->Cleanup();
    }
}
```


## 查看 {#查看}

-   设置步枪伤害 <br/>
    `BP_STURifleWeapon > Details > Damage Amount` , 设置为10 <br/>

<img src="/pic/非玩家游戏角色行为/清除行为树/cleanup.png" width="300" /> <br/>   <br/>


## 移除日志打印 {#移除日志打印}

`ShootThemUp: AI/Services/STUFindEnemyService.cpp` <br/>

`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
// GetTraceData
```

`ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>

```cpp
// MakeShot
```

