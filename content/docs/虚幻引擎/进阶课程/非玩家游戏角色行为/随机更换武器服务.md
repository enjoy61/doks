---
title: "随机更换武器服务"
date: 2023-11-02T21:48:43
lastmod: 2023-11-02T21:54:18+08:00
draft: false
weight: 2010
---

## 说明 {#说明}

Homework - Change Weapon Service <br/>

-   和弹药耗尽更换武器性质不同; 使用当时实现的NextWeapon接口 <br/>
-   NPC攻击时执行: 加入到Attack序列 <br/>
-   设置参数, 生成随机数大于该值时不作操作 <br/>


## 补充 {#补充}

**应该在TickNode最后调用基类TickNode** <br/>
`ShootThemUp: AI/Services/STUFireService.cpp` <br/>

```cpp
// TickNode

Super::TickNode(OwnerComp, NodeMemory, DeltaSeconds);
```


## 创建服务类 {#创建服务类}

| -  |                        |
|----|------------------------|
| 基类 | BTService              |
| 路径 | AI/Services            |
| 属性 | Public                 |
| 类名 | STUChangeWeaponService |


### 基本函数声明 {#基本函数声明}

`ShootThemUp: AI/Services/STUChangeWeaponService.h` <br/>

```cpp
// public
USTUChangeWeaponService();

// protected
void TickNode(UBehaviorTreeComponent &OwnerComp, uint8 *NodeMemory, float DeltaSeconds);
```


### 构造函数实现: 设置服务名称 {#构造函数实现-设置服务名称}

`ShootThemUp: AI/Services/STUChangeWeaponService.cpp` <br/>

```cpp
USTUChangeWeaponService::USTUChangeWeaponService()
{
    NodeName = "Change Weapon";
}
```


### TickNode框架 {#ticknode框架}

`ShootThemUp: AI/Services/STUChangeWeaponService.cpp` <br/>

```cpp
void USTUChangeWeaponService::TickNode(UBehaviorTreeComponent &OwnerComp, uint8 *NodeMemory, float DeltaSeconds)
{
    // ...

    Super::TickNode(OwnerComp, NodeMemory, DeltaSeconds);
}
```


### 添加属性: 更换武器概率 {#添加属性-更换武器概率}

为0时, 不触发该服务 <br/>

`protected` <br/>
`ShootThemUp: AI/Services/STUChangeWeaponService.h` <br/>

```cpp
UPROPERTY(EditAnywhere, BlueprintReadWrite, meta = (ClampMin = "0.0", ClampMax = "1.0"))
float Probability = 0.5f;
```


### 实现服务逻辑 {#实现服务逻辑}

`ShootThemUp: AI/Services/STUChangeWeaponService.cpp` <br/>

```cpp
#include "AIController.h"
#include "Components/STUWeaponComponent.h"
#include "STUUtils.h"

// TickNode

const auto Controller = OwnerComp.GetAIOwner();
if (Controller)
{
    const auto WeaponComponent = STUUtils::GetSTUPlayerComponent<USTUWeaponComponent>(Controller->GetPawn());
    if (WeaponComponent && Probability > 0 && FMath::FRand() <= Probability)
    {
        WeaponComponent->NextWeapon();
    }
}
```


#### FMath::FRand {#fmath-frand}

返回[0, 1] <br/>


## 测试 {#测试}

-   为Selector添加STUChangeWeaponService <br/>
-   设置Probability = 0.8, Interval = 1 <br/>
    
    <img src="/pic/非玩家游戏角色行为/随机更换武器服务/selector.png" width="1200" /> <br/> <br/>
-   一切正常 <br/>


## 查看 {#查看}

-   将Selector &gt; STUChangeWeaponService拖动到Attack序列, 设置Interval = 3 <br/>
    
    <img src="/pic/非玩家游戏角色行为/随机更换武器服务/attack.png" width="1200" /> <br/> <br/>
-   勾选发射器和步枪的子弹数 `Infinite` 选项 <br/>
    `BP_STURifleWeapon` `BP_STULauncherWeapon` <br/>
    `Details > Default Ammo > Infinite` <br/>
-   NPC捕获敌人时, 正常随机更换武器进行射击; 触发概率不高 <br/>
    可以改善的地方: 事件发生时不一定切换成功, 如动画播放中途, 如正在射击 <br/>

