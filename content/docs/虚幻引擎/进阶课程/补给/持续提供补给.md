---
title: "持续提供补给"
date: 2023-10-11T14:10:57
lastmod: 2023-10-11T14:14:59+08:00
draft: false
weight: 2003
---

## 说明 {#说明}

拾取补给后开启定时器 <br/>


## 实现 {#实现}


### 添加属性: 拾取后, 给定时长后可再次拾取补给 {#添加属性-拾取后-给定时长后可再次拾取补给}

`ShootThemUp: Pickups/STUBasePickup.h` <br/>
`protected` <br/>

```cpp
UPROPERTY(EditAnywhere, BlueprintReadWrite)
float RespawnTime = 5.0f;
```


### 添加函数: 拾取补给后, 关闭碰撞并隐藏补给, 开启定时器; 在定时器中开启碰撞再次显示补给 {#添加函数-拾取补给后-关闭碰撞并隐藏补给-开启定时器-在定时器中开启碰撞再次显示补给}

`ShootThemUp: Pickups/STUBasePickup.h` <br/>
`private` <br/>

```cpp
void PickupWasTaken();
void Respawn();        
```

`ShootThemUp: Pickups/STUBasePickup.cpp` <br/>

```cpp
#include "TimerManager.h"

// BeginPlay
check(CollisionComponent);

// NotifyActorBeginOverlap

// Destroy
PickupWasTaken();

void ASTUBasePickup::PickupWasTaken()
{
    CollisionComponent->SetCollisionResponseToAllChannels(ECollisionResponse::ECR_Ignore);
    if (GetRootComponent())
    {
        GetRootComponent()->SetVisibility(false, true);
    }

    FTimerHandle RespawnTimerHandle;
    GetWorldTimerManager().SetTimer(RespawnTimerHandle, this, &ASTUBasePickup::Respawn, RespawnTime);
}

void ASTUBasePickup::Respawn()
{
    CollisionComponent->SetCollisionResponseToAllChannels(ECollisionResponse::ECR_Overlap);
    if (GetRootComponent())
    {
        GetRootComponent()->SetVisibility(true, true);
    }
}
```


#### 隐藏补给 {#隐藏补给}

`SetVisibility` <br/>
第一个参数决定当前组件是否被渲染; 第二个参数决定其下级组件的渲染设置是否与该组件一致 <br/>


## 查看 {#查看}

运行游戏实例, 按下 `` ` `` 打开终端, 输入 `show collision` <br/>

<img src="/pic/补给/持续提供补给/show-collision.png" width="1000" /> <br/> <br/>

拾取补给后, 碰撞胶囊仍在, 若干秒后补给再次出现, 可反复领取 <br/>

<img src="/pic/补给/持续提供补给/collision-still.png" width="1000" /> <br/> <br/>


## 考虑到补给可能会导致用户数据的修改 {#考虑到补给可能会导致用户数据的修改}

实现接口 `GivePickupTo` <br/>
通过Pawn对象获取组件, 修改用户数据 <br/>
`private` <br/>


### 基类实现 {#基类实现}

返回false <br/>
`ShootThemUp: Pickups/STUBasePickup.h` <br/>

```cpp
virtual bool GivePickupTo(APawn *PlayerPawn);
```

`ShootThemUp: Pickups/STUBasePickup.cpp` <br/>

```cpp
bool ASTUBasePickup::GivePickupTo(APawn *PlayerPawn)
{
    return false;
}
```


#### 发生重叠事件并导致用户数据修改时, 认为补给被拾取 {#发生重叠事件并导致用户数据修改时-认为补给被拾取}

屏蔽日志打印 <br/>
`ShootThemUp: Pickups/STUBasePickup.cpp` <br/>

```cpp
// NotifyActorBeginOverlap

const auto Pawn = Cast<APawn>(OtherActor);
if (GivePickupTo(Pawn))
{
    PickupWasTaken();
}
```


### 生命补给和武器补给的初步实现 {#生命补给和武器补给的初步实现}

`ShootThemUp: Pickups/STUHealthPickup.h` <br/>
`ShootThemUp: Pickups/STUAmmoPickup.h` <br/>

```cpp
virtual bool GivePickupTo(APawn *PlayerPawn) override;
```

`ShootThemUp: Pickups/STUHealthPickup.cpp` <br/>

```cpp
DEFINE_LOG_CATEGORY_STATIC(LogHealthPickup, All, All);

bool ASTUHealthPickup::GivePickupTo(APawn *PlayerPawn)
{
    UE_LOG(LogHealthPickup, Display, TEXT("Health was taken"));
    return true;
}
```

`ShootThemUp: Pickups/STUAmmoPickup.cpp`      <br/>

```cpp
DEFINE_LOG_CATEGORY_STATIC(LogAmmoPickup, All, All);

bool ASTUAmmoPickup::GivePickupTo(APawn *PlayerPawn)
{
    UE_LOG(LogAmmoPickup, Display, TEXT("Ammo was taken"));
    return true;
}
```

