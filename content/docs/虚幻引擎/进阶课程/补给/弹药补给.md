---
title: "弹药补给"
date: 2023-10-11T17:23:42
lastmod: 2023-10-11T17:24:39+08:00
draft: false
weight: 2004
---

## 说明 {#说明}

弹药补给包含2个参数: 武器类型和弹匣数 <br/>


## 弹药补给逻辑 {#弹药补给逻辑}


### 添加属性 {#添加属性}

`ShootThemUp: Pickups/STUAmmoPickup.h` <br/>
`protected` <br/>

```cpp
class ASTUBaseWeapon;

UPROPERTY(EditAnywhere, BlueprintReadWrite, meta = (ClampMin = "1.0", ClampMax = "10.0"))
int32 ClipsAmount = 10;

UPROPERTY(EditAnywhere, BlueprintReadWrite)
TSubclassOf<ASTUBaseWeapon> WeaponType;
```


### 添加接口: 若非死亡跌倒或组件不可寻, 调用武器组件接口 {#添加接口-若非死亡跌倒或组件不可寻-调用武器组件接口}

`ShootThemUp: Pickups/STUAmmoPickup.cpp` <br/>

```cpp
#include "Components/STUHealthComponent.h"
#include "Components/STUWeaponComponent.h"
#include "GameFramework/Pawn.h"
#include "STUUtils.h"

// GivePickupTo

const auto HealthComponent = STUUtils::GetSTUPlayerComponent<USTUHealthComponent>(PlayerPawn);
if (!HealthComponent || HealthComponent->IsDead()) return false;

const auto WeaponComponent = STUUtils::GetSTUPlayerComponent<USTUWeaponComponent>(PlayerPawn);
if (!WeaponComponent) return false;

return WeaponComponent->TryToAddAmmo(WeaponType, ClipsAmount);
```


## 武器组件逻辑 {#武器组件逻辑}

添加接口: 调用对应类型武器接口 <br/>

`ShootThemUp: Components/STUWeaponComponent.h` <br/>
`public` <br/>

```cpp
bool TryToAddAmmo(TSubclassOf<ASTUBaseWeapon> WeaponType, int32 ClipsAmount);
```

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
bool USTUWeaponComponent::TryToAddAmmo(TSubclassOf<ASTUBaseWeapon> WeaponType, int32 ClipsAmount)
{
    for (const auto Weapon : Weapons)
    {
        if (Weapon && Weapon->IsA(WeaponType))
        {
            return Weapon->TryToAddAmmo(ClipsAmount);
        }
    }
    return false;
}
```


## 武器逻辑 {#武器逻辑}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
// public
bool TryToAddAmmo(int32 ClipsAmount);

// protected
bool IsAmmoFull() const;
```

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
bool ASTUBaseWeapon::IsAmmoFull() const
{
    return CurrentAmmo.Clips == DefaultAmmo.Clips && //
        CurrentAmmo.Bullets == DefaultAmmo.Bullets;
}

bool ASTUBaseWeapon::TryToAddAmmo(int32 ClipsAmount)
{
      if (CurrentAmmo.Infinite || IsAmmoFull() || ClipsAmount <= 0) return false;

      if (IsAmmoEmpty())
      {
          UE_LOG(LogBaseWeapon, Display, TEXT("Ammo was empty!"));
          CurrentAmmo.Clips = FMath::Clamp(CurrentAmmo.Clips + ClipsAmount, 0, DefaultAmmo.Clips + 1);
          OnClipEmpty.Broadcast();
      }
      else if (CurrentAmmo.Clips < DefaultAmmo.Clips)
      {
          if (CurrentAmmo.Clips + ClipsAmount <= DefaultAmmo.Clips)
          {
              CurrentAmmo.Clips += ClipsAmount;
              UE_LOG(LogBaseWeapon, Display, TEXT("Clips were added"));
          }
          else
          {
              CurrentAmmo.Clips = DefaultAmmo.Clips;
              CurrentAmmo.Bullets = DefaultAmmo.Bullets;
              UE_LOG(LogBaseWeapon, Display, TEXT("Ammo is full now"));
          }
      }
      else
      {
          CurrentAmmo.Bullets = DefaultAmmo.Bullets;
          UE_LOG(LogBaseWeapon, Display, TEXT("Bullets were added"));
      }
      return true;
}
```


## 查看 {#查看}

-   将榴弹弹匣可以容纳的榴弹数改为2 <br/>
    `BP_STULauncherWeapon` <br/>
    
    <img src="/pic/补给/弹药补给/launcher-default-bullets.png" width="700" /> <br/> <br/>
-   设置弹药补给的武器类型为 `BP_STULauncherWeapon` <br/>
    `BP_STUAmmoPickup` <br/>
    
    <img src="/pic/补给/弹药补给/ammo-pickup-clips.png" width="1000" /> <br/> <br/>

初始状态, 无法拾取弹药补给 <br/>

<img src="/pic/补给/弹药补给/initial.png" width="1000" /> <br/> <br/>

射击一次后, 提示榴弹增加 <br/>

<img src="/pic/补给/弹药补给/bullet-add.png" width="1000" /> <br/> <br/>

打掉一个弹匣后, 提示弹药装满 <br/>

<img src="/pic/补给/弹药补给/ammo-full.png" width="1000" /> <br/> <br/>

打空后, 提示弹药为空 <br/>

<img src="/pic/补给/弹药补给/ammo-empty.png" width="1000" /> <br/> <br/>

**再次打空后, 切换武器, 拾取弹药装备, 切换回发射器, 弹药信息显示不正确** <br/>

<img src="/pic/补给/弹药补给/error.png" width="1000" /> <br/> <br/>


## 解决问题 {#解决问题}

装弹时, 只对当前武器进行操作 <br/>


### 委托定义中, 增加一个传参 {#委托定义中-增加一个传参}

`STUCoreTypes.h` <br/>

```cpp
class ASTUBaseWeapon;

DECLARE_MULTICAST_DELEGATE_OneParam(FOnClipEmptySignature, ASTUBaseWeapon*);
```


#### 修改调用 {#修改调用}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
// DecreaseAmmo
OnClipEmpty.Broadcast(this);

// TryToAddAmmo
OnClipEmpty.Broadcast(this);
```


#### 修改声明和定义 {#修改声明和定义}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
void OnEmptyClip(ASTUBaseWeapon *AmmoEmptyWeapon);
```

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
void USTUWeaponComponent::OnEmptyClip(ASTUBaseWeapon *AmmoEmptyWeapon)
{
    if (!AmmoEmptyWeapon) return;

    if (CurrentWeapon == AmmoEmptyWeapon)
    {
        ChangeClip();
    }
    else
    {
        for (const auto Weapon : Weapons)
        {
            if (Weapon == AmmoEmptyWeapon)
            {
                Weapon->ChangeClip();
            }                   
        }
    }
}
```

