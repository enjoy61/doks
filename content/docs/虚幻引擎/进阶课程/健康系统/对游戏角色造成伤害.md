---
title: "对游戏角色造成伤害"
date: 2023-06-11T05:49:08
lastmod: 2023-08-07T09:42:39+08:00
draft: false
weight: 1002
---

## 概览 {#概览}

`C++` <br/>


### 对游戏角色造成伤害 {#对游戏角色造成伤害}

-   虚幻引擎提供一组函数，用来对Actor造成伤害 <br/>
-   若有注册伤害处理服务, Actor受到伤害时触发处理函数 <br/>
-   本节在Tick函数中持续对游戏角色造成伤害 <br/>


### 伤害处理服务 {#伤害处理服务}

-   我们在Actor提供的数据成员处注册伤害处理函数, 在处理函数中减少游戏角色生命值 <br/>


## 持续对游戏角色造成伤害 {#持续对游戏角色造成伤害}

`C++` <br/>
伤害来源是自己 <br/>
`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
// Tick
TakeDamage(0.1f, FDamageEvent{}, GetController(), this);
```


## 伤害处理服务 {#伤害处理服务}

-   AActor定义了委托类型FTakeAnyDamageSignature，并有该类型数据成员AActor::OnTakeAnyDamage <br/>
-   我们通过数据成员注册伤害处理服务 <br/>
-   处理函数签名 <br/>
    ```cpp
    void handler(AActor* DamagedActor, float Damage, const class UDamageType* DamageType, class AController* InstigatedBy, AActor* DamageCauser);
    ```
-   该委托类型支持蓝图 <br/>
-   触发伤害处理函数时，会传入UDamageType <br/>


## 注册伤害机制的委托服务 {#注册伤害机制的委托服务}

`C++` <br/>


### 搭建框架 {#搭建框架}

1.  添加空函数 <br/>
    `ShootThemUp: Components/STUHealthComponent.cpp` <br/>
    ```cpp
    void USTUHealthComponent::OnTakeAnyDamage(AActor* DamagedActor, float Damage, const class UDamageType* DamageType, class AController* InstigatedBy, AActor* DamageCauser) {}
    ```
2.  注册伤害处理函数 <br/>
    `ShootThemUp: Components/STUHealthComponent.cpp` <br/>
    ```cpp
    #include "GameFramework/Actor.h"
    
    // BeginPlay
    AActor *TheOwner = GetOwner();
    if (TheOwner)
    {
        TheOwner->OnTakeAnyDamage.AddDynamic(this, &USTUHealthComponent::OnTakeAnyDamage);
    }
    ```
3.  添加函数声明 <br/>
    `private` <br/>
    `ShootThemUp: Components/STUHealthComponent.h` <br/>
    ```cpp
    UFUNCTION()
    void OnTakeAnyDamage(AActor* DamagedActor, float Damage, const class UDamageType* DamageType, class AController* InstigatedBy, AActor* DamageCauser);
    ```


### 实现处理函数 {#实现处理函数}

`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

```cpp
// OnTakeAnyDamage
Health -= Damage;
```

差不多一秒10帧，即1s调用十次处理函数；Health减为0之后，继续减少 <br/>

