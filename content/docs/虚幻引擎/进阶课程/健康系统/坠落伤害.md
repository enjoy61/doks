---
title: "坠落伤害"
date: 2023-06-11T05:52:09
lastmod: 2023-08-07T15:51:29+08:00
draft: false
weight: 1008
---

## 说明 {#说明}

1.  `C++` <br/>
2.  落地速度Z方向的分量和坠落高度有关；速度越大，坠落高度越大 <br/>
    ```text
    t = sqrt(2*h/g) = v/g
    ```
3.  跳跃时落地，也符合坠落定义；在一定范围内，坠落无伤害 <br/>


## 坠落机制 {#坠落机制}

1.  Character定义了坠落委托类型FLandedSignature，并有该类型成员ACharacter::LandedDelegate <br/>
2.  委托类型的处理函数签名 <br/>
    ```cpp
    void handler(const FHitResult& Hit);
    ```
    该委托类型支持蓝图 <br/>
3.  Character在ACharacter::Landed通知客户端 <br/>


## 思路 {#思路}

-   我们可以注册LandedDelegate的委托服务，也可以覆写ACharacter::Landed，添加相应处理 <br/>
-   选择注册委托服务 <br/>


## 坠落伤害计算 {#坠落伤害计算}

1.  参数 <br/>
    
    | -      |                             |        |
    |--------|-----------------------------|--------|
    | 坠落伤害范围 | `LandedDamageRange`         | [c, d] |
    | 落地速度范围 | `LandedDamageVelocityRange` | [a, b] |
2.  落地速度和对应的伤害 <br/>
    
    | 速度   | 伤害                                 |
    |------|------------------------------------|
    | &lt; a | 无伤                                 |
    | [a, b] | [c, d]                               |
    |        | c + (Velocity - a) (d - c) / (b - a) |
    | &gt; b | d                                    |
3.  获取Character速度 <br/>
    -   `APawn::GetVelocity` <br/>
    -   `ACharacter:: GetCharacterMovement > UCharacterMovementComponent::Velocity` <br/>


## 添加坠落伤害参数 {#添加坠落伤害参数}

`protected` <br/>
`ShootThemUp: Player/STUBaseCharacter.h` <br/>

```cpp
UPROPERTY(EditDefaultsOnly)
FVector2D LandedDamageVelocityRange = {900.0f, 1200.0f};

UPROPERTY(EditDefaultsOnly)	
FVector2D LandedDamageRange = {10.0f, 100.0f};
```


## 注册坠落伤害的委托服务 {#注册坠落伤害的委托服务}


### 搭建框架 {#搭建框架}

1.  添加空函数 <br/>
    OnLanded函数名已被使用 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    void ASTUBaseCharacter::OnGroundLanded(const FHitResult &Hit) {} 
    ```
2.  注册服务 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    // BeginPlay
    LandedDelegate.AddDynamic(this, &ASTUBaseCharacter::OnGroundLanded);
    ```
3.  函数声明 <br/>
    `private` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    UFUNCTION()
    void OnGroundLanded(const FHitResult& Hit);
    ```


### 实现处理函数 {#实现处理函数}

坠落伤害属于环境伤害，无伤害源(Actor)和阵营(Controller) <br/>

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
void ASTUBaseCharacter::OnGroundLanded(const FHitResult &Hit)
{
    float Velocity = -GetVelocity().Z;
    if (Velocity < LandedDamageVelocityRange.X)
        return;
    float LandedDamage = FMath::GetMappedRangeValueClamped(LandedDamageVelocityRange, LandedDamageRange, Velocity);
    TakeDamage(LandedDamage, FDamageEvent{}, nullptr, nullptr);
}
```

