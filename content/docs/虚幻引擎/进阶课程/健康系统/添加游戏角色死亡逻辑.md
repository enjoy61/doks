---
title: "添加游戏角色死亡逻辑"
date: 2023-06-11T05:51:15
lastmod: 2023-08-07T14:34:57+08:00
draft: false
weight: 1005
---

## 说明 {#说明}


### 生命值修改时, 同步到HealthTextComponent组件 {#生命值修改时-同步到healthtextcomponent组件}


### 生命值为0，销毁游戏角色 {#生命值为0-销毁游戏角色}


### 死亡时, 播放死亡动画 {#死亡时-播放死亡动画}


#### 动画剪辑 {#动画剪辑}

`Animation Montage` <br/>

-   可以将多个动画组合播放。把希望连续播放的动画添加到时间线 `timeline` ，在代码或蓝图中播放动画剪辑 <br/>
-   命名：以AM_打头 <br/>


#### Slot {#slot}

若此时播放动画剪辑，输出输入动画和动画剪辑的拼接；若无动画剪辑在播放，输出输入动画 <br/>


## 添加委托：当生命值更改时，同步到HealthTextComponent文本 {#添加委托-当生命值更改时-同步到healthtextcomponent文本}

`C++` <br/>


### 屏蔽当前HealthTextComponent文本的设置 {#屏蔽当前healthtextcomponent文本的设置}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
屏蔽Tick函数中的文本更新 <br/>


### 初始化HealthTextComponent文本 {#初始化healthtextcomponent文本}

`ShootThemUp: Player/STUBaseCharacter.cpp`       <br/>

```cpp
// BeginPlay
HealthTextComponent->SetText(FText::FromString(FString::Printf(TEXT("%.0f"), HealthComponent->GetHealth())));
```


### HealthComponent提供委托服务: 生命值修改通知 {#healthcomponent提供委托服务-生命值修改通知}

| -    |
|------|
| 多播 |
| 仅C++ |


#### 在HealthComponent定义委托类型FChangeHealthSignature {#在healthcomponent定义委托类型fchangehealthsignature}

`ShootThemUp: Components/STUHealthComponent.h` <br/>

```cpp
DECLARE_MULTICAST_DELEGATE(FChangeHealthSignature);
```


#### 添加数据成员OnChangeHealth，提供委托服务 {#添加数据成员onchangehealth-提供委托服务}

`public` <br/>
`ShootThemUp: Components/STUHealthComponent.h`          <br/>

```cpp
FChangeHealthSignature OnChangeHealth;
```


#### 封装修改Health逻辑，调用时通知客户端 {#封装修改health逻辑-调用时通知客户端}

只能通过SetHealth接口修改生命值 <br/>

1.  函数定义 <br/>
    `ShootThemUp: Components/STUHealthComponent.cpp` <br/>
    ```cpp
    void USTUHealthComponent::SetHealth(float NewHealth)
    {
        Health = NewHealth;
        OnChangeHealth.Broadcast();
    }
    ```
2.  函数声明 <br/>
    `private`           <br/>
    `ShootThemUp: Components/STUHealthComponent.h` <br/>


#### 修改OnTakeAnyDamage {#修改ontakeanydamage}

`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

```cpp
// Health -= Damage;
SetHealth(Health - Damage);
```


### STUBaseCharacter注册委托服务: OnChangeHealth {#stubasecharacter注册委托服务-onchangehealth}

| -    |            |
|------|------------|
| 仅C++ | AddUObject |


#### 搭建框架: 注册生命值修改通知 {#搭建框架-注册生命值修改通知}

1.  添加空函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    void ASTUBaseCharacter::OnChangeHealth() {}
    ```
2.  注册委托服务 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp`           <br/>
    ```cpp
    // BeginPlay
    HealthComponent->OnChangeHealth.AddUObject(this, &ASTUBaseCharacter::OnChangeHealth);
    ```
3.  函数声明 <br/>
    `private` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>


#### 实现处理函数OnChangeHealth {#实现处理函数onchangehealth}

设置HealthTextComponent文本 <br/>
`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
// OnChangeHealth
HealthTextComponent->SetText(FText::FromString(FString::Printf(TEXT("%.0f"), HealthComponent->GetHealth())));
```


### Character和其组件调用BeginPlay的先后顺序 {#character和其组件调用beginplay的先后顺序}

先调用Component的BeginPlay，再调用Character的BeginPlay。 <br/>

先由HealthComponent在BeginPlay初始化Health, 才轮到Character在BeginPlay中注册服务。 <br/>

若我们没有在Character的BeginPlay中初始化HealthTextComponent文本，当Character在BeginPlay中注册服务完成，HealthTextComponent 文本显示为0。直到Health再次被更改，Character才会收到通知同步。 <br/>


## 游戏角色死亡后，生命值不再减少 {#游戏角色死亡后-生命值不再减少}

`C++` <br/>


### 提供接口，判断Character是否死亡 {#提供接口-判断character是否死亡}

`public` <br/>
`ShootThemUp: Components/STUHealthComponent.h` <br/>

```cpp
UFUNCTION(BlueprintCallable)
bool IsDead() const { return Health <= 0.0f; }
```


### Character死亡之后，生命值不再减少 {#character死亡之后-生命值不再减少}

若伤害的数量特征不大于0，或者当前生命值不大于0，无法继续对Character造成伤害 <br/>
`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

```cpp
// OnTakeAnyDamage
if (Damage <= 0.0f || IsDead()) return;
```


### 限制Health范围 {#限制health范围}

`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

```cpp
// Health = NewHealth;
Health = FMath::Clamp(NewHealth, 0.0f, MaxHealth);
```


## 添加委托：游戏角色死亡，销毁Character {#添加委托-游戏角色死亡-销毁character}

`C++` <br/>
当生命值发生改变时修改HealthText文本，当生命值变为0时销毁Character，一码归一码 <br/>


### HealthComponent提供委托服务: 游戏角色死亡通知 {#healthcomponent提供委托服务-游戏角色死亡通知}

| -    |
|------|
| 多播 |
| 仅C++ |


#### 在HealthComponent定义委托类型FDeathSignature {#在healthcomponent定义委托类型fdeathsignature}

`ShootThemUp: Components/STUHealthComponent.h` <br/>

```cpp
DECLARE_MULTICAST_DELEGATE(FDeathSignature);
```


#### 添加数据成员OnDeath，提供委托服务 {#添加数据成员ondeath-提供委托服务}

`public` <br/>
`ShootThemUp: Components/STUHealthComponent.h`          <br/>

```cpp
FDeathSignature OnDeath;         
```


#### Character死亡，通知客户端 {#character死亡-通知客户端}

`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

```cpp
// OnTakeAnyDamage
if (IsDead())
{
    OnDeath.Broadcast();
}
```


### STUBaseCharacter注册委托服务: OnDeath {#stubasecharacter注册委托服务-ondeath}

| -    |            |
|------|------------|
| 仅C++ | AddUObject |


#### 搭建框架: 注册死亡通知 {#搭建框架-注册死亡通知}

1.  添加空函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    void ASTUBaseCharacter::OnDeath() {}     
    ```
2.  注册委托服务 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp`           <br/>
    ```cpp
    // BeginPlay
    HealthComponent->OnDeath.AddUObject(this, &ASTUBaseCharacter::OnDeath);            
    ```
3.  函数声明 <br/>
    `private` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>


#### 实现处理函数OnDeath {#实现处理函数ondeath}

1.  添加销毁延时 <br/>
    `protected` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h`           <br/>
    ```cpp
    UPROPERTY(EditDefaultsOnly, meta = (ClampMin = "0.0", ClampMax = "10.0"))
    float LifeSpanOnDeath = 5.0f;
    ```
2.  检查CharacterMovement组件有效性 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp`           <br/>
    ```cpp
    // BeginPlay
    check(GetCharacterMovement());
    ```
3.  剥夺玩家对游戏角色的控制权，开启定时器销毁Character <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp`           <br/>
    ```cpp
    // OnDeath
    GetCharacterMovement()->DisableMovement();
    SetLifeSpan(LifeSpanOnDeath);
    ```


## 创建死亡动画剪辑 {#创建死亡动画剪辑}

`虚幻编辑器` <br/>
之前的跳跃、跑步、转向动画，均对应状态机中的一个状态。如果游戏角色死亡拥有对应状态，每个状态都可能迁移到死亡状态，光是想想都觉得麻烦 <br/>

使用动画剪辑 `AnimMontage` 资产，当游戏角色死亡时，播放死亡动画剪辑, 通过slot连接当前动画和死亡动画剪辑 <br/>


### 创建AnimMontage资产 {#创建animmontage资产}

| -      |                                                             |
|--------|-------------------------------------------------------------|
| 死亡动画资产 | `ExternalContent/Animation/Animations/TTP_Animations/Death` |

1.  `选中死亡动画资产，右键 > Create > Create AnimMontage > 命名为AM_Death` <br/>
    
    <img src="/pic/健康系统/添加Character死亡逻辑/添加死亡动画/创建AM_Death.png" width="700" /> <br/> <br/>
2.  移动到Content/Player/Animations路径下 <br/>
    
    <img src="/pic/健康系统/添加Character死亡逻辑/添加死亡动画/Animations-AM_Death.png" width="600" /> <br/> <br/>


### 在动画蓝图中添加Slot {#在动画蓝图中添加slot}

`ABP_BaseCharacter > AnimGraph` <br/>


#### 在Locomotion和OutputPose之间添加Slot {#在locomotion和outputpose之间添加slot}

<img src="/pic/健康系统/添加Character死亡逻辑/添加死亡动画/添加slot.png" width="500" /> <br/> <br/>


#### Slot和AM_Death的分组一致 {#slot和am-death的分组一致}

1.  `Slot` <br/>
    
    | -        |                            |
    |----------|----------------------------|
    | SlotName | `DefaultGroup.DefaultSlot` |
    
    <img src="/pic/健康系统/添加Character死亡逻辑/添加死亡动画/slot-Details.png" width="400" /> <br/> <br/>
2.  `AM_Death` <br/>
    
    | -       |                            |
    |---------|----------------------------|
    | Montage | `DefaultGroup.DefaultSlot` |
    
    <img src="/pic/健康系统/添加Character死亡逻辑/添加死亡动画/AM_Death-Montage.png" width="500" /> <br/> <br/>


### 设置动画剪辑 {#设置动画剪辑}

`AM_Death` <br/>
死亡动画结束后，不再播放其他动画 <br/>
`Asset Details > BlendOptions > EnableAutoBlendOut，取消勾选` <br/>

<img src="/pic/健康系统/添加Character死亡逻辑/添加死亡动画/AM_Death-EnableAutoBlendOut-Disable.png" width="400" /> <br/> <br/>


## 游戏角色死亡时，播放动画剪辑 {#游戏角色死亡时-播放动画剪辑}

`C++` <br/>

|                    | C++类型      |
|--------------------|------------|
| 动画剪辑 `AnimMontage` | UAnimMontage |


### 添加UAnimMontage类型数据成员 {#添加uanimmontage类型数据成员}

`protected` <br/>
`ShootThemUp: Player/STUBaseCharacter.h` <br/>

```cpp
UPROPERTY(EditDefaultsOnly)
UAnimMontage *DeathAnimMontage;
```


### Character死亡时，播放动画剪辑 {#character死亡时-播放动画剪辑}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
// OnDeath
PlayAnimMontage(DeathAnimMontage);
```


## 查看 {#查看}

`虚幻编辑器` <br/>

1.  设置游戏角色死亡时播放的动画剪辑 <br/>
    `BP_STUBaseCharacter` <br/>
    
    <img src="/pic/健康系统/添加Character死亡逻辑/查看死亡动画/BP_STUBaseCharacter-DeathAnimMontage设置.png" width="1200" /> <br/> <br/>
2.  效果图 <br/>
    
    <img src="/pic/健康系统/添加Character死亡逻辑/查看死亡动画/效果图.png" width="800" /> <br/> <br/>
    
    禁止移动Character之后，销毁Character之前，仍可以移动Camera；即，水平旋转视角时可以旋转Character <br/>

