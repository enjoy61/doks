---
title: "模拟榴弹爆炸"
date: 2023-06-11T05:50:27
lastmod: 2023-08-07T09:42:28+08:00
draft: false
weight: 1003
---

## 建模 {#建模}

-   添加伤害源，派生自Actor，模拟榴弹爆炸瞬间 <br/>
-   绘制球体，使得伤害范围可视化 <br/>
-   对处在爆炸半径内的游戏角色持续造成伤害，伤害数值与游戏角色所在位置到球心的距离有关 <br/>


## 创建伤害源 {#创建伤害源}


### 创建Dev/STUDevDamageActor {#创建dev-studevdamageactor}

`虚幻编辑器` <br/>

-   `Actor` <br/>
-   `公有类` <br/>
    
    <img src="/pic/健康系统/模拟榴弹爆炸/创建STUDevDamageActor/创建STUDevDamageActor.png" width="800" /> <br/> <br/>


### 设置头文件搜索路径 {#设置头文件搜索路径}

`C++` <br/>
`ShootThemUp: ShootThemUp.Build.cs` <br/>

```csharp
PublicIncludePaths.AddRange(new string[] { "ShootThemUp/Public/Player", "ShootThemUp/Public/Components", "ShootThemUp/Public/Dev" });        
```


### 添加可视化组件，使得伤害源可变换 {#添加可视化组件-使得伤害源可变换}

1.  添加SceneComponent <br/>
    `protected` <br/>
    `ShootThemUp: Dev/STUDevDamageActor.h` <br/>
    ```cpp
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USceneComponent *SceneComponent;
    ```
2.  初始化组件 <br/>
    `ShootThemUp: Dev/STUDevDamageActor.cpp` <br/>
    ```cpp
    // 构造函数
    SceneComponent = CreateDefaultSubobject<USceneComponent>("SceneComponent");
    SetRootComponent(SceneComponent);
    ```


### 绘制球体，使得爆炸范围可视化 {#绘制球体-使得爆炸范围可视化}

1.  添加球体参数 <br/>
    `protected` <br/>
    `ShootThemUp: Dev/STUDevDamageActor.h` <br/>
    
    |    | -           |
    |----|-------------|
    | 颜色 | SphereColor |
    | 半径 | Radius      |
    
    ```cpp
    UPROPERTY(EditAnywhere)
    float Radius = 300.0f;
    
    UPROPERTY(EditAnywhere)
    FColor SphereColor = FColor::Red;
    ```
2.  每帧绘制球体 <br/>
    `ShootThemUp: Dev/STUDevDamageActor.cpp` <br/>
    ```cpp
    #include "DrawDebugHelpers.h"
    
    // Tick
    DrawDebugSphere(GetWorld(),
                    GetActorLocation(),
                    Radius,
                    24,
                    SphereColor);
    ```
    使用了GetWorld，其声明和UWorld的定义在一处，而DrawDebugSphere的第一个参数类型为UWorld，不用包含Engine/World.h <br/>


### 对伤害范围内Actor造成半径伤害 {#对伤害范围内actor造成半径伤害}

1.  添加半径伤害参数 <br/>
    `protected` <br/>
    `ShootThemUp: Dev/STUDevDamageActor.h` <br/>
    
    | -            |                                                     |
    |--------------|-----------------------------------------------------|
    | Damage       | 伤害数值特征                                        |
    | DoFullDamage | 半径伤害计算选项：为true，受到的伤害与到球心的距离有关；为false，使用简化模型，受到伤害值恒定 |
    
    ```cpp
    UPROPERTY(EditAnywhere)
    float Damage = 10.0f;
    
    UPROPERTY(EditAnywhere)
    bool DoFullDamage = false;
    ```
2.  对伤害范围内Actor造成半径伤害 <br/>
    `ShootThemUp: Dev/STUDevDamageActor.cpp` <br/>
    ```cpp
    #include "Engine/World.h"
    #include "Kismet/GameplayStatics.h"
    
    // Tick
    UGameplayStatics::ApplyRadialDamage(GetWorld(),
                                        Damage,
                                        GetActorLocation(),
                                        Radius,
                                        nullptr,
                                        {},
                                        this,
                                        nullptr,
                                        DoFullDamage);
    ```
    `ApplyRadialDamage` 的第一个参数类型为 `UObject` ，此时传入 `UWorld` ，需包含 `UWorld` 头文件 <br/>


## 验证半径伤害数值 {#验证半径伤害数值}

`C++` <br/>
定义日志宏，输出伤害值 <br/>
`ShootThemUp: Components/STUHealthComponent.cpp`         <br/>

```cpp
DEFINE_LOG_CATEGORY_STATIC(LogHealthComponent, All, All);

// OnTakeAnyDamage
UE_LOG(LogHealthComponent, Display, TEXT("Damage: %.0f"), Damage);
```


## 屏蔽STUBaseCharacter&gt;Tick中调用TakeDamage {#屏蔽stubasecharacter-tick中调用takedamage}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>


## 在关卡中添加伤害源 {#在关卡中添加伤害源}

`虚幻编辑器` <br/>


### 调整BP_STUBaseCharacter&gt;CameraComponent位置 {#调整bp-stubasecharacter-cameracomponent位置}

向上，向后 <br/>

<img src="/pic/健康系统/模拟榴弹爆炸/在关卡中添加STUDevDamageActor/调整Camera.png" width="1000" /> <br/> <br/>


### 在关卡中添加STDevDamageActor {#在关卡中添加stdevdamageactor}

1.  第一个伤害源: 使用默认设置，根据游戏角色到球心的距离计算伤害 <br/>
    
    <img src="/pic/健康系统/模拟榴弹爆炸/查看半径伤害效果/DamageSphere-Red.png" width="300" /> <br/> <br/>
2.  第二个伤害源: 设置半径和颜色，处在伤害范围内受到伤害数值恒定（开销小） <br/>
    
    <img src="/pic/健康系统/模拟榴弹爆炸/查看半径伤害效果/DamageSphere-Blue.png" width="300" /> <br/> <br/>
3.  调整 `STDevDamageActor` 的位置，效果图 <br/>
    
    <img src="/pic/健康系统/模拟榴弹爆炸/在关卡中添加STUDevDamageActor/效果图.png" width="700" /> <br/> <br/>
    
    要求伤害源球心无阻隔 <br/>


### 验证 DoFullDamage {#验证-dofulldamage}

1.  处于蓝色球内，伤害值一致 <br/>
    
    <img src="/pic/健康系统/模拟榴弹爆炸/查看半径伤害效果/Blue日志.png" width="900" /> <br/> <br/>
2.  处于红色球内，离球心越近，伤害值越大 <br/>
    
    <img src="/pic/健康系统/模拟榴弹爆炸/查看半径伤害效果/Red日志.png" width="900" /> <br/> <br/>
    
    球心在空中，跳跃也会缩短到球心的距离 <br/>


### 伤害球内的所有Actor都会受到伤害 {#伤害球内的所有actor都会受到伤害}

<img src="/pic/健康系统/模拟榴弹爆炸/查看半径伤害效果/伤害球内所有Actor均受到伤害.png" width="700" /> <br/> <br/>

