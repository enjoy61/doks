---
title: "实现游戏角色跳跃"
date: 2023-06-11T06:17:39
lastmod: 2023-08-06T13:56:17+08:00
draft: false
weight: 1008
---

## 概览 {#概览}


### 状态机 {#状态机}

`State Machine` <br/>

-   定义多个状态，每个状态对应一个动画 <br/>
-   在一个动画蓝图中管理多个状态，并定义状态之间的迁移条件 <br/>


### ACharacter::IsFalling {#acharacter-isfalling}

-   当Character在空中时返回true，Character落地时返回false <br/>


## 绑定跳跃键位 {#绑定跳跃键位}

`虚幻编辑器` <br/>
`项目设置 > Engine > Input` <br/>
`动作映射` <br/>

| 函数描述 | 键位     |
|------|--------|
| Jump | SpaceBar |

<img src="/pic/角色和动画/实现Character跳跃/绑定跳跃键位/跳跃键位.png" width="500" /> <br/> <br/>


## 实现跳跃逻辑 {#实现跳跃逻辑}

`C++` <br/>

| -          | 回调函数签名   |
|------------|----------|
| BindAction | void handler() |

| 函数描述 | 回调函数 |                   |
|------|------|-------------------|
| Jump | Jump | 回调函数由虚幻引擎提供，按下时触发 |


### 绑定函数描述和回调函数 {#绑定函数描述和回调函数}

`ShootThemUp: Player/STUBaseCharacter.cpp`       <br/>

```cpp
// SetupPlayerInputComponent
PlayerInputComponent->BindAction("Jump", IE_Pressed, this, &ASTUBaseCharacter::Jump);
```


## 使用状态机实现跳跃动画 {#使用状态机实现跳跃动画}

`虚幻编辑器`  <br/>


### 实现跳跃动画 {#实现跳跃动画}

`ABP_BaseCharacter` <br/>


#### 添加状态机, 将其作为OutPose的输入 {#添加状态机-将其作为outpose的输入}

`AnimGraph` <br/>

1.  添加 `状态机` ，命名为 `Locomotion` <br/>
    
    <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-StateMachine.png" width="400" /> <br/> <br/>
    
    <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Locomotion.png" width="120" /> <br/> <br/>
2.  将 `Locomotion` 作为 `OutputPose` 的输入 <br/>
    
    <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph.png" width="500" /> <br/> <br/>


#### 状态机说明 {#状态机说明}

<!--list-separator-->

-  跳跃动画资产

    | -         |     |
    |-----------|-----|
    | JumpStart | 跳起 |
    | JumpLoop  | 在空中 |
    | JumpEnd   | 落地 |

<!--list-separator-->

-  状态

    | -         |
    |-----------|
    | Walk      |
    | JumpStart |
    | JumpLoop  |
    | JumpEnd   |

<!--list-separator-->

-  状态迁移

    | -                       |                  |
    |-------------------------|------------------|
    | Walk &gt; JumpStart     | 游戏角色在空中   |
    | JumpStart &gt; JumpLoop | JumpStart 动画播放结束 |
    | JumpLoop &gt; JumpEnd   | 游戏角色落地     |
    | JumpEnd &gt; Walk       | JumpEnd 动画播放结束 |


#### 实现状态机 {#实现状态机}

<!--list-separator-->

-  双击Locomotion，进入状态机

    <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Default.png" width="500" /> <br/> <br/>
    
    仅一个入口 `Entry` <br/>

<!--list-separator-->

-  移植Walk状态

    1.  为 `Locomotion` 添加 `State` ，命名为 `Walk` ，使 `Entry` 指向 <br/>
        
        <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Entry-AddState.png" width="300" /> <br/> <br/>
        
        <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Entry-Walk.png" width="200" /> <br/> <br/>
    2.  双击 `Walk` <br/>
        
        <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Walk.png" width="150" /> <br/> <br/>
    3.  将OutputPose之前的输入， `Velocity + BS_Locomotion_Walk_1D` 封装到 `Walk` 状态（剪切）， 作为其 OutputAnimationPose 的输入 <br/>
        
        <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Walk-BS_Locomotion_Walk_1D.png" width="600" /> <br/> <br/>
        
        至此， `Character` 的运动动画和上一小节一致 <br/>

<!--list-separator-->

-  实现跳跃状态

    <!--list-separator-->
    
    -  添加布尔型变量IsFalling
    
        上一小节中，变量 `Velocity` 横跨 `ABP_BaseCharacter` 的 `EventGraph` 和 `AnimGraph` ，这里，布尔类型变量 `IsFalling` 也一样 <br/>
        
        在 `EventGraph` 设置变量值，在 `AnimGraph` 中使用变量 <br/>
    
    <!--list-separator-->
    
    -  使用ACharacter::IsFalling设置变量IsFalling
    
        `EventGraph` <br/>
        
        <!--list-separator-->
        
        -  将Pawn转换为Character
        
            1.  接着设置Velocity, 将Pawn转换为Character <br/>
                不能同时从 `EventBlueprintUpdateAnimation` 出发， `SetVelocity` 之后，执行转换 <br/>
            2.  双击 `TryGetPawnOwner` 和 `CastToCharacter` 连线上的一点，创建Bezier曲线，排线更易整理 <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-将Pawn转换成Character.png" width="800" /> <br/> <br/>
        
        <!--list-separator-->
        
        -  对ACharacter::CharacterMovement调用ACharacter::IsFalling
        
            1.  接着CastToCharacter, 设置IsFalling <br/>
            2.  从 `CaseToCharacter > AsCharacter` 到 `IsFalling > Target` ，自动添加提取数据成员; `IsFalling` 函数的返回类型是布尔，作为 `SetIsFalling` 的输入 <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-设置变量IsFalling.png" width="900" /> <br/> <br/>
        
        <!--list-separator-->
        
        -  完整EventGraph
        
            <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-EventGraph.png" width="800" /> <br/>          <br/>
    
    <!--list-separator-->
    
    -  实现状态机
    
        1.  回到 `Locomotion` <br/>
        2.  从 `AssetBrowser` 把 `Jump` 的三个动画拖入 `Locomotion` <br/>
            动画自动被封装为 `State` ，和之前 `AddState` ，再将动画作为状态输入达到的效果一样 <br/>
            
            <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Locomotion-添加Jump.png" width="900" /> <br/> <br/>
        3.  添加状态迁移路径 <br/>
            
            <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Locomotion-添加转换.png" width="700" /> <br/> <br/>
        4.  添加状态迁移条件 <br/>
            
            | 状态迁移                | 触发条件         |                              |
            |---------------------|--------------|------------------------------|
            | Walk &gt; JumpStart     | 游戏角色在空中   | ACharacter::IsFalling 返回true |
            | JumpStart &gt; JumpLoop | JumpStart 动画播放结束 | TimeRemaining &lt; 0.1       |
            | JumpLoop &gt; JumpEnd   | 游戏角色落地     | ACharacter::IsFalling 返回true |
            | JumpEnd &gt; Walk       | JumpEnd 动画播放结束 | TimeRemaining &lt; 0.1       |
            
            -   双击转换图标，即可为状态迁移添加迁移条件 <br/>
                拿 `Walk > JumpStart` 举例 <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Locomotion-双击转换图标.png" width="350" /> <br/> <br/>
            -   `Walk > JumpStart` 迁移条件：变量 `IsFalling` 为 `true` <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Walk-JumpStart.png" width="800" /> <br/> <br/>
            -   `JumpStart > JumpLoop` 迁移条件： `JumpStart` 动画将近结束 <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Less.png" width="350" /> <br/> <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-JumpStart-JumpLoop.png" width="800" /> <br/> <br/>
            -   `JumpLoop > JumpEnd` 迁移条件：变量 `IsFalling` 为 `false` <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Not.png" width="350" /> <br/> <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-JumpLoop-JumpEnd.png" width="800" /> <br/> <br/>
            -   `JumpEnd > Walk` 迁移条件： `JumpEnd` 将近结束 <br/>
                
                <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-JumpEnd-Walk.png" width="800" /> <br/> <br/>
        5.  设置 `State` 输入动画是否循环播放 <br/>
            
            |                       | -    |
            |-----------------------|------|
            | BS_Locomotion_Walk_1D | 循环播放 |
            | JumpStart             | 播放一次 |
            | JumpLoop              | 循环播放 |
            | JumpEnd               | 播放一次 |
            
            拿 `JumpStart` 状态举例: `选中JumpStart动画 > Details > Settings > LoopAnimation 为true` <br/>
            
            <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/ABP_BaseCharacter-AnimGraph-Locomotion-JumpStart.png" width="1000" /> <br/> <br/>
            
            如此设置还可修复Character跳跃时的卡顿 <br/>


### 添加楼梯，查看Jump三阶段是否正常显示 {#添加楼梯-查看jump三阶段是否正常显示}

1.  添加楼梯 <br/>
    `PlaceActors > Geometry > LinearStair` <br/>
    
    <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/LevelEditor-添加楼梯.png" width="200" /> <br/> <br/>
2.  设置阶数 <br/>
    `选中LinearStairBrush > Details > BrushSettings > NumSteps` <br/>
    
    <img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/LevelEditor-Details-设置楼梯阶数.png" width="300" /> <br/> <br/>
3.  将楼梯移动到合适位置 <br/>
4.  游戏角色从楼梯跳到平面时，循环 `JumpLoop` <br/>
5.  跑步时跳跃，落地后会平滑一段距离 <br/>


## 跳跃时Z方向速度 {#跳跃时z方向速度}

`BP_STUBaseCharacter` <br/>

JumpZVelocity不宜过大, 不然 `JumpStart` 动画播放结束，速度却未减为0，此时Character还在上升，却在播放 `JumpLoop` <br/>

| -          |           |                          |
|------------|-----------|--------------------------|
| Vz &gt; 0  | JumpStart | 该过程应 近似 `JumpStart` 播放时长 |
| Vz &lt;= 0 | JumpLoop  | 从临界点落下             |
| Vz = 0     | JumpEnd   |                          |

<img src="/pic/角色和动画/实现Character跳跃/添加跳跃动画/BP_STUBaseCharacter-CharacterMovement-Details-JumpZVelocity.png" width="1200" /> <br/> <br/>

