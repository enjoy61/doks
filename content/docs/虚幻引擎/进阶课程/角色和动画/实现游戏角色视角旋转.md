---
title: "实现游戏角色视角旋转"
date: 2023-06-11T06:17:23
lastmod: 2023-08-05T23:33:19+08:00
draft: false
weight: 1006
---

## 说明 {#说明}

| 视角旋转 |      |             |                |
|------|------|-------------|----------------|
| 垂直方向 | 抬头低头 | Camera绕Y轴旋转 | 鼠标垂直方向位移决定旋转角度 |
| 水平方向 | 环顾左右 | Camera绕Z轴旋转 | 鼠标水平方向位移决定旋转角度 |


## 绑定旋转键位 {#绑定旋转键位}

`虚幻编辑器` <br/>
`项目设置 > Engine > Input` <br/>
`轴映射` <br/>

| 函数描述   | 键位   |
|--------|------|
| LookUp     | MouseY |
| TurnAround | MouseX |

<img src="/pic/角色和动画/实现Character视角旋转/绑定Camera旋转的鼠标键位/鼠标键位.png" width="400" /> <br/> <br/>


## 实现视角旋转逻辑 {#实现视角旋转逻辑}

`C++` <br/>

| -        | 回调函数签名               |
|----------|----------------------|
| BindAxis | void handler(float Amount) |

| 函数描述   | 回调函数   |                         |                       |
|--------|--------|-------------------------|-----------------------|
| LookUp     | LookUp     | AddControllerPitchInput | 绕Y轴旋转，增加Y轴旋转角度(Pitch) |
| TurnAround | TurnAround | AddControllerYawInput   | 绕Z轴旋转，增加Z轴旋转角度(Yaw) |


### 搭建框架 {#搭建框架}

1.  添加空函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    void ASTUBaseCharacter::LookUp(float Amount) {}
    void ASTUBaseCharacter::TurnAround(float Amount) {}
    ```
2.  绑定函数描述和回调函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    // SetupPlayerInputComponent
    PlayerInputComponent->BindAxis("LookUp", this, &ASTUBaseCharacter::LookUp);
    PlayerInputComponent->BindAxis("TurnAround", this, &ASTUBaseCharacter::TurnAround);
    ```
3.  添加函数声明 <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    -   `private` <br/>


### 添加静态日志类型 {#添加静态日志类型}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
DEFINE_LOG_CATEGORY_STATIC(LogBaseCharacter, All, All);
```


### 实现回调函数 {#实现回调函数}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
void ASTUBaseCharacter::LookUp(float Amount)
{
    AddControllerPitchInput(Amount);
    UE_LOG(LogBaseCharacter, Log, TEXT("LookUp Amount: %f"), Amount);
}

void ASTUBaseCharacter::TurnAround(float Amount)
{
    AddControllerYawInput(Amount);
}
```


### 编译ShootThemUp并运行 {#编译shootthemup并运行}

-   视角可以在水平方向旋转, 身体跟随旋转 <br/>
-   无法在垂直方向旋转 <br/>
-   查看日志，鼠标向上移动时，Amount为正数 <br/>
    
    <img src="/pic/角色和动画/实现Character视角旋转/调整Camera垂直方向上旋转/MouseY-Up.png" width="300" /> <br/> <br/>


## 使视角可以在垂直方向旋转 {#使视角可以在垂直方向旋转}

`虚幻编辑器` <br/>


### CameraComponent的UsePawnControlRotation选项 {#cameracomponent的usepawncontrolrotation选项}

设置CamerComponent是否跟随Pawn旋转 <br/>

1.  勾选 `BP_STUBaseCharacter > CameraComponent > UsePawnControlRotation` <br/>
    `选中Camera Component > 细节面板 > CameraOptions > 勾选UsePawnControlRotation` <br/>
    
    <img src="/pic/角色和动画/实现Character视角旋转/调整Camera垂直方向上旋转/BP_STUBaseCharacter-UsePawnControlRotation-Enable.png" width="1400" /> <br/> <br/>
2.  编译并运行 <br/>
    -   向下移动鼠标，Camera向上旋转; 向上移动鼠标，Camera向下旋转 <br/>
    -   旋转中心点为CameraComponent <br/>


### PlayerController的InputPitchScale选项 {#playercontroller的inputpitchscale选项}

-   游戏角色旋转的逻辑是通过旋转PlayerController完成的 <br/>
-   游戏角色视角垂直方向旋转反向InputPitchScale有关，该参数默认为负数, 已退化 <br/>
    [参考](https://docs.unrealengine.com/5.1/en-US/BlueprintAPI/PlayerController/GetDeprecatedInputPitchScale/) <br/>
-   InputPitchScale, InputYawScale, InputRollScale的绝对值对应旋转速度 <br/>
-   引擎版本 `5.1` 之前，可以在 `PlayerController蓝图类` 的细节面板查看 `InputPitchScale` <br/>


#### 打印InputPitchScale {#打印inputpitchscale}

<img src="/pic/角色和动画/实现Character视角旋转/调整Camera垂直方向上旋转/BP_STUPlayerController-打印InputScale.png" width="700" /> <br/> <br/>

<img src="/pic/角色和动画/实现Character视角旋转/调整Camera垂直方向上旋转/BP_STUPlayerController-打印InputScale-Output.png" width="150" /> <br/> <br/>


#### 解决方法一: 将InputPitchScale设为正数 {#解决方法一-将inputpitchscale设为正数}

<img src="/pic/角色和动画/实现Character视角旋转/调整Camera垂直方向上旋转/BP_STUPlayerController-设置InputPitchScale.png" width="400" /> <br/> <br/>


#### 解决方法二: 将LookUp的Scale改为-1 {#解决方法二-将lookup的scale改为-1}

<img src="/pic/角色和动画/实现Character视角旋转/调整Camera垂直方向上旋转/将LookUp的Scale改为-1.png" width="400" /> <br/> <br/>


#### 善后 {#善后}

1.  采用解决方法二 <br/>
2.  去除 `BP_STUPlayerController` 中的打印和InputPitchScale设置 <br/>
3.  去除 C++ `LookUp` 中的日志打印 <br/>


## 游戏角色视角绕Z轴旋转时，使中心点为游戏角色 {#游戏角色视角绕z轴旋转时-使中心点为游戏角色}


### 为STUBaseCharacter添加USpringArmComponent类型成员 {#为stubasecharacter添加uspringarmcomponent类型成员}

`C++` <br/>

1.  添加SpringArmComponent类型成员 <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    // 前向声明
    class USpringArmComponent;
    
    // protected
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USpringArmComponent *SpringArmComponent;
    ```
2.  初始化组件, 设置SpringArmComponent默认跟随Pawn旋转 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "GameFrameWork/SpringArmComponent.h"
    
    // 默认构造函数
    SpringArmComponent = CreateDefaultSubobject<USpringArmComponent>("SpringArmComponent");
    SpringArmComponent->SetupAttachment(GetRootComponent());
    SpringArmComponent->bUsePawnControlRotation = true;
    ```
3.  修改CameraComponent的上级组件为SpringArmComponent <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    // 默认构造函数
    // CameraComponent->SetupAttachment(GetRootComponent());
    CameraComponent->SetupAttachment(SpringArmComponent);
    ```
4.  编译ShootThemUp <br/>


### 配置SpringArmComponent {#配置springarmcomponent}

`虚幻编辑器` <br/>
`BP_STUBaseCharacter` <br/>


#### 查看SpringArmComponent和CameraComponent {#查看springarmcomponent和cameracomponent}

<img src="/pic/角色和动画/实现Character视角旋转/调整SpringArm和Camera/BP_STUBaseCharacter-Component.png" width="300" /> <br/> <br/>


#### 关于bUsePawnControlRotation设置 {#关于busepawncontrolrotation设置}

1.  `UCameraComponent` 和 `USpringArmComponent` 均有该数据成员 <br/>
2.  在代码中设置 `bUsePawnControlRotation` ，设置的是类数据成员初始值。在蓝图编辑器中，对基于C++类的蓝图类数据成员恢复默认值，得到类数据成员初始值 <br/>
3.  为参数添加默认值，不会改变参数已有值 <br/>


#### 清除CameraComponent的相对变换，置UsePawnControlRotation为false {#清除cameracomponent的相对变换-置usepawncontrolrotation为false}

<img src="/pic/角色和动画/实现Character视角旋转/调整SpringArm和Camera/BP_STUBaseCharacter-Camera-Transform.png" width="1300" /> <br/> <br/>

<img src="/pic/角色和动画/实现Character视角旋转/调整SpringArm和Camera/BP_STUBaseCharacter-Camera-Transform-Reset.png" width="1300" /> <br/>     <br/>


#### 设置SpringArmComponent和CameraComponent的相对变换 {#设置springarmcomponent和cameracomponent的相对变换}

1.  查看 `SpringArmComponent` 臂长参数 <br/>
    
    <img src="/pic/角色和动画/实现Character视角旋转/调整SpringArm和Camera/BP_STUBaseCharacter-SpringArm-TargetArmLength.png" width="1300" /> <br/> <br/>
2.  设置CameraComponent相对SpringArmComponent的偏移 <br/>
    
    <img src="/pic/角色和动画/实现Character视角旋转/调整SpringArm和Camera/BP_STUBaseCharacter-SpringArm-SocketOffset.png" width="1300" /> <br/> <br/>


#### CameraComponent和SpringArmComponent的bUsePawnControlRotation生效问题 {#cameracomponent和springarmcomponent的busepawncontrolrotation生效问题}

| -                             |                                           |
|-------------------------------|-------------------------------------------|
| 二者均为 `true`               | SpringArmComponent的生效，Camera以游戏角色为中心绕Y轴旋转 |
| 二者均为 `false`              | Camera不可绕Y轴旋转                       |
| 仅 `CameraComponent` 的为true | 以Camera为中心绕Y轴旋转                   |
| 仅 `SpringArmComponent` 的为true | Camera以游戏角色为中心绕Y轴旋转           |


## 为Character绑定动画 {#为character绑定动画}

`虚幻编辑器` <br/>
`BP_STUBaseCharacter` <br/>

1.  绑定动画 <br/>
    `选中Mesh组件 > Details > Animation` <br/>
    
    | -              |                     |
    |----------------|---------------------|
    | Animation Mode | Use Animation Asset |
    | Anim To Play   | Run_Fwd             |
    
    <img src="/pic/角色和动画/实现Character视角旋转/为Character添加跑步动画/BP_STUBaseCharacter-Mesh-Animation.png" width="1300" /> <br/> <br/>
    
    可能存在动画下拉框无可选项的情况, 需要重新为动画绑定骨骼网格体 <br/>
2.  编译并运行 <br/>


## 优化视角旋转逻辑 {#优化视角旋转逻辑}

`C++` <br/>
`STUBaseCharacter` <br/>
**LookUp, TurnAround, AddControllerPitchInput和AddControllerYawInput的函数签名一致** <br/>

```cpp
void LookUp(float Amount);
void TurnAround(float Amount);
void AddControllerPitchInput(float Val);
void AddControllerYawInput(float Val)
```

1.  屏蔽 `LookUp` 和 `TurnAround` <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
2.  函数描述直接绑定 `AddControllerPitchInput` 和 `AddControllerYawInput` <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    // SetupPlayerInputComponent
    // PlayerInputComponent->BindAxis("LookUp", this, &ASTUBaseCharacter::LookUp);
    // PlayerInputComponent->BindAxis("TurnAround", this, &ASTUBaseCharacter::TurnAround);
    PlayerInputComponent->BindAxis("Lookup", this, &ASTUBaseCharacter::AddControllerPitchInput);
    PlayerInputComponent->BindAxis("TurnAround", this, &ASTUBaseCharacter::AddControllerYawInput)
    ```
3.  编译并运行 <br/>

