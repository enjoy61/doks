---
title: "实现游戏角色跑步"
date: 2023-06-11T06:17:43
lastmod: 2023-08-06T16:15:13+08:00
draft: false
weight: 1009
---

## 概览 {#概览}


### 跑步条件 {#跑步条件}

1.  按下Shift键 <br/>
2.  运动方向为向前 <br/>
    -   判断方法1：同时按下 `W` 或 `Up` <br/>
    -   判断方法2：速度矢量和朝向的夹角为0 <br/>
3.  速度不为0 <br/>
    前方有障碍物时，游戏角色无法跑步 <br/>


### 跑步时，播放跑步动画 {#跑步时-播放跑步动画}


### 跑步时，游戏角色运动速度提高 {#跑步时-游戏角色运动速度提高}


## 绑定跑步键位 {#绑定跑步键位}

`虚幻编辑器` <br/>
`项目设置 > Engine > Input` <br/>
`动作映射`      <br/>

| 函数描述 | 键位      |
|------|---------|
| Run  | LeftShift |

<img src="/pic/角色和动画/实现Character跑步/绑定跑步键位/跑步键位.png" width="500" /> <br/> <br/>


## 实现跑步逻辑 {#实现跑步逻辑}

`C++` <br/>

| -          | 回调函数签名   |
|------------|----------|
| BindAction | void handler() |

| 函数描述 | 回调函数   |       |
|------|--------|-------|
| Run  | RunEnable  | 按下时触发 |
|      | RunDisable | 松开时触发 |


### 搭建框架 {#搭建框架}

1.  添加空函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    void ASTUBaseCharacter::RunEnable() {}
    void ASTUBaseCharacter::RunDisable() {}
    ```
2.  绑定函数描述和回调函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    // SetupPlayerInputComponent
    PlayerInputComponent->BindAction("Run", IE_Pressed, this, &ASTUBaseCharacter::RunEnable);
    PlayerInputComponent->BindAction("Run", IE_Released, this, &ASTUBaseCharacter::RunDisable);
    ```
3.  添加函数声明 <br/>
    `private`          <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>


### 实现回调函数 {#实现回调函数}


#### 键位生效时，设置标识位 {#键位生效时-设置标识位}

1.  定义标志位 <br/>
    `private` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    bool AbleRun = false;
    ```
2.  键位事件发生时, 更新标志位 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    void ASTUBaseCharacter::RunEnable()
    {
        AbleRun = true;
    }
    void ASTUBaseCharacter::RunDisable()
    {
        AbleRun = false;
    }
    ```


#### 运动方向向前时，设置标志位 {#运动方向向前时-设置标志位}

1.  定义标志位 <br/>
    `private` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    bool IsForward = false;
    ```
2.  MoveForward被调用时, 更新标志位 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    // MoveForward
    IsForward = Amount > 0.0f;
    ```


#### 添加接口, 返回跑步条件满足情况 {#添加接口-返回跑步条件满足情况}

1.  添加函数声明 <br/>
    `public` <br/>
    可在蓝图中调用，也可供其他类使用 <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    UFUNCTION(BlueprintCallable)
    bool IsRunning() const;
    ```
2.  实现 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    bool ASTUBaseCharacter::IsRunning() const
    {
        return AbleRun && IsForward && !GetVelocity().IsZero();
    }
    ```


## 添加跑步动画 {#添加跑步动画}

`虚幻编辑器` <br/>


### 创建混合空间资产作为跑步动画 {#创建混合空间资产作为跑步动画}

`Blend Space 1D` <br/>

1.  创建 Content/Player/Animations/BS_Locomotion_Run，绑定骨骼网格体 HeroTPP_Skeleton <br/>
2.  设置轴 <br/>
    `Asset Details > Axis Settings > Horizontal Axis` <br/>
    
    |                    | -        |
    |--------------------|----------|
    | Name               | Velocity |
    | Maximum Axis Value | 600      |
3.  设置动画 <br/>
    
    | -  |               |
    |----|---------------|
    | 起点 | Idle          |
    | 终点 | RoadieRun_Fwd |


### 在动画蓝图中引入跑步动画 {#在动画蓝图中引入跑步动画}

`ABP_BaseCharacter` <br/>


#### 状态机说明 {#状态机说明}

<!--list-separator-->

-  新增状态: Run

<!--list-separator-->

-  状态迁移

    | -                  |          |
    |--------------------|----------|
    | Walk &gt; Run      | 满足跑步条件 |
    | Run &gt; Walk      | 不再满足跑步条件 |
    | Run &gt; JumpStart | 游戏角色在空中 |


#### 使状态机管理跑步状态 {#使状态机管理跑步状态}

<!--list-separator-->

-  添加布尔型变量IsRunning

<!--list-separator-->

-  设置变量IsRunning

    `EventGraph` <br/>
    
    1.  使用 `STUBaseCharacter::IsRunning` ，需要 `Pawn` 到 `STUBaseCharacter` 的转换 <br/>
        
        <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-EventGraph-STUBaseCharacter.png" width="800" /> <br/> <br/>
    2.  设置IsFalling后, 执行Pawn到STUBaseCharacter的转换 <br/>
    3.  转换完成后, 设置变量 `IsRunning` <br/>
        
        <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-EventGraph-IsRunning.png" width="700" /> <br/> <br/>
    4.  完整 `EventGraph` <br/>
        
        <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-EventGraph.png" width="1000" /> <br/> <br/>
    5.  可以合并 `Pawn` 到 `Character` 和 `STUBaseCharacter` 的转换 <br/>

<!--list-separator-->

-  状态机中添加跑步状态

    `AnimGraph` <br/>
    
    1.  将BS_Locomotion_Run拖入到状态机, 命令为 `Run` <br/>
        
        <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-AddRun.png" width="600" /> <br/> <br/>
    2.  双击 `Run` ，设置BS_Locomotion_Run输入 <br/>
        
        <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-Run.png" width="600" /> <br/> <br/>

<!--list-separator-->

-  添加状态迁移条件

    | -                  | 触发条件 |                                     |
    |--------------------|------|-------------------------------------|
    | Walk &gt; Run      | 满足跑步条件 | STUBaseCharacter::IsRunning 返回true |
    | Run &gt; Walk      | 不再满足跑步条件 | STUBaseCharacter::IsRunning 返回false |
    | Run &gt; JumpStart | 游戏角色在空中 | 复用 Walk &gt; JumpStart 迁移条件   |
    
    <!--list-separator-->
    
    -  Walk &lt;&gt; Run
    
        1.  状态迁移路径 <br/>
            
            <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-WalkAndRun.png" width="600" /> <br/> <br/>
        2.  `Walk > Run` 迁移条件 <br/>
            
            <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-WalkToRun.png" width="400" /> <br/> <br/>
        3.  `Run > Walk` 迁移条件 <br/>
            
            <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-RunToWalk.png" width="500" /> <br/> <br/>
    
    <!--list-separator-->
    
    -  Run &gt; Jump
    
        <!--list-separator-->
        
        -  状态迁移路径
        
            1.  初稿 <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-RunAndJump-Draft.png" width="500" /> <br/> <br/>
            2.  优解 <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/ABP_BaseCharacter-AnimGraph-Locomotion-RunAndJump.png" width="500" /> <br/> <br/>
                
                -   如果 `IsRunning` 为 `true`, 发生 `JumpEnd > Walk` 时, 会立即从 `Walk` 切换到 `Run` <br/>
                -   省略 `JumpEnd > =Run` ，可以降低状态机复杂度 <br/>
        
        <!--list-separator-->
        
        -  复用迁移条件
        
            `Run > JumpStart` 复用 `Walk > JumpStart` 迁移条件 <br/>
            
            1.  `选中 Walk > JumpStart 迁移条件, Details > Transiton > Transition Rule Sharing > Promote To Share` <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/WalkToJumpStart-Condition-PromoteToShare.png" width="800" /> <br/> <br/>
            2.  命名为 `IsFalling` ，共享条件显示为红色 <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/WalkToJumpStart-Condition-IsFalling.png" width="350" /> <br/> <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/WalkToJumpStart-Condition-IsFalling-Result.png" width="1100" /> <br/> <br/>
            3.  `选中 Run > JumpStart 迁移条件, Details > Transition > Transition Rule Sharing > Use Shared > 选择IsFalling` <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/RunToJumpStart-Condition-UseShare.png" width="800" /> <br/> <br/>
            4.  完整状态机 <br/>
                
                <img src="/pic/角色和动画/实现Character跑步/添加跑步动画/RunToJumpStart-Condition-UseShare-IsFalling.png" width="1000" /> <br/> <br/>


#### 效果 {#效果}

运行游戏，走路到跑步动画正常切换 <br/>


## 实现跑步加速 {#实现跑步加速}


### 创建Components/CharacterMovementComponent的派生类 {#创建components-charactermovementcomponent的派生类}

`虚幻编辑器` <br/>

-   `CharacterMovementComponent` <br/>
    
    <img src="/pic/角色和动画/实现Character跑步/创建派生自CharacterMovementComponent的C++类/基类CharacterMovementComponent.png" width="700" /> <br/> <br/>
-   `公有类` <br/>
    
    <img src="/pic/角色和动画/实现Character跑步/创建派生自CharacterMovementComponent的C++类/Components-STUCharacterMovementComponent.png" width="700" /> <br/> <br/>


### 设置头文件搜索路径 {#设置头文件搜索路径}

`ShootThemUp: ShootThemUp.Build.cs` <br/>

```csharp
PublicIncludePaths.AddRange(new string[] { "ShootThemUp/Public/Player", "ShootThemUp/Public/Components" });         
```


### 满足跑步条件时, 增加游戏角色运动速度上限 {#满足跑步条件时-增加游戏角色运动速度上限}

`C++` <br/>


#### 添加加速系数 {#添加加速系数}

`protected` <br/>
`ShootThemUp: Components/STUCharacterMovementComponent.h` <br/>

```cpp
UPROPERTY(EditDefaultsOnly, meta = (ClampMin = "1.5", ClampMax = "10.0"))
float SpeedAcceleration = 2.0f;
```


#### 覆写UCharacterMovementComponent::GetMaxSpeed {#覆写ucharactermovementcomponent-getmaxspeed}

-   并不直接修改 `MaxWalkSpeed` <br/>
-   某个地方会调用 `GetMaxSpeed` 来确定 `Character` 运动速度的上限，当获取的 `MaxWalkSpeed` 增加，速度增加的幅度也变大，用以实现加速 <br/>

<!--list-separator-->

-  添加函数声明

    `public` <br/>
    `ShootThemUp: Components/STUCharacterMovementComponent.h`         <br/>
    
    ```cpp
    virtual float GetMaxSpeed() const override;
    ```

<!--list-separator-->

-  实现

    `ShootThemUp: Components/STUCharacterMovementComponent.cpp` <br/>
    
    ```cpp
    #include "Player/STUBaseCharacter.h"
    
    float USTUCharacterMovementComponent::GetMaxSpeed() const
    {
        const float MaxSpeed = Super::GetMaxSpeed();
        ASTUBaseCharacter *Player = Cast<ASTUBaseCharacter>(GetPawnOwner());
        return Player && Player->IsRunning() ? SpeedAcceleration * MaxSpeed : MaxSpeed;
    }
    ```


#### 游戏角色使用STUCharacterMovementComponent {#游戏角色使用stucharactermovementcomponent}

1.  屏蔽默认构造函数声明，声明构造函数 <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    // ASTUBaseCharacter();
    ASTUBaseCharacter(const FObjectInitializer &ObjInit);
    ```
2.  修改构造函数初始化列表 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "Components/STUCharacterMovementComponent.h"
    
    ASTUBaseCharacter::ASTUBaseCharacter(const FObjectInitializer &ObjInit)
        : Super(ObjInit.SetDefaultSubobjectClass<USTUCharacterMovementComponent>(ACharacter::CharacterMovementComponentName))
    {
        // ...
    }
    ```

