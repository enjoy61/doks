---
title: "在窗口部件显示当前武器和弹药库"
date: 2023-10-08T01:42:15
lastmod: 2023-10-08T01:45:16+08:00
draft: false
weight: 2005
---

## 说明 {#说明}

在窗口部件的右下角显示武器图标, 子弹数和弹匣数 <br/>


## 概览 {#概览}

-   [X] 给武器组件和窗口部件的接口添加Current关键字 <br/>
-   [X] 窗口部件实现接口: 返回弹药数据 <br/>
-   [X] 窗口部件显示武器图标 <br/>
-   [X] 窗口部件显示弹药库存 <br/>


## 修改接口: 窗口部件返回武器图片 {#修改接口-窗口部件返回武器图片}


### 添加内部接口: 获取武器组件 {#添加内部接口-获取武器组件}

`ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>
`private` <br/>

```cpp
class USTUWeaponComponent;

USTUWeaponComponent *GetWeaponComponent() const;
```

`ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>

```cpp
USTUWeaponComponent *USTUPlayerHUDWidget::GetWeaponComponent() const
{
    const auto Player = GetOwningPlayerPawn();
    if (!Player) return nullptr;

    const auto Component = Player->GetComponentByClass(USTUWeaponComponent::StaticClass());
    const auto WeaponComponent = Cast<USTUWeaponComponent>(Component);
    return WeaponComponent;
}
```


### 使用内部接口: 获取武器组件 {#使用内部接口-获取武器组件}

`ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>

```cpp
// GetCrrentWeaponUIData
const auto WeaponComponent = GetWeaponComponent();
```


### 修改接口名: 武器组件返回武器图片 {#修改接口名-武器组件返回武器图片}

GetWeaponUIData `> GetCurrentWeaponUIData      
    =ShootThemUp: Components/STUWeaponComponent.h` <br/>
`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>


### 修改接口名: 窗口部件返回武器图片 {#修改接口名-窗口部件返回武器图片}

GetWeaponUIData `> GetCurrentWeaponUIData      
    =ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>
`ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>

```cpp
// GetCurrentWeaponUIData
return WeaponComponent->GetCurrentWeaponUIData(UIData);
```


### 更改接口 {#更改接口}

`WBP_PlayerHUD > Graph > Get Crosshair Image` <br/>


#### 添加函数GetCurrentWeaponUIData, 并展开UIData {#添加函数getcurrentweaponuidata-并展开uidata}


#### 修改针脚连线 {#修改针脚连线}

按下Command键同时点击选中区域, 将针脚连线移动到 `GetCurrentWeaponUIData > UIData Crosshair Icon` 和 `GetCurrentWeaponUIData > Return Value` <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/choose-pin.png" width="400" /> <br/> <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/get-current-weapon-uidata.png" width="500" /> <br/> <br/>


#### 将获取纹理大小封装成宏 {#将获取纹理大小封装成宏}

选中相关节点 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/macro-nodes.png" width="400" /> <br/> <br/>

右键 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/add-macro.png" width="400" /> <br/> <br/>

命名为 `ImageSizeFromTexture` <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/image-size-from-texture.png" width="700" /> <br/> <br/>

<!--list-separator-->

-  双击宏进入

    <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/inside-macro.png" width="800" /> <br/> <br/>

<!--list-separator-->

-  只需一个输入

    选中 `Inputs` , 去到 `Details > Inputs` , 删除第二个输入 <br/>
    
    <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/remove-one-input.png" width="1000" /> <br/> <br/>

<!--list-separator-->

-  将输入命名为Texture, 输出命名为Size

    <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/rename-input-output.png" width="400" /> <br/> <br/>

<!--list-separator-->

-  GetSizeX和GetSizeY的输入来自Texture

    <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/inside-macro-2.png" width="900" /> <br/> <br/>


#### 移除ImageSizefromTexture的无效输入 {#移除imagesizefromtexture的无效输入}

按下Option键同时点击选中区域 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/remove-invalid-input.png" width="400" /> <br/> <br/>


#### 修改后的GetCrosshairImage {#修改后的getcrosshairimage}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/get-current-weapon-ui-data-final.png" width="900" /> <br/> <br/>


## 添加接口: 窗口部件返回弹药信息 {#添加接口-窗口部件返回弹药信息}


### 添加接口: 武器基类返回弹药信息 {#添加接口-武器基类返回弹药信息}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
`public` <br/>

```cpp
FAmmoData GetAmmoData() const { return CurrentAmmo; }
```


### 添加接口: 武器组件返回弹药信息 {#添加接口-武器组件返回弹药信息}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>
`public` <br/>

```cpp
bool GetCurrentWeaponAmmoData(FAmmoData &AmmoData) const;
```

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
bool USTUWeaponComponent::GetCurrentWeaponAmmoData(FAmmoData &AmmoData) const
{
    if (CurrentWeapon)
    {
        AmmoData = CurrentWeapon->GetAmmoData();
        return true;
    }
    return false;
}
```


### 添加接口: 窗口部件返回弹药信息 {#添加接口-窗口部件返回弹药信息}

`ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>

```cpp
UFUNCTION(BlueprintCallable)
bool GetCurrentWeaponAmmoData(FAmmoData &AmmoData) const;
```

`ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>

```cpp
bool USTUPlayerHUDWidget::GetCurrentWeaponAmmoData(FAmmoData &AmmoData) const
{
    const auto WeaponComponent = GetWeaponComponent();
    if (!WeaponComponent) return false;

    return WeaponComponent->GetCurrentWeaponAmmoData(AmmoData);
}
```


## 在窗口部件显示武器信息 {#在窗口部件显示武器信息}

`WBP_PlayerHUD > Designer` <br/>


### 添加元素 {#添加元素}

-   水平对齐盒 <br/>
    `Horizontal Box` <br/>
-   文本框 <br/>
    `Text` <br/>
-   分隔 <br/>
    `Spacer` <br/>
-   图片 <br/>
    `Image` <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/horizontal-box.png" width="1000" /> <br/>   <br/>


#### 设置分隔 {#设置分隔}

分隔文本和图片 <br/>
`Details > Size` , 设置X=30 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/spacer-size-x.png" width="1000" /> <br/> <br/>


#### 设置水平对齐盒 {#设置水平对齐盒}

`Details > Slot > Size To Content` 勾选 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/horizontal-box-size-to-content.png" width="1000" /> <br/> <br/>

可以恰好包含内部元素 <br/>

<!--list-separator-->

-  设置锚点

    -   设置锚点为右下方 <br/>
        
        <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/horizontal-box-anchors-bottom-right.png" width="1000" /> <br/> <br/>
    -   设置大小, 位置, 对齐 <br/>
        
        -   `Slot` , Size X = 100, Size Y = 30 <br/>
            已勾选 `SizeToContent` , 不生效 <br/>
        -   `Slot` , Position X = Position Y = 0 <br/>
        -   `Slot > Alignment` , X = 1 Y = 1 <br/>
        
        <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/horizontal-box-size-pos-align.png" width="1000" /> <br/> <br/>
    -   设置缩进 <br/>
        `Slot` , Position X = Position Y = -50 <br/>
        
        <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/horizontal-box-indent.png" width="1000" /> <br/> <br/>


#### 设置预览图片 {#设置预览图片}

`RifleMainIcon` <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/rifle-icon.png" width="1000" /> <br/> <br/>


#### 设置文本框 {#设置文本框}

`Slot > Vertical Alignment` , 选择居中 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/text-vertical-alignment-center.png" width="1000" /> <br/> <br/>


### 获取武器图标 {#获取武器图标}


#### 为图片元素添加绑定 {#为图片元素添加绑定}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/image-bind.png" width="1000" /> <br/> <br/>


#### 命名为Get Weapon Icon {#命名为get-weapon-icon}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/get-weapon-icon.png" width="1000" /> <br/> <br/>


#### 从Get Crosshair Image拷贝节点并修改 {#从get-crosshair-image拷贝节点并修改}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/get-weapon-icon-final.png" width="1000" /> <br/> <br/>


### 显示弹药库 {#显示弹药库}


#### 格式 {#格式}

```text
弹匣内子弹数 / 弹匣数       
```


#### 为文本元素添加绑定 {#为文本元素添加绑定}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/text-bind.png" width="1000" /> <br/> <br/>


#### 命名为Get Ammo Text {#命名为get-ammo-text}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/get-ammo-text.png" width="1000" /> <br/> <br/>


#### 使用节点: GetCurrentWeaponAmmoData {#使用节点-getcurrentweaponammodata}


#### 合成文本 {#合成文本}

<!--list-separator-->

-  使用节点: Utilities &gt; String &gt; ToString

    将整数转换为字符串 <br/>
    对 `AmmoDataBullets` 和 `AmmoDataClips` 使用 <br/>

<!--list-separator-->

-  使用节点: Select

    对 `AmmoDataInfinite` 使用, 使用无限符号∞还是弹匣数作为分母 <br/>

<!--list-separator-->

-  使用节点: Utilities &gt; String &gt; Append

    拼接文本 <br/>

<!--list-separator-->

-  完成

    <img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/get-ammo-text-final.png" width="1000" /> <br/> <br/>
    
    `ReturnNode` 的输入是FText类型 <br/>
    
    以上逻辑可以在C++中实现. 之所以在蓝图中完成, 因为这部分逻辑更倾向于设计 <br/>

<!--list-separator-->

-  在蓝图中添加注释

    `Comment` <br/>
    按下 `C` 键 <br/>


## 查看 {#查看}

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/rifle.png" width="900" /> <br/> <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/launcher.png" width="900" /> <br/> <br/>

游戏角色死亡, 武器图标变为方块 <br/>

<img src="/pic/虚幻运动图表/在窗口部件显示当前武器和弹药库/die.png" width="1000" /> <br/> <br/>

