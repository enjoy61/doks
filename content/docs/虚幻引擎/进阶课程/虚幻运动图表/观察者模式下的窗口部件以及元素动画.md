---
title: "观察者模式下的窗口部件以及元素动画"
date: 2023-10-08T21:08:38
lastmod: 2023-10-09T03:14:15+08:00
draft: false
weight: 2006
---

## 说明 {#说明}

角色死亡进入观察者视角时隐藏窗口部件, 并显示死亡状态 <br/>
`Spectator Widget` <br/>


## 概览 {#概览}

-   [X] 添加接口: 判断游戏角色死亡和观察者模式 <br/>
-   [X] 游戏角色死亡后隐藏进度条、瞄准十字和武器信息 <br/>
-   [X] 游戏角色死亡后添加加载图标和提示, 并提示添加动画 <br/>


## 添加接口 {#添加接口}

`STUPlayerHUDWidget` <br/>

-   [X] 获取健康组件 <br/>
-   [X] 判断游戏角色死亡 <br/>
-   [X] 判断观察者模式 <br/>

`ShootThemUp: UI/STUPlayerHUDWidget.h` <br/>

```cpp
class USTUHealthComponent;

// private
USTUHealthComponent *GetHealthComponent() const;

// public

UFUNCTION(BlueprintCallable)
bool IsPlayerAlive() const;

UFUNCTION(BlueprintCallable)
bool IsPlayerSpectating() const;
```

`ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>

```cpp
USTUHealthComponent *USTUPlayerHUDWidget::GetHealthComponent() const
{
    const auto Player = GetOwningPlayerPawn();
    if (!Player) return nullptr;

    const auto Component = Player->GetComponentByClass(USTUHealthComponent::StaticClass());
    const auto HealthComponent = Cast<USTUHealthComponent>(Component);
    return HealthComponent;
}

bool USTUPlayerHUDWidget::IsPlayerAlive() const
{
    const auto HealthComponent = GetHealthComponent();
    return HealthComponent && !HealthComponent->IsDead();
}

bool USTUPlayerHUDWidget::IsPlayerSpectating() const
{
    const auto Controller = GetOwningPlayer();
    return Controller && Controller->GetStateName() == NAME_Spectating;
}
```


### 获取生命值百分比时使用获取健康组件函数 {#获取生命值百分比时使用获取健康组件函数}

`ShootThemUp: UI/STUPlayerHUDWidget.cpp` <br/>

```cpp
// GetHealthPercent
const auto HealthComponent = GetHealthComponent();
```


## 游戏角色死亡后隐藏窗口部件所有元素 {#游戏角色死亡后隐藏窗口部件所有元素}

`WBP_PlayerHUD` <br/>
画布面板 `Canvas Panel` 是进度条、瞄准十字和水平对齐盒的上级元素 <br/>

-   隐藏画布面板 <br/>
-   分别隐藏进度条、瞄准十字和水平对齐盒 <br/>


### 分别隐藏三个元素 {#分别隐藏三个元素}


#### 隐藏进度条 {#隐藏进度条}

选中进度条, `Details > Behavior > Visibility` , 添加绑定, 命名为 `Is Player Alive` <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/progress-bar-create-bind.png" width="1000" /> <br/> <br/>

通过窗口部件提供的 `IsPlayerAlive` 处理 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/is-player-alive.png" width="700" /> <br/> <br/>

检查绑定 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/progress-bar-check.png" width="1000" /> <br/> <br/>


#### 隐藏瞄准十字 {#隐藏瞄准十字}

选中图片, `Details > Behavior > Visibility` , 绑定 `Is Player Alive` <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/image-bind.png" width="1000" /> <br/> <br/>


#### 隐藏武器信息 {#隐藏武器信息}

选中水平对齐盒, 处理同上 <br/>


#### 查看 {#查看}

死亡后窗口部件全部隐藏 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/hidden-result.png" width="900" /> <br/> <br/>

恢复三个元素 `Details > Behavior > Visibility` 设置 <br/>


### 添加窗口部件蓝图 {#添加窗口部件蓝图}

`Content/UI` <br/>
创建窗口部件蓝图, 命名为WBP_AboveHUD, 基类为STUPlayerHUDWidget <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/create-WBP_aboveHUD.png" width="500" /> <br/> <br/>


#### 添加元素: 层级 {#添加元素-层级}

`Overlay` <br/>
支持分组元素的容器, 下级元素属于同一层级. 层级之间相互叠加 <br/>


#### 在当前窗口部件添加其他窗口部件 {#在当前窗口部件添加其他窗口部件}

窗口部件可以相互包含 <br/>
`Palette > USER CREATED > WBP Player HUD` , 添加 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/add-WBP_PlayerHUD.png" width="300" /> <br/> <br/>

设置水平和垂直填充 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/wbp-playerhud-fill.png" width="1000" /> <br/> <br/>

选中WBP_PlayerHUD, `Details > Behavior > Visibility > Bind > Create Binding` , 命名为Is Player Alive <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/wbp-abovehud-is-player-alive.png" width="1000" /> <br/> <br/>


#### 设置当前使用的关卡部件蓝图 {#设置当前使用的关卡部件蓝图}

`BP_STUGameHUD` <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/use-abovehud.png" width="1000" /> <br/> <br/>


## 观察者状态显示游戏角色状态 {#观察者状态显示游戏角色状态}


### 添加窗口部件蓝图 {#添加窗口部件蓝图}

`Content/UI` <br/>
创建窗口部件蓝图, 命名为WBP_SpectatorHUD, 基类为STUPlayerHUDWidget <br/>


#### 添加元素: 画布面板 {#添加元素-画布面板}

`Canvas Panel` <br/>


#### 添加元素: 层级 {#添加元素-层级}

`Overlay` <br/>

-   设置大小 <br/>
    `Details > Slot > Size X = Size Y = 200` <br/>
-   设置锚居中 <br/>
-   设置位置 <br/>
    `Details > Slot > Position X = Position Y = 0` <br/>
-   设置对齐 <br/>
    `Details > Slot > Alignment > X = Y = 0.5` <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/spectator-overlay.png" width="1000" /> <br/>   <br/>


#### 添加元素: 文本 {#添加元素-文本}

`Text` <br/>
`Details > Content > Text` , 设置为Dead <br/>
设置 `Horizontal Alignment` 为居中 <br/>
设置 `Vertical Alignment` 为居中 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/spectator-text.png" width="1000" /> <br/> <br/>


#### 添加元素: 转圈加载图标 {#添加元素-转圈加载图标}

`Circular Throbber` <br/>
`Preloader` <br/>

-   设置填充 <br/>
    `Details > Slot` <br/>
    设置 `Horizontal Alignment` 为填充 <br/>
    设置 `Vertical Alignment` 为填充 <br/>
-   设置分片数 <br/>
    设置 `Details > Appearance > Number of Pieces` 为14 <br/>
-   设置周期 <br/>
    设置 `Details > Appearance > Period` 为2 <br/>
-   设置颜色 <br/>
    设置 `Details > Image > Tint` 为红色 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/spectator-throbber.png" width="1000" /> <br/>   <br/>


### 添加观察者窗口部件 {#添加观察者窗口部件}

`WBP_AboveHUD` <br/>
添加 `Palette > USER CREATED > WBP Spectator HUD` <br/>

`Details > Slot` <br/>
设置 `Horizontal Alignment` 为填充 <br/>
设置 `Vertical Alignment` 为填充 <br/>

为可见性添加绑定 <br/>
`Details > Behavior > Visibility` , 命名为Is Player Spectating <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/is-player-sepctating.png" width="900" /> <br/> <br/>


## 为观察者窗口部件文本添加动画 {#为观察者窗口部件文本添加动画}

`WBP_SpectatorHUD` <br/>
使用虚幻运动图表的动画编辑器为用户接口元素添加动画属性 <br/>

选中Text, 打开动画窗口 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/to-add-animation-to-text.png" width="500" /> <br/> <br/>

选择添加动画 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/add-animation.png" width="1000" /> <br/> <br/>

命名为TextBlinking <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/name-textblinking.png" width="500" /> <br/> <br/>

选择TextBlinking, 为其添加轨道 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/add-track-for-textblinking.png" width="1000" /> <br/> <br/>

选择Text, 命名为DeatTextBlock <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/choose-text.png" width="500" /> <br/> <br/>

移动时间线到0.35(s), 为轨道关键帧 `Keyframe` 添加属性 `Color and Opacity` <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/0.35-color-opacity.png" width="1000" /> <br/> <br/>

设置为红色 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/set-red.png" width="1000" /> <br/> <br/>

移动时间线到0.7(s), 为轨道关键帧添加属性 `Color and Opacity` , 设置为白色 <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/set-white.png" width="1000" /> <br/> <br/>


### 播放元素动画 {#播放元素动画}

`WBP_SpectatorHUD > Graph` <br/>


#### 添加动画变量 {#添加动画变量}

将 `My Bluepint > VARIABLES > Animations > TextBlinking` 拖动到蓝图, 选择 `Get TextBlinking` <br/>

<img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/get-textblinking.png" width="800" /> <br/> <br/>


#### 播放动画 {#播放动画}

添加节点: Play Animation <br/>

设置循环播放: 将 `NumLoopsToPlay` 设为0 <br/>


#### 事件触发 {#事件触发}

-   [ ] 方法一: `Event Construct` 之后执行 `Play Animation` <br/>
-   [X] 方法二: 添加节点 `User Interface > Event On Initialized` , 之后执行 `Play Animation` <br/>
    
    <img src="/pic/虚幻运动图表/观察者模式下的窗口部件以及元素动画/play-animation.png" width="1000" /> <br/> <br/>
    
    `Event On Initialized` 更像BeginPlay, 只在游戏开始时调用 <br/>

