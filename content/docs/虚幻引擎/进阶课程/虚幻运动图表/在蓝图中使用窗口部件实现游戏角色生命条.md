---
title: "在蓝图中使用窗口部件实现游戏角色生命条"
date: 2023-10-06T19:21:06
lastmod: 2023-10-06T23:16:42+08:00
draft: false
weight: 2002
---

## 说明 {#说明}

-   了解如何在UE中实现用户接口 <br/>
-   了解窗口部件, 用来显示游戏角色生命值 <br/>
    `Widget`        <br/>
    `Health Bar` <br/>
-   纯蓝图 <br/>


## 概览 {#概览}

-   [X] 在C++中返回生命值百分比 <br/>
-   [X] 创建窗口部件蓝图 `WBP` <br/>
-   [X] 在HUD类中创建窗口部件并添加到关卡 <br/>
-   [X] 实现窗口部件: 添加进度条 <br/>


## 便签 {#便签}

[命名规范](https://github.com/Allar/ue5-style-guide) <br/>


## 实现接口: 返回生命值百分比 {#实现接口-返回生命值百分比}

`C++` <br/>
`ShootThemUp: Components/STUHealthComponent.h` <br/>
`public` <br/>

```cpp
UFUNCTION(BlueprintCallable)
float GetHealthPercent() const { return Health / MaxHealth; }
```


### 要求MaxHealth大于0 {#要求maxhealth大于0}

`ShootThemUp: Components/STUHealthComponent.cpp` <br/>

```cpp
// BeginPlay
checkf(MaxHealth > 0, TEXT("MaxHealth must more than 0"));
```


## 了解用户接口 {#了解用户接口}

`虚幻编辑器` <br/>


### 创建UI文件夹 {#创建ui文件夹}

`Content/UI` <br/>


### 创建窗口蓝图 {#创建窗口蓝图}

-   去到UI文件夹, 在空白处右键 `User Interface > Widget Blueprint` <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/创建wbp.png" width="1000" /> <br/> <br/>
-   设置基类: 选择 `Common > User Widget` <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/common-userwidget.png" width="600" /> <br/> <br/>
-   命名为WBP_PlayerHUD <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/wbp-show.png" width="500" /> <br/> <br/>


### 虚幻用户接口编辑器 {#虚幻用户接口编辑器}

双击WBP_PlayerHUD <br/>


#### 模式 {#模式}

在右上角进行切换 <br/>

|    | -        |                         |                             |
|----|----------|-------------------------|-----------------------------|
| 设计 | Designer | Blueprint Designer Mode |                             |
| 图表 | Graph    | Graph Editing Mode      | 和EventGraph类似, 根据游戏事件实现用户接口 |

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/wbp-2-state.png" width="1200" /> <br/> <br/>


#### 设计模式 {#设计模式}

<!--list-separator-->

-  层级结构窗口

    `Hierarchy` <br/>
    左侧; 对元素按照双亲 `Parent` 和后继者 `Inheritor` 关系进行分组 <br/>
    
    <!--list-separator-->
    
    -  添加Canvas Panel
    
        作为所有元素的根组件 <br/>
        在选项板搜索框输入 `Canvas Panel` , 拖入添加 <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/canvas-panel.png" width="1200" /> <br/> <br/>

<!--list-separator-->

-  选项板窗口

    `Palette` <br/>
    左侧; 包含各种窗口元素, 拖入元素到视口实现元素添加; 如按钮 `Button` , 文本框 `Text` , 复选框 `Check Box` 等 <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/palette.png" width="1200" /> <br/> <br/>
    
    元素的细节面板在右侧 <br/>
    
    <!--list-separator-->
    
    -  按钮
    
        `Common > Button` <br/>
    
    <!--list-separator-->
    
    -  文本框
    
        `Common > Text` <br/>
        可以在细节面板设置文本的内容和颜色等 <br/>
    
    <!--list-separator-->
    
    -  水平对齐盒
    
        `Horizontal Box` <br/>
        对元素进行分组, 并使之水平对齐; 孩子元素的变换依赖于双亲元素的变换 <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/horizontal-box.png" width="1200" /> <br/> <br/>
        
        <!--list-separator-->
        
        -  添加下级元素, 可设置元素的填充方式
        
            -   按钮和文本框作为其下属元素 <br/>
            -   按钮的填充方式默认为Auto, 设置为Fill <br/>
                在层级结构选中按钮元素, 去到细节面板, `Slot(Horizontal Box Slot) > Size` <br/>
                
                <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/button-auto.png" width="1200" /> <br/> <br/>
                
                <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/button-fill.png" width="1200" /> <br/> <br/>


## 在虚幻编辑器视口添加窗口部件 {#在虚幻编辑器视口添加窗口部件}

让STUGameHUD类作为用户接口的控制器 `Controller` <br/>


### 创建基于STUGameHUD的蓝图类 {#创建基于stugamehud的蓝图类}

命名为BP_STUGameHUD, 保存到Content/UI <br/>

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/创建bp-STUGameHUD.png" width="1000" /> <br/> <br/>


### 设置关卡使用BP_STUGameHUD {#设置关卡使用bp-stugamehud}

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/使用bp-STUGameHUD.png" width="400" /> <br/> <br/>


### 在BP_STUGameHUD中实现 {#在bp-stugamehud中实现}

去到 `EventGraph` <br/>
在BeginPlay中完成 <br/>


#### 创建窗口部件 {#创建窗口部件}

-   添加节点 `User Interface > Create Widget` <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/node-create-widget.png" width="400" /> <br/> <br/>
-   设置窗口部件类型为 `WBP_PlayerHUD` <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/node-create-widget-class.png" width="600" /> <br/> <br/>


#### 在视口中添加窗口部件 {#在视口中添加窗口部件}

-   添加节点 `User Interface > Viewport > Add to Viewport` , 刚创建的窗口部件作为其输入 <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/node-add-to-viewport.png" width="800" /> <br/> <br/>


### 查看效果 {#查看效果}

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/widget-in-viewport.png" width="1000" /> <br/> <br/>

按下 `Shift+F1` 释放鼠标 <br/>


## 实现生命条 {#实现生命条}

`WBP_PlayerHUD` <br/>

-   移除 `Canvas Panel` 外的所有元素 <br/>
-   添加进度条 <br/>
    
    <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/progress-bar.png" width="1200" /> <br/> <br/>


### 进度条 {#进度条}

`Progress Bar` <br/>
由两张图片组成: 一个作为背景, 一个对进度条进行填充; 后者的大小根据进度改变 <br/>


#### 修改进度查看效果 {#修改进度查看效果}

选中进度条, 去到细节面板, 拖动以修改 `Progress > Percent` , 查看不同 <br/>


#### 设置进度条颜色 {#设置进度条颜色}

`ProgressBar > Details > Style > Fill Image > Tint` <br/>
设置为绿色 <br/>

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/set-progress-bar-color.png" width="1200" /> <br/> <br/>


### 属性: 绑定 {#属性-绑定}

`Bind` <br/>
虚幻动作图表中不可忽视的一个属性, 呈现为下拉框 `Drop-down Box` <br/>
支持将更新函数绑定到数值 <br/>


#### 为生命条绑定更新函数 {#为生命条绑定更新函数}

<!--list-separator-->

-  创建蓝图函数: Get_Health_Percent

    `ProgressBar > Details > Progress > Percent > Bind > Create Binding` <br/>
    
    -   在图表模式中查看 <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/graph-get-percent.png" width="1200" /> <br/> <br/>
    -   重命名为 `Get_Health_Percent` <br/>

<!--list-separator-->

-  实现Get_Health_Percent逻辑

    -   获取Pawn实例 <br/>
        添加节点 `Player > Get Owning Player Pawn` <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/add-node-get-pawn.png" width="400" /> <br/> <br/>
    -   获取健康组件 <br/>
        添加节点 `Actor > Get Components by Class` <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/add-node-get-component.png" width="700" /> <br/> <br/>
        
        设置组件类型为 `STUHealthComponent` <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/pawn+component.png" width="700" /> <br/> <br/>
    -   调用健康组件提供的函数 `GetHealthPercent` <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/get-health-percent.png" width="700" /> <br/> <br/>
    -   检查Pawn实例和健康组件的返回指针的有效性 <br/>
        添加节点 `IsValid` <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/add-node-is-valid.png" width="700" /> <br/> <br/>
        
        若均有效, 返回值来自 `GetHealthPercent` ; 否则, 返回0 <br/>
        
        <img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/graph-final.png" width="1200" /> <br/> <br/>


## 查看 {#查看}

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/result.png" width="1000" /> <br/> <br/>


## 修改生命值恢复频率 {#修改生命值恢复频率}

`BP_STUBaseCharacter` <br/>
设置为0.03; 生命值恢复时, 进度条变化较圆滑, 相应地, 速度变快 <br/>

<img src="/pic/虚幻运动图表/在蓝图中使用窗口部件实现游戏角色生命条/character-heal-rate.png" width="1200" /> <br/> <br/>

