---
title: "装弹动画"
date: 2023-09-07T14:02:36
lastmod: 2023-09-07T14:27:43+08:00
draft: false
weight: 2021
---

## 说明 {#说明}

1.  已在弹夹子弹耗尽时实现自动装弹逻辑 <br/>
2.  现在实现手动装弹的第一步, 播放装弹动画 <br/>
3.  步枪和发射器各有一个装弹动画, 使用动画剪辑实现 <br/>


## 概览 {#概览}

-   [X] 创建两个动画剪辑资产, 并设置SlotName <br/>
-   [X] 绑定手动装弹键位 <br/>
-   [X] 将武器信息封装到数据结构 <br/>
-   [X] 更换武器时, 更新对应的装弹动画 <br/>


## 创建动画剪辑资产 {#创建动画剪辑资产}

1.  为装弹动画绑定骨骼HeroTPP_Skeleton, 创建对应的动画剪辑资产, 保存到Player/Animations <br/>
    
    | -               |                    |
    |-----------------|--------------------|
    | Launcher_Reload | AM_Launcher_Reload |
    | Reload          | AM_Reload          |
    
    <img src="/pic/武器/装弹动画/存放动画剪辑.png" width="1000" /> <br/> <br/>
2.  设置动画剪辑的SlotName, 选择UpperBody <br/>
    
    <img src="/pic/武器/装弹动画/修改SlotName1.png" width="600" /> <br/> <br/>
    
    <img src="/pic/武器/装弹动画/修改SlotName2.png" width="600" /> <br/> <br/>


## 绑定装弹键位 {#绑定装弹键位}

`项目设置 > Engine > Input` <br/>

|      | -               |
|------|-----------------|
| 类型 | Action Mappings |
| 函数描述 | Reload          |
| 键位 | R               |

<img src="/pic/武器/装弹动画/键位绑定.png" width="600" /> <br/> <br/>


## 搭建手动装弹框架 {#搭建手动装弹框架}


### 添加空的Reload函数 {#添加空的reload函数}

`ShootThemUp: Components/STUWeaponComponent.h`          <br/>
`public` <br/>

```cpp
void Reload();
```

`ShootThemUp: Components/STUWeaponComponent.cpp`          <br/>

```cpp
void USTUWeaponComponent::Reload()
{
    PlayAnimMontage(CurrentReloadAnimMontage);
}
```


### 绑定函数描述和回调函数 {#绑定函数描述和回调函数}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
// SetupPlayerInputComponent
PlayerInputComponent->BindAction("Reload", IE_Pressed, WeaponComponent, &USTUWeaponComponent::Reload);           
```


## 将武器信息封装到数据结构 {#将武器信息封装到数据结构}

当前, 不同武器有各自的武器类属性, 结合装弹动画, 定义存放武器信息的数据结构 <br/>


### 定义数据结构存放武器信息 {#定义数据结构存放武器信息}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
USTRUCT(BlueprintType)
struct FWeaponData
{
    GENERATED_USTRUCT_BODY()
    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite, Category = "Weapon")
    TSubclassOf<ASTUBaseWeapon> WeaponClass;

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite, Category = "Weapon")
    UAnimMontage *ReloadAnimMontage;
};
```


### 在武器组件类添加数组成员, 存放武器信息 {#在武器组件类添加数组成员-存放武器信息}

`protected` <br/>
`ShootThemUp: Components/STUWeaponComponent.h`          <br/>

```cpp
UPROPERTY(EditDefaultsOnly, Category = "Weapon")
TArray<FWeaponData> WeaponData;
```


### 屏蔽武器类属性 {#屏蔽武器类属性}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>


### 创建武器时, 依据数组信息 {#创建武器时-依据数组信息}

注意: 若创建武器失败, 继续创建其他武器 <br/>
`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
// SpawnWeapons
 for (auto OneWeaponData : WeaponData)
 {
     auto Weapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(OneWeaponData.WeaponClass);
     if (!Weapon) continue;
     Weapons.Add(Weapon);
     Weapon->SetOwner(Character);
     AttachWeaponToSocket(Weapon, Character->GetMesh(), WeaponArmorySocketName);
 }
```


## 添加属性, 指向当前装弹动画 {#添加属性-指向当前装弹动画}

`private`      <br/>
经常需要播放装弹动画 <br/>

`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
UPROPERTY()
UAnimMontage *CurrentReloadAnimMontage = nullptr;
```


## 更换武器时, 更新装弹动画 {#更换武器时-更新装弹动画}

`EquipWeapon` <br/>
`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>


### 进入时检查WeaponIndex {#进入时检查weaponindex}

```cpp
if (WeaponIndex < 0 || WeaponIndex >= Weapons.Num())
{
    UE_LOG(LogWeaponComponent, Warning, TEXT("Invalid weapon index"));
    return;
}
```


### 不使用武器标号获取动画剪辑 {#不使用武器标号获取动画剪辑}

1.  创建武器时, 根据WeaponData元素顺序 <br/>
2.  存在武器创建失败的情况, 后续可能需要对武器进行排序 <br/>

<!--listend-->

```cpp
// CurrentReloadAnimMontage = WeaponData[WeaponIndex].ReloadAnimMontage;           
```


### 根据武器类型, 查找对应的武器信息 {#根据武器类型-查找对应的武器信息}

使用lambda表达式实现查找谓语 <br/>

-   对调用运算符进行重载 <br/>
-   使用lambda表达式实现一元谓语, 捕获引用, 比对武器类型, 返回true或false <br/>
-   若匹配元素个数为0或大于1, 查找函数返回nullptr <br/>

<!--listend-->

```cpp
const auto CurrentWeaponData = WeaponData.FindByPredicate([&](const FWeaponData &Data){ // 
    return Data.WeaponClass == CurrentWeapon->GetClass();                               //
});
```


### 设置当前武器的装弹动画剪辑 {#设置当前武器的装弹动画剪辑}

```cpp
CurrentReloadAnimMontage = CurrentWeaponData ? CurrentWeaponData->ReloadAnimMontage : nullptr;
```


## 设置游戏角色的WeaponData数组 {#设置游戏角色的weapondata数组}

`打开BP_STUBaseCharacter, 选中WeaponComponent, 去到Details > Weapon > WeaponData` <br/>

<img src="/pic/武器/装弹动画/WeaponData.png" width="700" /> <br/> <br/>

