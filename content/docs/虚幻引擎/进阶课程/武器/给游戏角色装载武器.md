---
title: "给游戏角色装载武器"
date: 2023-06-11T07:24:08
lastmod: 2023-08-17T06:30:03+08:00
draft: false
weight: 1002
---

## 概览 {#概览}

-   [X] 导入武器相关资产 <br/>
-   [X] 创建武器类STUBaseWeapon和BP_STUBaseWeapon <br/>
-   [X] 为STUBaseWeapon添加骨骼网格体, 绑定武器模型 <br/>
    
    | 武器模型 | 说明                            |
    |------|-------------------------------|
    | Launcher | 发射导弹                        |
    | Rifle    | 发射子弹 `Shoot Regular Cartridges` |
-   [X] 为游戏角色骨骼网格体添加挂载点, 动态创建武器对象并挂载到游戏角色 <br/>


## 导入武器相关资产 {#导入武器相关资产}

`虚幻编辑器` <br/>

1.  之前将资产导入到Content/ExternalContent/Animation，有两点需注意 <br/>
    -   资产之前存在相互引用，这个在Migrate过程中，不一定会全无问题 <br/>
    -   我们选择Migrate `ShooterGame/Content/Animations/TTP_Animations` ，而实际导出有多个文件夹，里面的内容都和TTP_Animations有关 <br/>
2.  本节需要Migrate的武器资产，其相关内容与之前的内容有重叠; 和之前一样, 在ExternalContent下单独创建一个文件夹，存放本次导入资产 <br/>


### 从ShooterGame导出 {#从shootergame导出}

1.  `选中Content/Weapons > Migrate` <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/migrate.png" width="800" /> <br/> <br/>
2.  相关文件存放在Characters，Environment和Weapons中 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/Weapons.png" width="500" /> <br/> <br/>
3.  保存到ShootThemUp/Content <br/>


### 导入到ShootThemUp {#导入到shootthemup}

1.  创建ExternalContent/Weapon，并设置文件夹颜色 <br/>
2.  将资产移动到ExternalContent/Weapon <br/>

<img src="/pic/武器/给游戏角色装载武器/ExternalContent.png" width="500" /> <br/> <br/>


## 创建武器类 {#创建武器类}


### 初始化C++类: STUBaseWeapon {#初始化c-plus-plus-类-stubaseweapon}


#### 创建C++类: Weapon/STUBaseWeapon {#创建c-plus-plus-类-weapon-stubaseweapon}

`虚幻编辑器` <br/>

-   `Actor` <br/>
-   `公有类` <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/STUBaseWeapon.png" width="700" /> <br/> <br/>


#### 设置头文件路径 {#设置头文件路径}

`C++` <br/>
`ShootThemUp: ShootThemUp.Build.cs` <br/>

```csharp
PublicIncludePaths.AddRange(new string[]
{
    "ShootThemUp/Public/Player",
    "ShootThemUp/Public/Components",
    "ShootThemUp/Public/Dev",
    "ShootThemUp/Public/Weapon"
});
```


#### 调整框架 {#调整框架}

`C++` <br/>

| -         |             |
|-----------|-------------|
| 构造函数  | 每帧调用置为false |
| Tick      | 屏蔽        |
| BeginPlay | -           |

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>


#### 添加骨骼网格体组件, 用来绑定武器模型 {#添加骨骼网格体组件-用来绑定武器模型}

`C++` <br/>
[USkeletalMeshComponent](/docs/虚幻引擎/api/虚幻c++/组件/skeletalmesh组件/#uskeletalmeshcomponent) <br/>

1.  添加组件 <br/>
    `protected` <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
    ```cpp
    class USkeletalMeshComponent;
    
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USkeletalMeshComponent *WeaponMeshComponent;
    ```
2.  初始化组件 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
    ```cpp
    // 构造函数
    
    WeaponMeshComponent = CreateDefaultSubobject<USkeletalMeshComponent>("WeaponMeshComponent");
    SetRootComponent(WeaponMeshComponent);
    ```


### 创建BP_STUBaseWeapon并绑定武器模型 {#创建bp-stubaseweapon并绑定武器模型}

`虚幻编辑器` <br/>

1.  创建文件夹: Content/Weapon <br/>
2.  创建BP_STUBaseWeapon，保存到Content/Weapon <br/>
3.  为WeaponMeshComponent绑定Rifle <br/>
4.  因为武器很小，设置Camera Speed为1 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/CameraSpeed.png" width="1200" /> <br/> <br/>


## 为游戏角色的骨骼网格体添加武器挂载点 {#为游戏角色的骨骼网格体添加武器挂载点}

`虚幻编辑器` <br/>
[为骨骼网格体添加挂载点](/docs/虚幻引擎/专题/虚幻编辑器/为骨骼网格体添加挂载点/#为骨骼网格体添加挂载点) <br/>


## 动态创建武器，并附加到游戏角色骨骼网格体的挂载点 {#动态创建武器-并附加到游戏角色骨骼网格体的挂载点}

`C++` <br/>


### 添加武器类型属性, 动态创建Actor时使用 {#添加武器类型属性-动态创建actor时使用}

1.  `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    `protected` <br/>
    ```cpp
    class ASTUBaseWeapon;
    
    UPROPERTY(EditDefaultsOnly)
    TSubclassOf<ASTUBaseWeapon> WeaponClass;
    ```
2.  `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "Weapon/STUBaseWeapon.h"
    ```


### 动态创建武器Actor {#动态创建武器actor}

使用了UWorld::SpawnActor，所以我认为应该包含；但没包含编译通过了 <br/>

```cpp
#include "Engine/World.h"

if (!GetWorld()) return;
const auto Weapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(WeaponClass);
```


### 将武器附加到骨骼网格体挂载点 {#将武器附加到骨骼网格体挂载点}

1.  获取骨骼网格体: [ACharacter::GetMesh](/docs/虚幻引擎/api/虚幻c++/游戏角色/character类/#acharacter-getmesh) <br/>
2.  [将Actor附加到可变换组件的挂载点](/docs/虚幻引擎/专题/虚幻c++/将actor附加到可变换组件的挂载点/#将actor附加到可变换组件的挂载点) <br/>
    AttachToComponent的第一个参数是USenceComponent类型，而我们传入其派生类USkeletalMeshComponent类型, 所以需要包含Components/SkeletalMeshComponent.h <br/>

<!--listend-->

```cpp
FAttachmentTransformRules AttachmentRules(EAttachmentRule::SnapToTarget, false);
Weapon->AttachToComponent(GetMesh(), AttachmentRules, "WeaponSocket");
```


### 完整实现: SpawnWeapon {#完整实现-spawnweapon}

1.  `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    `private` <br/>
    ```cpp
    void SpawnWeapon();
    ```
2.  `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "Engine/World.h"
    #include "Components/SkeletalMeshComponent.h"
    
    void ASTUBaseCharacter::SpawnWeapon()
    {
        if (!GetWorld()) return;
        const auto Weapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(WeaponClass);
        if (!Weapon) return;
    
        FAttachmentTransformRules AttachmentRules(EAttachmentRule::SnapToTarget, false);
        Weapon->AttachToComponent(GetMesh(), AttachmentRules, "WeaponSocket");
    }
    ```
3.  游戏角色出现在场景中时, 创建并装载武器: 在BeginPlay中调用SpawnWeapon <br/>


## 查看 {#查看}

`虚幻编辑器` <br/>

1.  设置武器类型: 将BP_STUBaseCharacter的WeaponClass设置为BP_STUBaseWeapon <br/>
2.  效果图 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/游戏角色持有武器.png" width="600" /> <br/> <br/>

