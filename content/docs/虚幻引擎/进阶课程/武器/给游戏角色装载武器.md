---
title: "给游戏角色装载武器"
date: 2023-06-11T07:24:08
lastmod: 2023-08-12T14:36:40+08:00
draft: false
weight: 1002
---

## 概览 {#概览}

1.  骨骼网格体组件 <br/>
    [USkeletalComponent](/docs/虚幻引擎/api/虚幻c++/组件/skeletal组件/#uskeletalcomponent) <br/>
2.  武器Actor对象 <br/>
    动态创建，并附加到Character <br/>
    
    |          | 说明                           |
    |----------|------------------------------|
    | Launcher | 发射导弹                       |
    | Rifle    | 发射子弹(shoot regular cartridges) |
3.  [给骨骼网格体添加挂载点](/docs/虚幻引擎/专题/虚幻编辑器/给骨骼网格体添加装载点/#给骨骼网格体添加挂载点) <br/>
4.  [在可变换组件上挂载Actor](/docs/虚幻引擎/专题/虚幻c++/在可变换组件上挂载actor/#在可变换组件上挂载actor) <br/>


## 导入资产 {#导入资产}

`虚幻编辑器` <br/>

1.  之前将资产导入到Content/ExternalContent/Animation，有两点需注意 <br/>
    -   资产之前存在相互引用，这个在Migrate过程中，不一定会全无问题 <br/>
    -   我们选择Migrate `ShooterGame/Content/Animations/TTP_Animations` ，而实际导出有多个文件夹，里面的内容都和 TTP_Animations 有关 <br/>
2.  本节需要Migrate的武器资产，其相关内容甚至和之前的内容有重叠，和之前一样, 在ExternalContent下单独创建一个文件夹，作为章节资产汇总 <br/>


### 迁移资产 {#迁移资产}

`ShooterGame` <br/>

1.  `选中Content/Weapons > Migrate` <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/migrate.png" width="800" /> <br/> <br/>
2.  相关文件分别存放在Characters，Environment和Weapons中 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/Weapons.png" width="500" /> <br/> <br/>
3.  保存到ShootThemUp/Content <br/>


### 导入到ShootThemUp {#导入到shootthemup}

1.  创建ExternalContent/Weapon，并设置文件夹颜色 <br/>
2.  将资产移动到ExternalContent/Weapon <br/>
3.  效果图 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/ExternalContent.png" width="500" /> <br/> <br/>


## 初始化Weapon/STUBaseWeapon {#初始化weapon-stubaseweapon}


### 创建Weapon/STUBaseWeapon {#创建weapon-stubaseweapon}

`虚幻编辑器` <br/>

-   `Actor` <br/>
-   `公有类` <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/STUBaseWeapon.png" width="700" /> <br/> <br/>


### 设置头文件路径 {#设置头文件路径}

`C++` <br/>
`ShootThemUp: ShootThemUp.Build.cs` <br/>

```csharp
PublicIncludePaths.AddRange(new string[]
{
    "ShootThemUp/Public/Player",
    "ShootThemUp/Public/Components",
    "ShootThemUp/Public/Dev",
    "ShootThemUp/Public/Weapon"
});
```


### 调整框架 {#调整框架}

`C++` <br/>

| 基础函数  | 操作        |
|-------|-----------|
| 构造函数  | 每帧调用置为false |
| Tick      | 屏蔽        |
| BeginPlay | -           |

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>


### 添加骨骼网格体组件 {#添加骨骼网格体组件}

`C++`       <br/>

1.  添加数据成员 <br/>
    `protected` <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
    ```cpp
    class USkeletalMeshComponent;
    
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USkeletalMeshComponent *WeaponMeshComponent;
    ```
2.  初始化组件 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
    ```cpp
    // 构造函数
    WeaponMeshComponent = CreateDefaultSubobject<USkeletalMeshComponent>("WeaponMeshComponent");
    SetRootComponent(WeaponMeshComponent);
    ```


## 创建BP_STUBaseWeapon {#创建bp-stubaseweapon}

`虚幻编辑器` <br/>

1.  创建Content/Weapon <br/>
2.  创建BP_STUBaseWeapon，保存到Content/Weapon <br/>
3.  为WeaponMeshComponent绑定Rifle <br/>
4.  因为武器很小，设置Camera Speed为1 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/CameraSpeed.png" width="1200" /> <br/> <br/>


## 在游戏角色骨骼网格体上设置武器挂载点 {#在游戏角色骨骼网格体上设置武器挂载点}

`虚幻编辑器` <br/>
[给骨骼网格体添加挂载点](/docs/虚幻引擎/专题/虚幻编辑器/给骨骼网格体添加装载点/#给骨骼网格体添加挂载点) <br/>


## 在代码中动态创建武器，并挂载到游戏角色 {#在代码中动态创建武器-并挂载到游戏角色}

`C++` <br/>


### 添加武器类型属性 {#添加武器类型属性}

`protected` <br/>
`ShootThemUp: Player/STUBaseCharacter.h` <br/>

```cpp
class ASTUBaseWeapon;

UPROPERTY(EditDefaultsOnly)
TSubclassOf<ASTUBaseWeapon> WeaponClass;
```

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
#include "Weapon/STUBaseWeapon.h"
```


### 动态创建武器 {#动态创建武器}

[在可变换组件上挂载Actor](/docs/虚幻引擎/专题/虚幻c++/在可变换组件上挂载actor/#在可变换组件上挂载actor) <br/>

| -                                  |                                                                         |
|------------------------------------|-------------------------------------------------------------------------|
| Engine/World.h                     | 使用了UWorld::SpawnActor，所以我认为应该包含；但没包含编译通过了        |
| Components/SkeletalMeshComponent.h | AttachToComponent的第一个参数是USenceComponent类型，而我们传参其派生类USkeletalComponent类型 |

1.  函数实现 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "Engine/World.h"
    #include "Components/SkeletalMeshComponent.h"
    
    // 在BeginPlay中调用
    void ASTUBaseCharacter::SpawnWeapon()
    {
        if (!GetWorld())
            return;
        const auto Weapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(WeaponClass);
        if (Weapon)
        {
            FAttachmentTransformRules AttachmentRules(EAttachmentRule::SnapToTarget, false);
            Weapon->AttachToComponent(GetMesh(), AttachmentRules, "WeaponSocket");
        }
    }
    ```
2.  函数声明 <br/>
    `private` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>


## 查看 {#查看}

`虚幻编辑器` <br/>

1.  配置BP_STUBaseCharacter的WeaponClass属性，BP_STUBaseWeapon <br/>
2.  效果图 <br/>
    
    <img src="/pic/武器/给游戏角色装载武器/游戏角色持有武器.png" width="600" /> <br/> <br/>

