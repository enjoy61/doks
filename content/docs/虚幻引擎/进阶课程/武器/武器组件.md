---
title: "武器组件"
date: 2023-06-25T16:42:52
lastmod: 2023-08-17T06:30:33+08:00
draft: false
weight: 1004
---

## 概览 {#概览}

-   [X] 创建武器组件类 `STUWeaponComponent` <br/>
-   [X] 武器组件负责武器相关逻辑: 将SpawnWeapon移到武器组件 <br/>
-   [X] 为游戏角色添加武器组件 <br/>
-   [X] 为武器类添加 `Fire` 接口, 对应扣动扳机逻辑 <br/>
-   [X] 为游戏角色绑定鼠标左键, 武器组件提供回调函数 `Fire` , 调用武器类 `Fire` 接口 <br/>


## 初始化武器组件类 {#初始化武器组件类}


### 创建C++类: Components/STUWeaponComponent {#创建c-plus-plus-类-components-stuweaponcomponent}

`虚幻编辑器` <br/>

| -              |
|----------------|
| ActorComponent |
| Public         |
| Components     |


### 调整框架 {#调整框架}

`C++` <br/>

| -             |            |
|---------------|------------|
| 构造函数      | 每帧调用置false |
| TickComponent | 屏蔽       |

`ShootThemUp: Components/STUWeaponComponent.h` <br/>
`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>


### 将SpawnWeapon逻辑移动到武器组件 {#将spawnweapon逻辑移动到武器组件}

`C++` <br/>


#### 在STUWeaponComponent中实现SpawnWeapon {#在stuweaponcomponent中实现spawnweapon}

<!--list-separator-->

-  添加武器类型属性, 动态创建Actor时使用

    1.  `ShootThemUp: Components/STUWeaponComponent.h` <br/>
        `protected` <br/>
        ```cpp
        class ASTUBaseWeapon;
        
        UPROPERTY(EditDefaultsOnly)
        TSubclassOf<ASTUBaseWeapon> WeaponClass;
        ```
    2.  `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
        ```cpp
        #include "Weapon/STUBaseWeapon.h"
        ```

<!--list-separator-->

-  添加变量: 存放挂载点名称

    `protected` <br/>
    `ShootThemUp: Components/STUWeaponComponent.h`         <br/>
    
    ```cpp
    UPROPERTY(EditDefaultsOnly)
    FName WeaponAttachPointName = "WeaponSocket";
    ```

<!--list-separator-->

-  添加变量: 存放武器指针

    `private` <br/>
    使用UPROPERTY宏标识, 使得Garbage Collector管理该指针指向的内存 <br/>
    
    ```cpp
    UPROPERTY()
    ASTUBaseWeapon *CurrentWeapon= nullptr;
    ```

<!--list-separator-->

-  添加函数: SpawnWeapon

    1.  `ShootThemUp: Components/STUWeaponComponent.h`  <br/>
        `private` <br/>
        ```cpp
        void SpawnWeapon();
        ```
    2.  `ShootThemUp: Components/STUWeaponComponent.cpp`  <br/>
        处理不正确则退出: 统一结构, 减少缩进 <br/>
        ```cpp
        #include "Engine/World.h"
        #include "Components/SkeletalMeshComponent.h"
        #include "Weapon/STUBaseWeapon.h"
        #include "GameFramework/Character.h"
        
        void USTUWeaponComponent::SpawnWeapon()
        {
            if (!GetWorld()) return;
        
            ACharacter *Character = Cast<ACharacter>(GetOwner());
            if (!Character) return;
        
            CurrentWeapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(WeaponClass);
            if (!CurrentWeapon) return;
        
            FAttachmentTransformRules AttachmentRules(EAttachmentRule::SnapToTarget, false);
            CurrentWeapon->AttachToComponent(Character->GetMesh(), AttachmentRules, WeaponAttachPointName);
        }
        ```
    3.  武器组件出现在场景中时, 创建并装载武器: 在BeginPlay中调用SpawnWeapon <br/>


#### 移除STUBaseCharacter中的SpawnWeapon {#移除stubasecharacter中的spawnweapon}

1.  `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    -   STUBaseWeapon前向声明 <br/>
    -   WeaponClass成员 <br/>
    -   SpawnWeapon声明 <br/>
2.  `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    -   头文件: STUBaseWeapon, World, SkeletalMeshComponent <br/>
    -   BeginPlay中调用SpawnWeapon <br/>
    -   SpawnWeapon <br/>


## 为游戏角色添加武器组件 {#为游戏角色添加武器组件}

`C++` <br/>
武器组件是纯逻辑组件, 不用设置上级组件 <br/>

1.  添加组件 <br/>
    `protected` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    class USTUWeaponComponent;
    
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USTUWeaponComponent *WeaponComponent;
    ```
2.  初始化组件 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "Components/STUWeaponComponent.h"
    
    // 构造函数
    WeaponComponent = CreateDefaultSubobject<USTUWeaponComponent>("WeaponComponent");
    ```


## 查看武器绑定 {#查看武器绑定}

`虚幻编辑器` <br/>

1.  为武器组件设置武器类型 <br/>
    `BP_STUBaseCharacter > Weapon Component > Weapon Class: 设置为BP_STUBaseWeapon` <br/>
2.  效果图: 和之前效果一致 <br/>
    
    <img src="/pic/武器/武器组件/重构.png" width="800" /> <br/> <br/>


## 实现游戏角色扣动扳机 {#实现游戏角色扣动扳机}


### 为游戏角色绑定键位: 点击鼠标左键触发扣动扳机 {#为游戏角色绑定键位-点击鼠标左键触发扣动扳机}

`项目设置 > Engine > Input > Bindings > Action Mappings` <br/>

| -    |                   |
|------|-------------------|
| 函数描述 | Fire              |
| 键位 | Left Mouse Button |

<img src="/pic/武器/武器组件/键位绑定.png" width="500" /> <br/> <br/>


### 武器组件提供回调函数: 调用武器Fire接口 {#武器组件提供回调函数-调用武器fire接口}

`C++`       <br/>


#### 为武器类添加Fire接口 {#为武器类添加fire接口}

具体类型武器派生自STUBaseWeapon, 各自对Fire的实现不同. 将Fire定义为虚函数, 打印日志 <br/>

1.  `ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
    `public` <br/>
    ```cpp
    virtual void Fire();
    ```
2.  `ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
    ```cpp
    DEFINE_LOG_CATEGORY_STATIC(LogBaseWeapon, All, All);
    
    void ASTUBaseWeapon::Fire()
    {
        UE_LOG(LogBaseWeapon, Display, TEXT("Fire!"));
    }
    ```


#### 回调函数 {#回调函数}

1.  `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    `public` <br/>
    ```cpp
    void Fire();            
    ```
2.  `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    void USTUWeaponComponent::Fire()
    {
        if (!CurrentWeapon) return;
        CurrentWeapon->Fire();
    }
    ```


#### 绑定绑定函数描述和回调函数 {#绑定绑定函数描述和回调函数}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

1.  检查组件初始化 <br/>
    ```cpp
    // BeginPlay
    check(WeaponComponent);           
    ```
2.  绑定 <br/>
    ```cpp
    // SetupPlayerInputComponent
    PlayerInputComponent->BindAction("Fire", IE_Pressed, WeaponComponent, &USTUWeaponComponent::Fire);
    ```


### 查看 {#查看}

点击鼠标左键, 输出日志 <br/>

<img src="/pic/武器/武器组件/开火.png" width="800" /> <br/> <br/>

