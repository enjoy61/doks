---
title: "武器组件"
date: 2023-06-25T16:42:52
lastmod: 2023-08-12T14:36:55+08:00
draft: false
weight: 1004
---

## 概览 {#概览}

1.  前提概要 <br/>
    给游戏角色装载武器时, 先动态生成武器Actor, 之后附加到HeroTPP的WeaponSocket <br/>
2.  武器类 <br/>
    添加 `fire` 接口, 对应扣动扳机逻辑 <br/>
    之后会有 `shoot` 接口，在 `fire` 中调用；二者关联是，机关枪扣动一次扳机，可以连发数枪 <br/>
3.  武器组件 `STUWeaponComponent` <br/>
    -   将 `SpawnWeapon` 逻辑移到这里 <br/>
    -   包括开火 `Fire` 逻辑: 调用 `STUBaseWeapon>Fire` 接口 <br/>
    -   还有更换武器, 装弹逻辑 <br/>
4.  Character <br/>
    绑定键位: 点击鼠标左键, 调用 `STUWeaponComponent>Fire` 接口 <br/>


## 创建STUWeaponComponent {#创建stuweaponcomponent}

1.  创建STUWeaponComponent <br/>
    `虚幻编辑器` <br/>
    
    | -              |
    |----------------|
    | ActorComponent |
    | Public         |
    | Components     |
2.  调整STUWeaponComponent结构 <br/>
    `C++` <br/>
    
    | -             |            |
    |---------------|------------|
    | 构造函数      | 每帧调用置false |
    | TickComponent | 屏蔽       |
    
    `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>


## 重构: 移动SpawnWeapon逻辑 {#重构-移动spawnweapon逻辑}

`C++` <br/>


### 在STUWeaponComponent中实现SpawnWeapon {#在stuweaponcomponent中实现spawnweapon}


#### 添加数据成员 {#添加数据成员}

`ShootThemUp: Components/STUWeaponComponent.h`         <br/>

1.  相关数据成员 <br/>
    `protected` <br/>
    ```cpp
    class ASTUBaseWeapon;
    
    UPROPERTY(EditDefaultsOnly)
    TSubclassOf<ASTUBaseWeapon> WeaponClass;
    ```
2.  保存Socket名 <br/>
    `protected` <br/>
    ```cpp
    UPROPERTY(EditDefaultsOnly)
    FName WeaponAttachPointName = "WeaponSocket";
    ```
3.  保存武器Actor <br/>
    `private` <br/>
    所有的指针需要使用UPROPERTY宏标识, 否则Garbage Collector不会维护该指针管理的内存 <br/>
    ```cpp
    UPROPERTY()
    ASTUBaseWeapon *CurrentWeapon= nullptr;
    ```


#### 添加函数成员 {#添加函数成员}

1.  声明 <br/>
    `private` <br/>
    `ShootThemUp: Components/STUWeaponComponent.h`            <br/>
    ```cpp
    void SpawnWeapon();
    ```
2.  定义 <br/>
    处理不正确则退出: 统一结构, 减少缩进 <br/>
    `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    #include "Engine/World.h"
    #include "Components/SkeletalMeshComponent.h"
    #include "Weapon/STUBaseWeapon.h"
    #include "GameFramework/Character.h"
    
    void USTUWeaponComponent::SpawnWeapon()
    {
        if (!GetWorld()) return;
    
        ACharacter *Character = Cast<ACharacter>(GetOwner());
        if (!Character) return;
    
        CurrentWeapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(WeaponClass);
    
        if (!CurrentWeapon) return;
    
        FAttachmentTransformRules AttachmentRules(EAttachmentRule::SnapToTarget, false);
        CurrentWeapon->AttachToComponent(Character->GetMesh(), AttachmentRules, "WeaponSocket");
    }
    ```


#### 调用SpawnWeapon {#调用spawnweapon}

```cpp
//BeginPlay
SpawnWeapon();
```


### 移除STUBaseCharacter的SpawnWeapon {#移除stubasecharacter的spawnweapon}

1.  `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    -   STUBaseWeapon前向声明 <br/>
    -   WeaponClass成员 <br/>
    -   SpawnWeapon声明 <br/>
2.  `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    -   头文件: STUBaseWeapon, World, SkeletalMeshComponent <br/>
    -   BeginPlay中调用SpawnWeapon <br/>
    -   SpawnWeapon <br/>


## 为Character添加WeaponComponent {#为character添加weaponcomponent}

`C++` <br/>
纯逻辑组件, 不用SetupAttachment <br/>

1.  添加数据成员 <br/>
    `protected` <br/>
    `ShootThemUp: Player/STUBaseCharacter.h` <br/>
    ```cpp
    class USTUWeaponComponent;
    
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    USTUWeaponComponent *WeaponComponent;
    ```
2.  初始化组件 <br/>
    `ShootThemUp: Player/STUBaseCharacter.cpp` <br/>
    ```cpp
    #include "Components/STUWeaponComponent.h"
    
    // 构造函数
    WeaponComponent = CreateDefaultSubobject<USTUWeaponComponent>("WeaponComponent");
    ```


## 查看武器绑定 {#查看武器绑定}

`虚幻编辑器` <br/>

1.  `BP_STUBaseCharacter > Weapon Component > Weapon Class: 设置为BP_STUBaseWeapon` <br/>
2.  效果图 <br/>
    
    <img src="/pic/武器/武器组件/重构.png" width="800" /> <br/> <br/>
    
    和之前效果一致 <br/>


## 实现扣动扳机 {#实现扣动扳机}


### STUBaseWeapon实现Fire接口 {#stubaseweapon实现fire接口}

虚函数, 会有STUBaseWeapon的派生类, 而派生类的开火方式不同. 之后会实现射击(Shoot)逻辑, 此时打印日志 <br/>

1.  声明 <br/>
    `public` <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
    ```cpp
    virtual void Fire();
    ```
2.  定义 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
    ```cpp
    DEFINE_LOG_CATEGORY_STATIC(LogBaseWeapon, All, All);
    
    void ASTUBaseWeapon::Fire()
    {
        UE_LOG(LogBaseWeapon, Display, TEXT("Fire!"));
    }
    ```


### 绑定键位: 扣动扳机 {#绑定键位-扣动扳机}

`项目设置 > Engine > Input > Bindings > Action Mappings` <br/>

| -    |                   |
|------|-------------------|
| 函数描述 | Fire              |
| 键位 | Left Mouse Button |

<img src="/pic/武器/武器组件/键位绑定.png" width="500" /> <br/> <br/>


### STUWeaponComponent实现回调函数 {#stuweaponcomponent实现回调函数}

1.  声明 <br/>
    `public` <br/>
    `ShootThemUp: Components/STUWeaponComponent.h` <br/>
2.  定义 <br/>
    `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    void USTUWeaponComponent::Fire()
    {
        if (!CurrentWeapon) return;
        CurrentWeapon->Fire();
    }
    ```


### 为游戏角色绑定函数描述和回调函数 {#为游戏角色绑定函数描述和回调函数}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

1.  检查组件初始化 <br/>
    ```cpp
    // BeginPlay
    check(WeaponComponent);           
    ```
2.  绑定 <br/>
    ```cpp
    // SetupPlayerInputComponent
    PlayerInputComponent->BindAction("Fire", IE_Pressed, WeaponComponent, &USTUWeaponComponent::Fire);
    ```


### 查看扣动扳机 {#查看扣动扳机}

点击鼠标左键, 输出日志 <br/>

<img src="/pic/武器/武器组件/开火.png" width="800" /> <br/> <br/>

