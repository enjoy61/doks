---
title: "武器派生类"
date: 2023-08-19T16:32:12
lastmod: 2023-08-19T21:46:54+08:00
draft: false
weight: 1012
---

## 说明 {#说明}

-   当前的STUBaseWeapon类基本实现了Rifle的逻辑, Launcher无连续射击和瞄准偏离逻辑 <br/>
-   创建STUBaseWeapon的派生类STURifleWeapon和STULauncherWeapon, 把Rifle的逻辑移动到STURifleWeapon, 使STUBaseWeapon成为一个武器意义上的抽象类 <br/>

|     |          | 武器类            |
|-----|----------|----------------|
| 基类 |          | STUBaseWeapon     |
| 派生类 | Rifle    | STURifleWeapon    |
|     | Launcher | STULauncherWeapon |


## 概览 {#概览}

-   [X] 创建派生自STUBaseWeapon的C++类: STURifleWeapon和STULauncherWeapon <br/>
-   [X] 调整STUBaseWeapon逻辑 <br/>
-   [X] 将Rifle的逻辑拷贝到STURifleWeapon <br/>
-   [X] 创建基于STURifleWeapon和STULauncherWeapon的蓝图类, 并为之绑定武器模型 <br/>
-   [X] 验证Rifle逻辑正常 <br/>


## 创建派生自STUBaseWeapon的C++类 {#创建派生自stubaseweapon的c-plus-plus-类}

|                   | 类别   | 上级文件夹 |
|-------------------|------|-------|
| STURifleWeapon    | Public | Weapon |
| STULauncherWeapon | Public | Weapon |

在内容浏览器选中C++ Classes &gt; ShootThemUp &gt; Public &gt; Weapon &gt; STUBaseWeapon, 右键 <br/>

<img src="/pic/武器/武器派生类/C++派生类.png" width="350" /> <br/> <br/>

<img src="/pic/武器/武器派生类/派生类.png" width="700" /> <br/> <br/>


## 调整STUBaseWeapon逻辑 {#调整stubaseweapon逻辑}


### 屏蔽连续射击 {#屏蔽连续射击}

1.  屏蔽射击定时器和时间间隔 <br/>
2.  将MakeShot声明为虚函数, 定义为空 <br/>
3.  将FireStart和FireStop定义为空 <br/>


### 屏蔽瞄准偏离 {#屏蔽瞄准偏离}

1.  将GetTraceData定义为虚函数, 屏蔽瞄准偏离逻辑 <br/>
2.  屏蔽圆锥偏移角参数 <br/>


### 屏蔽头文件 {#屏蔽头文件}

```cpp
// #include "DrawDebugHelpers.h"
// #include "TimerManager.h"
```


## 将STUBaseWeapon屏蔽的Rifle逻辑拷贝到STURifleWeapon {#将stubaseweapon屏蔽的rifle逻辑拷贝到sturifleweapon}


### 连续射击 {#连续射击}

1.  定义射击定时器和时间间隔 <br/>
    `ShootThemUp: Weapon/STURifleWeapon.h` <br/>
    -   `protected` <br/>
        ```cpp
        UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
        float TimeBetweenShots = 0.1f;
        ```
    -   `private` <br/>
        ```cpp
        FTimerHandle ShotTimerHandle;
        ```
2.  覆写虚函数MakeShot <br/>
    -   `ShootThemUp: Weapon/STURifleWeapon.h` <br/>
        `protected` <br/>
        ```cpp
        virtual void MakeShot() override;
        ```
    -   `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
        ```cpp
        #include "Engine/World.h"
        #include "DrawDebugHelpers.h"
        
        void ASTURifleWeapon::MakeShot()
        {
            if (!GetWorld()) return;
        
            FVector TraceStart, TraceEnd;
            if (!GetTraceData(TraceStart, TraceEnd)) return;         
        
            FHitResult HitResult;
            MakeHit(HitResult, TraceStart, TraceEnd);
        
            if (HitResult.bBlockingHit)
            {
                DrawDebugLine(GetWorld(), GetMuzzleWorldLocation(), HitResult.ImpactPoint, FColor::Red, false, 3.0f, 0, 3.0f);
                DrawDebugSphere(GetWorld(), HitResult.ImpactPoint, 10.0f, 24, FColor::Red, false, 5.0f);
                MakeDamage(HitResult);
            }
            else
            {
                DrawDebugLine(GetWorld(), GetMuzzleWorldLocation(), TraceEnd, FColor::Red, false, 3.0f, 0, 3.0f);
            }
        }
        ```
3.  覆写FireStart和FireStop <br/>
    -   `ShootThemUp: Weapon/STURifleWeapon.h` <br/>
        `public` <br/>
        ```cpp
        virtual void FireStart() override;
        virtual void FireStop() override;
        ```
    -   `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
        ```cpp
        #include "TimerManager.h"
        
        void ASTURifleWeapon::FireStart()
        {
            MakeShot();
            GetWorldTimerManager().SetTimer(ShotTimerHandle, this, &ASTURifleWeapon::MakeShot, TimeBetweenShots, true);
        }
        
        void ASTURifleWeapon::FireStop()
        {
            GetWorldTimerManager().ClearTimer(ShotTimerHandle);
        }
        ```


### 瞄准偏离 {#瞄准偏离}

1.  定义偏移角 <br/>
    `protected` <br/>
    `ShootThemUp: Weapon/STURifleWeapon.cpp`          <br/>
    ```cpp
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    float BulletSpread = 1.5f;
    ```
2.  覆写GetTraceData <br/>
    -   `ShootThemUp: Weapon/STURifleWeapon.h`          <br/>
        `protected` <br/>
        ```cpp
        virtual void GetTraceData(FVector& TraceStart, FVector& TraceEnd) const override;
        ```
    -   `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
        ```cpp
        bool ASTURifleWeapon::GetTraceData(FVector& TraceStart, FVector& TraceEnd) const
        {
            FVector ViewLocation;
             FRotator ViewRotation;
            if (!GetPlayerViewPoint(ViewLocation, ViewRotation)) return false;
        
            TraceStart = ViewLocation;
        
            const auto HalfRad = FMath::DegreesToRadians(BulletSpread);
            const FVector ShootDirection = FMath::VRandCone(ViewRotation.Vector(), HalfRad);
        
            TraceEnd = TraceStart + ShootDirection * TraceMaxDistance;
            return true;
        }
        ```


## 创建基于STURifleWeapon和STULauncherWeapon的蓝图类 {#创建基于sturifleweapon和stulauncherweapon的蓝图类}

保存到Content/Weapon/目录下 <br/>

<img src="/pic/武器/武器派生类/蓝图类.png" width="500" /> <br/> <br/>


## 测试BP_STURifleWeapon {#测试bp-sturifleweapon}

1.  为BP_STURifleWeapon绑定武器模型Rifle <br/>
2.  设置游戏角色武器类属性为BP_STURifleWeapon <br/>
3.  功能正常 <br/>


## 测试BP_STULauncherWeapon {#测试bp-stulauncherweapon}

1.  为BP_STULauncherWeapon绑定武器模型Launcher <br/>
2.  设置游戏角色武器类属性为BP_STULauncherWeapon <br/>
3.  武器正常显示, 射击无反应 <br/>
    
    <img src="/pic/武器/武器派生类/Launcher.png" width="800" /> <br/> <br/>

