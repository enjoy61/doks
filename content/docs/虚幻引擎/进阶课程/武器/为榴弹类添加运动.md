---
title: "为榴弹类添加运动"
date: 2023-08-22T22:51:53
lastmod: 2023-08-23T11:04:36+08:00
draft: false
weight: 2014
---

## 说明 {#说明}

-   我们可以在Tick函数中, 根据时间间隔 `Delta` 改变Actor位置; 本节在于介绍榴弹类运动组件 <br/>
-   为榴弹类添加抛物运动组件, 给组件设置速度, 使榴弹对象以恒定速度运动 `UProjectileMovementComponent` <br/>


## 概览 {#概览}

-   [X] 为榴弹类添加抛物运动组件, 并添加相关接口和数据成员 <br/>
-   [X] 重新实现榴弹类创建榴弹对象逻辑 <br/>
-   [X] 在榴弹类中, 计算并配置榴弹运动方向 <br/>
-   [X] 设置榴弹蓝图类抛物运动组件相关参数 <br/>
-   [X] 为榴弹对象添加销毁定时器 <br/>
-   [X] 提供参数期待值 <br/>


## 抛物运动组件 {#抛物运动组件}

`UProjectileMovementComponent` <br/>

-   根据组件参数, 计算Actor位置, 在Tick函数中进行设置 <br/>
-   游戏角色运动逻辑在UCharacterMovementComponent，榴弹类有UProjectileMovementComponent, 二者有共同的基类UMovementComponent, 具有改变Actor在空间中位置的能力 <br/>
-   可以用来实现寻的导弹 `Homing Missile` ; 可以设置与其他物体发生碰撞时的反弹次数 <br/>
-   我们希望榴弹以恒定速度运动, 主要使用以下参数 <br/>
    
    | -                      |                     |
    |------------------------|---------------------|
    | Velocity               | 矢量, 方向 + 标量   |
    | InitialSpeed           | 可配置的初始速度    |
    | ProjectileGravityScale | 默认值为1, 受到重力影响; 设置为0 |
-   注意到InitialSpeed是组件自带的属性, 我们认为所有的运动信息应该储存在运动组件中 <br/>
-   纯逻辑组件 <br/>


## 为榴弹类添加抛物运动组件 {#为榴弹类添加抛物运动组件}


### 添加数据成员存放运动方向 {#添加数据成员存放运动方向}

`private` <br/>
`ShootThemUp: Weapon/STUProjectile.h` <br/>

```cpp
FVector ShotDirection;
```


### 提供设置运动方向的接口 {#提供设置运动方向的接口}

`public` <br/>
`ShootThemUp: Weapon/STUProjectile.h` <br/>

```cpp
void SetShotDirection(const FVector& Direction) { ShotDirection = Direction; }           
```


### 添加抛物运动组件 {#添加抛物运动组件}

`protected` <br/>
`ShootThemUp: Weapon/STUProjectile.h` <br/>

```cpp
class UProjectileMovementComponent;

UPROPERTY(VisibleDefaultsOnly)
UProjectileMovementComponent *MovementComponent;
```


### 初始化抛物运动组件 {#初始化抛物运动组件}

`ShootThemUp: Weapon/STUProjectile.cpp` <br/>

1.  初始化组件 <br/>
    ```cpp
    #include "GameFramework/ProjectileMovementComponent.h"
    
    // Constructor
    MovementComponent = CreateDefaultSubobject<UProjectileMovementComponent>("ProjectileMovementComponent");
    ```
2.  设置速度 <br/>
    ```cpp
    // BeginPlay
    
    check(MovementComponent);
    MovementComponent->Velocity = ShotDirection * MovementComponent->InitialSpeed;
    ```


## 榴弹发射器类的射击逻辑 {#榴弹发射器类的射击逻辑}


### 重新实现动态创建榴弹对象逻辑 {#重新实现动态创建榴弹对象逻辑}

-   UGameplayStatics::BeginDeferredActorSpawnFromClass返回指向Actor对象的指针, 使用Actor派生类对象前需进行转换 <br/>
-   UWorld::SpawnActorDeferred返回指向Actor派生类对象的指针 <br/>
-   屏蔽UGamePlayStatics头文件 <br/>

`ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>

```cpp
if (!GetWorld()) return;

ASTUProjectile *Projectile = GetWorld()->SpawnActorDeferred<ASTUProjectile>(ProjectileClass, SpawnTransform);
if (Projectile)
{
    // 设置Projectile参数
    Projectile->FinishSpawning(SpawnTransform);
}
```


### 设置榴弹对象运动方向 {#设置榴弹对象运动方向}


#### 榴弹真实轨迹 {#榴弹真实轨迹}

参考ASTUBaseWeapon::GetTraceData, 游戏角色Camera组件的位置+旋转 <br/>
`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>


#### 榴弹呈现的运动方向 {#榴弹呈现的运动方向}

-   修改起始位置为枪口, 根据最终位置计算其运动方向 <br/>
-   参考ASTURifleWeapon::MakeShot中绘制子弹轨迹 <br/>
    `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>

| -    |             |
|------|-------------|
| 起点 | 枪口位置    |
| 终点 | 碰撞点或计算得到的终点 |
| 运动方向 | 终点 - 起点 |

1.  计算榴弹运动方向 <br/>
    `ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>
    ```cpp
    // MakeShot
    
    FVector TraceStart, TraceEnd;
    if (!GetTraceData(TraceStart, TraceEnd)) return;         
    
    FHitResult HitResult;
    MakeHit(HitResult, TraceStart, TraceEnd);
    
    const FVector EndPoint = HitResult.bBlockingHit ? HitResult.ImpactPoint : TraceEnd;
    const FVector Direction = (EndPoint - GetMuzzleWorldLocation()).GetSafeNormal();
    ```
2.  设置榴弹对象的运动方向 <br/>
    `ShootThemUp: Weapon/STULauncherWeapon.cpp`           <br/>
    ```cpp
    // MakeShot
    Projectile->SetShotDirection(Direction);
    ```


## 设置BP_STUProjectile {#设置bp-stuprojectile}


### 新增ProjectileMovementComponent {#新增projectilemovementcomponent}

<img src="/pic/武器/为榴弹类添加运动/MovementComponent.png" width="500" /> <br/> <br/>


### InitialSpeed默认值为0, 榴弹发射器射击时, 榴弹做自由落体运动 {#initialspeed默认值为0-榴弹发射器射击时-榴弹做自由落体运动}

<img src="/pic/武器/为榴弹类添加运动/InitialSpeed0.png" width="500" /> <br/> <br/>

<img src="/pic/武器/为榴弹类添加运动/自由落体.png" width="1000" /> <br/> <br/>


### 设置IntialSpeed为2000, 榴弹在垂直方向受到重力的影响 {#设置intialspeed为2000-榴弹在垂直方向受到重力的影响}

MovementComponent &gt; Details &gt; Projectile &gt; Initial Speed, 设置为2000 <br/>

<img src="/pic/武器/为榴弹类添加运动/InitialSpeed2000.png" width="500" /> <br/> <br/>

<img src="/pic/武器/为榴弹类添加运动/抛物线.png" width="1000" /> <br/> <br/>


### ProjectileGravityScale默认为1 {#projectilegravityscale默认为1}

<img src="/pic/武器/为榴弹类添加运动/GravityScale1.png" width="500" /> <br/> <br/>


### 设置ProjectileGravityScale为0, 使榴弹不受重力影响, 可以经过绿色瞄准十字 {#设置projectilegravityscale为0-使榴弹不受重力影响-可以经过绿色瞄准十字}

MovementComponent &gt; Details &gt; Projectile Gravity Scale, 设置为0 <br/>

<img src="/pic/武器/为榴弹类添加运动/GravityScale0.png" width="500" /> <br/> <br/>

<img src="/pic/武器/为榴弹类添加运动/near.png" width="1000" /> <br/> <br/>


### 注意到除非发生碰撞, 榴弹会一直运动 {#注意到除非发生碰撞-榴弹会一直运动}


## 创建榴弹后, 开启销毁定时器 {#创建榴弹后-开启销毁定时器}

`ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>

```cpp
Projectile->SetLifeSpan(5.0f);
```

榴弹创建后5s消失 <br/>


## 在代码中设置抛物运动组件 {#在代码中设置抛物运动组件}

-   开发时, 抛物运动组件有其合适的参数. 为避免在虚幻编辑器做出不当设置, 我们可以在BeginPlay中进行检查 <br/>
-   在这之前, 需要在初始化组件时, 给出期待值 <br/>
    `ShootThemUp: Weapon/STUProjectile.cpp` <br/>
    ```cpp
    // Constructor
    
    MovementComponent->InitialSpeed = 2000.0f;
    MovementComponent->ProjectileGravityScale = 0.0f;
    ```

