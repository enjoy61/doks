---
title: "打包"
date: 2023-10-05T14:49:29
lastmod: 2023-10-06T19:17:49+08:00
draft: false
weight: 2003
---

## 在代码中添加检查 {#在代码中添加检查}

-   使用 `checkf` , 和 `check` 相比, 可以设置提示信息 <br/>
-   使用 `checkNoEntry` , 等价于调用 `check` 返回false; 立即触发断言 `assertion` <br/>


### STUBaseWeapon {#stubaseweapon}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
检查蓝图中设置的子弹数, 要求大于等于0 <br/>
可以使用ClampMin和ClampMax进行元信息 `meta information` 检查 <br/>

之后在蓝图设置错误数值触发检查 <br/>

```cpp
// BeginPlay

checkf(DefaultAmmo.Bullets > 0, TEXT("Bullets count couldn't be less or equal zero"));
checkf(DefaultAmmo.Clips > 0, TEXT("Clips count couldn't be less or equal zero"));
```


### STUWeaponComponent {#stuweaponcomponent}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
定义常量, 检查蓝图中配置的武器个数 <br/>

```cpp
constexpr static int32 WeaponNum = 2;

// BeginPlay
checkf(WeaponData.Num() == 2, TEXT("Our character can hold only %d weapon items"), WeaponNum);
```


### AnimNotify {#animnotify}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
未在轨道中添加AnimNotify事件(找不到Notify)时, 输出日志, 并调用宏 `checkNoEntry` <br/>

```cpp
// InitAnimations

if (EquipFinishedNotify)
{
    // ...
}
else
{
    UE_LOG(LogWeaponComponent, Error, TEXT("Equip anim notify is forgetten to set"));
    checkNoEntry();
}

if (ReloadFinishedNotify)
{
    // ...
}
else
{
    UE_LOG(LogWeaponComponent, Error, TEXT("Reload anim notify is forgetten to set"));
    checkNoEntry();
}
```


## 添加头文件AnimUtils.h {#添加头文件animutils-dot-h}

-   在Public/Animations/添加AnimUtils.h <br/>
-   纯辅助, 实用类, 供动画相关类使用 <br/>


### 屏蔽FindNotifyByClass的定义和相关头文件 {#屏蔽findnotifybyclass的定义和相关头文件}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
#include "Animation/AnimSequenceBase.h"
```


### 定义AnimUtils类 {#定义animutils类}

`ShootThemUp: Animations/AnimUtils.h` <br/>
声明为静态函数(不依赖具体类对象) <br/>

```cpp
#pragma once

#include "Animation/AnimSequenceBase.h"        
class AnimUtils
{
    public:
    template<typename T>
    static T* FindNotifyByClass(UAnimSequenceBase *Animation)
    {
        if (!Animation) return nullptr;

        const auto NotifyEvents = Animation->Notifies;
        for (auto NotifyEvent : NotifyEvents)
        {
            auto AnimNotify = Cast<T>(NotifyEvent.Notify);
            if (AnimNotify)
            {
                return AnimNotify;
            }
        }
        return nullptr;
    }
};
```


### 使用 {#使用}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

-   添加头文件 <br/>
    ```cpp
    #include "Animations/AnimUtils.h"
    ```
-   使用FindNotifyByClass时给出所属类名 <br/>


## 添加头文件STUCoreTypes.h {#添加头文件stucoretypes-dot-h}

-   在Public/添加STUCoreTypes.h <br/>
-   将别处定义的数据结构和委托类型整合, 标注使用的地方; 可以按WeaponTypes, HealthTypes进行分类 <br/>
-   修改后在头文件中包含STUCoreTypes.h <br/>


### STUBaseWeapon {#stubaseweapon}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

-   FOnClipEmptySignature <br/>
-   FAmmoData <br/>


### STUWeaponComponent {#stuweaponcomponent}

`ShootThemUp: Components/STUWeaponComponent.h` <br/>

-   FWeaponData <br/>
    ```cpp
    #include "Templates/SubclassOf.h"
    class ASTUBaseWeapon;
    class UAnimMontage;
    ```


### STUHealthComponent {#stuhealthcomponent}

`ShootThemUp: Components/STUHealthComponent.h` <br/>

-   FOnDeathSignature <br/>
-   FOnHealthChangedSignature <br/>


### 为了让UHT正确生成数据结构、委托类型宏相关的所有代码, 添加头文件声明 {#为了让uht正确生成数据结构-委托类型宏相关的所有代码-添加头文件声明}

格式 "filename.generated.h" <br/>
`ShootThemUp:STUCoreTypes.h` <br/>

```cpp
#include "STUCoreTypes.generated.h"
```


## 验证 {#验证}


### 将Content/Weapon/BP_STURifleWeapon &gt; Default Ammo &gt; Bullets设-1 {#将content-weapon-bp-sturifleweapon-default-ammo-bullets设-1}

=&gt; 程序崩溃: 触发断言并输出日志 <br/>

<img src="/pic/武器/打包/子弹个数日志.png" width="1000" /> <br/> <br/>

恢复 <br/>


### 删除Content/Player/Animations/AM_Equip中的STUEquipFinishedAnimNotify {#删除content-player-animations-am-equip中的stuequipfinishedanimnotify}

=&gt; 程序崩溃: 触发checkNoEntry <br/>

<img src="/pic/武器/打包/没有在轨道中添加通知事件.png" width="1000" /> <br/> <br/>

恢复 <br/>


## 打包游戏 {#打包游戏}

-   `工具栏 > Platforms > Mac, 选择DebugGame, 可以看见日志` <br/>
-   `工具栏 > Platforms > Mac > Package Project` <br/>

