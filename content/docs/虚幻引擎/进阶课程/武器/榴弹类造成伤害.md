---
title: "榴弹类造成伤害"
date: 2023-08-25T20:45:06
lastmod: 2023-08-26T18:51:53+08:00
draft: false
weight: 2015
---

## 说明 {#说明}

-   榴弹发生碰撞时对爆炸半径内Actor造成伤害 <br/>
-   可以在榴弹发射器中定义伤害相关参数, 如ShotDirection那样对榴弹进行设置; 选择直接在榴弹类中定义 <br/>


## 概览 {#概览}

-   [X] 重构武器 <br/>
-   [X] 注册碰撞委托, 在处理函数中对伤害半径内Actor造成伤害 <br/>


## 重构武器 {#重构武器}


### 可配置参数的蓝图属性为EditDefaultsOnly {#可配置参数的蓝图属性为editdefaultsonly}

1.  `ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
    VisiableAnywhere -&gt; EditDefaultsOnly <br/>
    
    | -                |
    |------------------|
    | DamageAmount     |
    | TraceMaxDistance |
    | MuzzleSocketName |
2.  `ShootThemUp: Weapon/STURifleWeapon.h` <br/>
    VisiableAnywhere -&gt; EditDefaultsOnly <br/>
    
    | -                |
    |------------------|
    | TimeBetweenShots |
    | BulletSpread     |


### 组件在原型和实例中均可见 {#组件在原型和实例中均可见}

VisibleDefaultsOnly -&gt; VisibleAnywhere <br/>
`ShootThemUp: Weapon/STUProjectile.h` <br/>

| -                  |
|--------------------|
| CollisionComponent |
| MovementComponent  |


### ASTUBaseWeapon::MakeDamage是STURifleWeapon的专属逻辑 {#astubaseweapon-makedamage是sturifleweapon的专属逻辑}

将ASTUBaseWeapon::MakeDamage移动到Rifle <br/>

1.  移动数据成员 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.h` -&gt; `ShootThemUp: Weapon/STURifleWeapon.h` <br/>
    ```cpp
    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    float DamageAmount = 10.0f;
    ```
2.  移动函数声明 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.h` -&gt; `ShootThemUp: Weapon/STURifleWeapon.h` <br/>
    `protected` <br/>
    ```cpp
    void MakeDamage(const FHitResult& HitResult);                    
    ```
3.  移动函数定义 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
    ```cpp
    void ASTUBaseWeapon::MakeDamage(const FHitResult &HitResult)
    {
        const auto DamagedActor = HitResult.GetActor();
        if (!DamagedActor) return;
        DamagedActor->TakeDamage(DamageAmount, FDamageEvent(), GetPlayerController(), this);
    }
    ```
    `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
    ```cpp
    #include "GameFramework/PlayerController.h" // TakeDamage的参数是AController
    
    void ASTURifleWeapon::MakeDamage(const FHitResult &HitResult)
    {
        const auto DamagedActor = HitResult.GetActor();
        if (!DamagedActor) return;
        DamagedActor->TakeDamage(DamageAmount, FDamageEvent(), GetPlayerController(), this);
    }
    ```


### 将榴弹延时销毁逻辑从榴弹发射器类移动到榴弹类, 并添加参数 {#将榴弹延时销毁逻辑从榴弹发射器类移动到榴弹类-并添加参数}

1.  添加数据成员 <br/>
    `protected` <br/>
    `ShootThemUp: Weapon/STUProjectile.h` <br/>
    ```cpp
    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    float LifeSeconds = 5.0f;
    ```
2.  在BeginPlay中销毁榴弹 <br/>
    `ShootThemUp: Weapon/STUProjectile.cpp` <br/>
    ```cpp
    SetLifeSpan(LifeSeconds);           
    ```
3.  屏蔽榴弹发射器中的销毁逻辑 <br/>
    `ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>


## 榴弹发生碰撞时, 对半径内Actor造成伤害 {#榴弹发生碰撞时-对半径内actor造成伤害}

1.  注册碰撞委托, 调用处理函数 <br/>
2.  处理函数中, 绘制爆炸半径, 并对半径内Actor造成伤害, 参照STUDevDamageActor <br/>
    `ShootThemUp: Dev/STUDevDamageActor.cpp` <br/>


### 注册碰撞委托 {#注册碰撞委托}


#### 给出处理函数声明, 根据委托定义 {#给出处理函数声明-根据委托定义}

1.  委托定义 <br/>
    `UE_5.1/Engine/Source/Runtime/Engine/Classes/Components/PrimitiveComponent.h` `184` <br/>
    ```cpp
    DECLARE_DYNAMIC_MULTICAST_SPARSE_DELEGATE_FiveParams( FComponentHitSignature, UPrimitiveComponent, OnComponentHit, UPrimitiveComponent*, HitComponent, AActor*, OtherActor, UPrimitiveComponent*, OtherComp, FVector, NormalImpulse, const FHitResult&, Hit );
    ```
2.  处理函数声明 <br/>
    `private` <br/>
    `ShootThemUp: Weapon/STUProjectile.h` <br/>
    ```cpp
    UFUNCTION()
    void OnProjectileHit(UPrimitiveComponent* HitComponent, AActor* OtherActor, UPrimitiveComponent* OtherComp, FVector NormalImpulse, const FHitResult& Hit);
    ```
3.  给出空定义 <br/>
    `ShootThemUp: Weapon/STUProjectile.cpp` <br/>
    ```cpp
    void ASTUProjectile::OnProjectileHit(UPrimitiveComponent* HitComponent, AActor* OtherActor, UPrimitiveComponent* OtherComp, FVector NormalImpulse, const FHitResult& Hit) {}
    ```


#### 注册委托 {#注册委托}

1.  委托成员 <br/>
    `UE_5.1/Engine/Source/Runtime/Engine/Classes/Components/PrimitiveComponent.h` `1189` <br/>
    ```cpp
    // 
    //	Event called when a component hits (or is hit by) something solid. This could happen due to things like Character movement, using Set Location with 'sweep' enabled, or physics simulation.
    //	For events when objects overlap (e.g. walking into a trigger) see the 'Overlap' event.
    //
    //	@note For collisions during physics simulation to generate hit events, 'Simulation Generates Hit Events' must be enabled for this component.
    //	@note When receiving a hit from another object's movement, the directions of 'Hit.Normal' and 'Hit.ImpactNormal'
    //	will be adjusted to indicate force from the other object against this object.
    //	@note NormalImpulse will be filled in for physics-simulating bodies, but will be zero for swept-component blocking collisions.
    //
    UPROPERTY(BlueprintAssignable, Category="Collision")
    FComponentHitSignature OnComponentHit;
    ```
2.  注册委托 <br/>
    `ShootThemUp: Weapon/STUProjectile.cpp` <br/>
    ```cpp
    // BeginPlay
    
    check(CollisionComponent);
    
    CollisionComponent->OnComponentHit.AddDynamic(this, &ASTUProjectile::OnProjectileHit);
    ```


#### 为榴弹设置上级 {#为榴弹设置上级}

1.  动态生成榴弹对象时, 设置上级为游戏角色 <br/>
2.  不对发射榴弹的游戏角色造成伤害 <br/>
3.  不与发射榴弹的游戏角色发生碰撞 <br/>

`ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>

```cpp
Projectile->SetOwner(GetOwner());
```


#### 设置碰撞组件 {#设置碰撞组件}

`ShootThemUp: Weapon/STUProjectile.cpp`        <br/>

1.  仅在计算轨迹时发生碰撞 <br/>
    ```cpp
    // Constructor
    CollisionComponent->SetCollisionEnabled(ECollisionEnabled::QueryOnly);
    ```
2.  和所有通道发生碰撞 <br/>
    ```cpp
    // Constructor
    CollisionComponent->SetCollisionResponseToAllChannels(ECollisionResponse::ECR_Block);                 
    ```
3.  不与发射榴弹的游戏角色发生碰撞 <br/>
    ```cpp
    // BeginPlay
     CollisionComponent->IgnoreActorWhenMoving(GetOwner(), true);
    ```


### 实现处理函数: 对爆炸半径内Actor造成伤害 {#实现处理函数-对爆炸半径内actor造成伤害}


#### 伤害参数 {#伤害参数}

| -         |              |
|-----------|--------------|
| 伤害半径  | DamageRadius |
| 伤害数值  | DamageAmount |
| 伤害计算模型 | DoFullDamage |
| 伤害来源  |              |
| 忽略Actor列表 |              |


#### 添加数据成员, 存放伤害参数 {#添加数据成员-存放伤害参数}

`protected` <br/>
`ShootThemUp: Weapon/STUProjectile.h` <br/>

```cpp
UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
float DamageRadius = 200.0f;

UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
float DamageAmount = 50.0f;

UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
bool DoFullDamage = false;
```


#### 实现函数, 返回游戏角色控制器 {#实现函数-返回游戏角色控制器}

1.  `ShootThemUp: Weapon/STUProjectile.h` <br/>
    `private` <br/>
    ```cpp
    AController* GetController() const;
    ```
2.  `ShootThemUp: Weapon/STUProjectile.cpp` <br/>
    ```cpp
    AController* ASTUProjectile::GetController() const
    {
        const auto Pawn = Cast<APawn>(GetOwner());
        return Pawn ? Pawn->GetController() : nullptr;
    }
    ```


#### 实现处理函数 {#实现处理函数}

`ShootThemUp: Weapon/STUProjectile.cpp` <br/>

1.  发生碰撞时, 榴弹不再运动 <br/>
    通过将运动速度设为0实现; 联想到游戏角色死亡后调用DisableMovement <br/>
    ```cpp
    MovementComponent->StopMovementImmediately();
    ```
2.  绘制爆炸范围 <br/>
    ```cpp
    #include "DrawDebugHelpers.h"
    
    if (!GetWorld()) return;
    DrawDebugSphere(GetWorld(),
                    GetActorLocation(),
                    DamageRadius,
                    24,
                    FColor::Red,
                    false,
                    5.0f);
    ```
3.  对爆炸半径内Actor造成伤害 <br/>
    排除榴弹上级 <br/>
    ```cpp
    #include "Kismet/GameplayStatics.h"
    #include "GameFramework/DamageType.h"
    
    UGameplayStatics::ApplyRadialDamage(GetWorld(), DamageAmount, GetActorLocation(), DamageRadius, UDamageType::StaticClass(), { GetOwner() }, this, GetController(), DoFullDamage);            
    ```
4.  销毁榴弹对象 <br/>
    ```cpp
    Destroy();
    ```


## 查看 {#查看}

1.  无法伤害自己: 打地上 <br/>
    
    <img src="/pic/武器/榴弹类造成伤害/游戏角色免伤.png" width="600" /> <br/> <br/>
2.  根据到球心的距离造成伤害 <br/>
    
    <img src="/pic/武器/榴弹类造成伤害/伤害计算模型.png" width="1000" /> <br/> <br/>
3.  对处在爆炸半径内的游戏角色, 同时造成伤害 <br/>
    
    <img src="/pic/武器/榴弹类造成伤害/同时造成伤害.png" width="600" /> <br/> <br/>

