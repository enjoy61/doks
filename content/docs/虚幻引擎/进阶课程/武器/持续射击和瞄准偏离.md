---
title: "持续射击和瞄准偏离"
date: 2023-08-19T14:23:46
lastmod: 2023-08-19T16:17:05+08:00
draft: false
weight: 1011
---

## 说明 {#说明}

-   当前 <br/>
    按下鼠标左键触发武器组件的回调函数, 其会调用武器的Fire接口; 只发射一次子弹 <br/>
-   为发射子弹添加定时器, 鼠标左键未松开时, 开启定时器, 进行持续射击, 松开鼠标左键, 关闭定时器 <br/>


## 概览 {#概览}

-   [X] 恢复Camera组件位置 <br/>
-   [X] 为武器发射子弹添加定时器 <br/>
-   [X] 修改武器组件和游戏角色相关逻辑 <br/>
-   [X] 实现瞄准偏离 <br/>


## 恢复Camera组件位置, 使之拍摄游戏角色背面 {#恢复camera组件位置-使之拍摄游戏角色背面}

`BP_STUBaseCharacter` <br/>

1.  设置Camera组件变换属性 <br/>
    `Camera > Details > Transform > Rotation > Yaw = 0` <br/>
    
    <img src="/pic/武器/持续射击和瞄准偏离/Camera.png" width="900" /> <br/> <br/>
2.  在SpringArm组件细节面板设置Camera组件的Socket Offset <br/>
    `SpringArm > Details > Camera > Socket Offset > X = 0 Y = 100` <br/>
    
    <img src="/pic/武器/持续射击和瞄准偏离/SpringArm.png" width="900" /> <br/> <br/>


## 持续射击 {#持续射击}


### 修改武器发射子弹逻辑 {#修改武器发射子弹逻辑}


#### Stub {#stub}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

1.  定时器 <br/>
    `private` <br/>
    ```cpp
    FTimerHandle ShotTimerHandle;
    ```
2.  定时器间隔 <br/>
    `protected` <br/>
    ```cpp
    UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
    float TimeBetweenShots = 0.1f;
    ```
3.  回调函数使用MakeShot <br/>


#### 添加FireStart和FireStop接口 {#添加firestart和firestop接口}

`public` <br/>
`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
virtual void FireStart();
virtual void FireStop();
```


#### 设置定时器 {#设置定时器}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
#include "TimerManager.h"
void ASTUBaseWeapon::FireStart()
{
    MakeShot();
    GetWorldTimerManager().SetTimer(ShotTimerHandle, this, &ASTUBaseWeapon::MakeShot, TimeBetweenShots, true);
}

void ASTUBaseWeapon::FireStop()
{
    GetWorldTimerManager().ClearTimer(ShotTimerHandle);
}
```


#### 移除Fire接口 {#移除fire接口}


### 修改武器组件发射子弹逻辑 {#修改武器组件发射子弹逻辑}


#### 添加回调函数FireStart和FireStop {#添加回调函数firestart和firestop}

`public` <br/>
`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
void FireStart();
void FireStop();
```


#### 调用武器的FireStart和FireStop接口 {#调用武器的firestart和firestop接口}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
void USTUWeaponComponent::FireStart()
{
    if (!CurrentWeapon) return;
    CurrentWeapon->FireStart();
}

void USTUWeaponComponent::FireStop()
{
    if (!CurrentWeapon) return;
    CurrentWeapon->FireStop();
}
```


#### 移除Fire接口 {#移除fire接口}


### 修改扣动扳机按键绑定 {#修改扣动扳机按键绑定}

屏蔽对武器组件Fire接口的绑定, 重新绑定武器组件的FireStart和FireStop接口 <br/>
`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
PlayerInputComponent->BindAction("Fire", IE_Pressed, WeaponComponent, &USTUWeaponComponent::FireStart);
PlayerInputComponent->BindAction("Fire", IE_Released, WeaponComponent, &USTUWeaponComponent::FireStop);
```


## 瞄准目标时, 添加轻微偏离 {#瞄准目标时-添加轻微偏离}


### 建模 {#建模}

设想一个圆锥, 给出中心线和偏移角(顶角的一半), 随机返回圆锥内射线, 作为射击方向 <br/>


### 添加偏移角 {#添加偏移角}

`protected` <br/>
`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
UPROPERTY(VisibleAnywhere, BlueprintReadWrite)
float BulletSpread = 1.5f;
```


### 修改射击方向 {#修改射击方向}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
// GetTraceData

const auto HalfRad = FMath::DegreesToRadians(BulletSpread);
const FVector ShootDirection = FMath::VRandCone(ViewRotation.Vector(), HalfRad);
```


## 查看 {#查看}

1.  按下鼠标左键数秒, 不移动鼠标, 子弹轨迹成束 <br/>
    
    <img src="/pic/武器/持续射击和瞄准偏离/Shot.png" width="900" /> <br/> <br/>

2.  遗留问题: 游戏角色射击时死亡, 射击定时器未关闭 <br/>
    -   测试方法: 在模拟榴弹爆炸的球内进行持续射击; 在MakeShot添加进入打印 <br/>
    -   进入MakeShot函数后, 因为游戏角色已被销毁, 不会继续处理 <br/>

