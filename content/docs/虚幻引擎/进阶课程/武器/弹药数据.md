---
title: "弹药数据"
date: 2023-08-28T21:22:27
lastmod: 2023-09-07T14:00:09+08:00
draft: false
weight: 2020
---

## 概览 {#概览}

-   [X] 在武器类所属源文件中定义数据结构, 存放弹药数据 <br/>
-   [X] 在武器类中添加数据结构, 保存弹药规格和数据 <br/>
-   [X] 使用武器时, 更新弹药库存, 无存货停止射击 <br/>
-   [X] 无弹药时, 关闭步枪连续射击定时器 <br/>


## 定义弹药数据结构体 {#定义弹药数据结构体}

两种使用场景: 当前弹药数据; 弹药规格 / 初始值 <br/>

|       | Infinite配置 |
|-------|------------|
| 步枪  | true       |
| 榴弹发射器 | false      |


### 步枪 {#步枪}

|          | 当前弹药数据               | 弹药规格 / 初始值 |
|----------|----------------------|------------|
| Bullets  | 弹夹中的子弹数             | 弹夹中的子弹上限 |
| Infinite | 无限模式                   |            |
| Clips    | 只在Infinite为false时使用; 弹夹或个数 |            |


### 榴弹发射器 {#榴弹发射器}

|          | 当前弹药数据              |
|----------|---------------------|
| Bullets  | -                         |
| Infinite | 无限模式                  |
| Clips    | 只在Infinite为false时使用; 弹药个数 |


### 定义结构体 {#定义结构体}

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
USTRUCT(BlueprintType)
struct FAmmoData
{
    GENERATED_USTRUCT_BODY()

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    int32 Bullets;

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)
    bool Infinite;

    UPROPERTY(EditDefaultsOnly, BlueprintReadWrite, meta = (EditConditon = (!Infinite)))
    int32 Clips;
};
```


### 添加数据成员 {#添加数据成员}

| -           |            |
|-------------|------------|
| DefaultAmmo | 弹药规格 / 初始值 |
| CurrentAmmo | 当前弹药数据 |

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
// protected
UPROPERTY(EditDefaultsOnly, BlueprintReadWrite)       
FAmmoData DefaultAmmo {15, 10, false};

// private
FAmmoData CurrentAmmo;
```


### 设置弹药初始值 {#设置弹药初始值}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
// BeginPlay
CurrentAmmo = DefaultAmmo;
```


## 使用武器时, 更新弹药库存, 无存货停止射击 {#使用武器时-更新弹药库存-无存货停止射击}


### 添加接口: 弹夹是否为空 {#添加接口-弹夹是否为空}

`ShootThemUp: Weapon/STUBaseWeapon.cpp`       <br/>

```cpp
bool ASTUBaseWeapon::IsClipEmpty() const
{
    return CurrentAmmo.Bullets == 0;
}
```


### 添加接口: 更换弹夹 {#添加接口-更换弹夹}

`ShootThemUp: Weapon/STUBaseWeapon.cpp`       <br/>

```cpp
void ASTUBaseWeapon::ChangeClip()
{
    CurrentAmmo.Bullets = DefaultAmmo.Bullets;
    if (!CurrentAmmo.Infinite)
    {
        --CurrentAmmo.Clips;
    }
    UE_LOG(LogBaseWeapon, Display, TEXT("---------Change Clip----------"));
}
```


### 添加接口: 是否还有弹药 {#添加接口-是否还有弹药}

`ShootThemUp: Weapon/STUBaseWeapon.cpp`       <br/>

```cpp
bool ASTUBaseWeapon::IsAmmoEmpty() const
{
    return CurrentAmmo.Infinite ? false : (!CurrentAmmo.Bullets && !CurrentAmmo.Clips);
}
```


### 添加接口: 输出弹药信息 {#添加接口-输出弹药信息}

目前没有UI, 在终端输入信息 <br/>
`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
void ASTUBaseWeapon::LogAmmo()
{
    FString AmmoInfo = "Ammo: " + FString::FromInt(CurrentAmmo.Bullets) + " / ";
    AmmoInfo += CurrentAmmo.Infinite ? "Infinite" : FString::FromInt(CurrentAmmo.Clips);
    UE_LOG(LogBaseWeapon, Display, TEXT("%s"), *AmmoInfo);
}
```


### 添加接口: 更新弹药库存 {#添加接口-更新弹药库存}

`ShootThemUp: Weapon/STUBaseWeapon.cpp`       <br/>

```cpp
void ASTUBaseWeapon::DecreaseAmmo()
{
    --CurrentAmmo.Bullets;
    LogAmmo();
    if (IsClipEmpty() && !IsAmmoEmpty())
    {
        ChangeClip();
    }
}
```


### 添加声明 {#添加声明}

`protected` <br/>
`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
bool IsClipEmpty() const;
void ChangeClip();
bool IsAmmoEmpty() const;
void LogAmmo();
void DecreaseAmmo();
```


### 射击时判断弹药库存, 更新弹药数据 {#射击时判断弹药库存-更新弹药数据}

-   步枪 <br/>
    `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
    ```cpp
    // MakeShot
    
    if (IsAmmoEmpty()) return;
    
    DecreaseAmmo();
    ```
-   榴弹发射器 <br/>
    `ShootThemUp: Weapon/STULauncherWeapon.cpp` <br/>
    ```cpp
    // MakeShot
    
    if (IsAmmoEmpty()) return;
    
    DecreaseAmmo();
    ```


## 查看 {#查看}

1.  设置步枪和榴弹发射器的初始弹药 <br/>
    
    | DefaultAmmo          | Infinite | Bullets | Clips |
    |----------------------|----------|---------|-------|
    | BP_STULauncherWeapon | false    | 1       | 5     |
    | BP_STURifleWeapon    | true     | 15      | 10    |
2.  日志 <br/>
    
    -   步枪能不停换弹夹(可以把Clips初始值设为0) <br/>
    -   榴弹发射器可以射击6次: 已装载弹夹和剩余弹夹 <br/>
    
    <img src="/pic/武器/弹药数据/日志.png" width="600" /> <br/> <br/>


## 步枪连续射击定时器问题 {#步枪连续射击定时器问题}

`ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
弹药结束时关闭定时器 <br/>

```cpp
// MakeShot

if (IsAmmoEmpty())
{
    FireStop();
    return;
}
```

