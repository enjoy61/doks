---
title: "切换武器"
date: 2023-08-26T20:17:44
lastmod: 2023-08-27T07:16:57+08:00
draft: false
weight: 2016
---

## 概览 {#概览}

-   [X] 为HeroTPP添加Socket, 在背后挂载未使用武器 <br/>
-   [X] 绑定键位, 按下Tab或滚动鼠标时切换武器 <br/>
-   [X] 游戏角色死亡后, 销毁武器 <br/>
-   [X] 处理Rifle开火定时器 <br/>


## 为骨骼网格体添加Socket {#为骨骼网格体添加socket}

`虚幻编辑器` <br/>

1.  打开Content/ExternalContent/Animation/Characters/HeroTPP/HeroTPP <br/>
2.  选择骨骼b_Spine1, 添加Socket <br/>
3.  在细节面板设置Socket <br/>
    
    | -                 |                |
    |-------------------|----------------|
    | Socket Name       | ArmorySocket   |
    | Relative Location | (-9, -26, -23) |
    | Relative Rotation | (-10, 70, -29) |
    
    <img src="/pic/武器/切换武器/ArmorySocket.png" width="500" /> <br/> <br/>
4.  为Socket添加预览资产, 选择Launcher <br/>
    
    武器未使用时背在背上 <br/>
    
    <img src="/pic/武器/切换武器/预览资产.png" width="700" /> <br/> <br/>


## 绑定切换武器键位 {#绑定切换武器键位}

`项目设置 > Engine > Input > Action Mappings` <br/>

| -    |                                     |
|------|-------------------------------------|
| 函数描述 | NextWeapon                          |
| 键位 | Tab / MouseWheelUp / MouseWheelDown |

不论滚轮方向, 切换到下一个武器 <br/>

<img src="/pic/武器/切换武器/绑定键位.png" width="500" /> <br/> <br/>


## 搭建框架 {#搭建框架}

切换逻辑在STUWeaponComponent中 <br/>


### 添加空的回调函数 {#添加空的回调函数}

-   `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    `public` <br/>
    ```cpp
    void NextWeapon();
    ```
-   `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    void USTUWeaponComponent::NextWeapon()
    { }
    ```


### 绑定回调函数和函数描述 {#绑定回调函数和函数描述}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
// SetupPlayerInputComponent

PlayerInputComponent->BindAction("NextWeapon", IE_Pressed, WeaponComponent, &USTUWeaponComponent::NextWeapon);
```


## 调整当前逻辑 {#调整当前逻辑}


### 修改Socket名 {#修改socket名}

现在附加武器的Socket有两个, 原先的Socket为装载武器Socket <br/>

-   `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    WeaponAttachPointName -&gt; WeaponEquipSocketName <br/>
-   `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    // SpawnWeapon
    WeaponAttachPointName -> WeaponEquipSocketName          
    ```


### 添加接口: 将武器挂载到指定Socket {#添加接口-将武器挂载到指定socket}

切换武器时使用 <br/>


#### 定义 {#定义}

-   `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    `private` <br/>
    ```cpp
    void AttachWeaponToSocket(ASTUBaseWeapon *Weapon, USceneComponent *SceneComponent, const FName &SocketName);
    ```
-   `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    void USTUWeaponComponent::AttachWeaponToSocket(ASTUBaseWeapon *Weapon, USceneComponent *SceneComponent, const FName &SocketName)
    {
        if (!Weapon || !SceneComponent) return;
        FAttachmentTransformRules AttachmentRules(EAttachmentRule::SnapToTarget, false);
        Weapon->AttachToComponent(SceneComponent, AttachmentRules, SocketName);               
    }
    ```


#### 调用 {#调用}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
// SpawnWeapon
AttachWeaponToSocket(CurrentWeapon, Character->GetMesh(), WeaponEquipSocketName);           
```


## 武器数组 {#武器数组}

武器组件管理武器数组 <br/>


### 将武器类属性改为武器类属性数组 {#将武器类属性改为武器类属性数组}

`protected`        <br/>
`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
UPROPERTY(EditDefaultsOnly)
TArray<TSubclassOf<ASTUBaseWeapon>> WeaponClasses;
```


### 添加武器数组 {#添加武器数组}

`private`        <br/>
`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
UPROPERTY()
TArray<ASTUBaseWeapon*> Weapons;
```


### 添加数据成员: 保存挂载点名称 {#添加数据成员-保存挂载点名称}

`protected` <br/>
`ShootThemUp: Components/STUWeaponComponent.h`        <br/>

```cpp
UPROPERTY(EditDefaultsOnly)
FName WeaponArmorySocketName = "ArmorySocket";
```


### 动态生成武器时, 生成Rifle和Launcher, 先全部挂载到背上 {#动态生成武器时-生成rifle和launcher-先全部挂载到背上}


#### SpawnWeapons定义 {#spawnweapons定义}

-   `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    SpawnWeapon -&gt; SpawnWeapons <br/>
-   `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    ```cpp
    void USTUWeaponComponent::SpawnWeapons()
    {
        if (!GetWorld()) return;
    
        ACharacter *Character = Cast<ACharacter>(GetOwner());
        if (!Character) return;
    
        for (auto WeaponClass : WeaponClasses)
        {
            auto Weapon = GetWorld()->SpawnActor<ASTUBaseWeapon>(WeaponClass);
            if (!Weapon) return;
            Weapons.Add(Weapon);
            Weapon->SetOwner(Character);
            AttachWeaponToSocket(Weapon, Character->GetMesh(), WeaponArmorySocketName);
        }
    }
    ```


#### 在BeginPlay中调用 {#在beginplay中调用}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>


### 装载武器 {#装载武器}


#### 添加数据成员: 保存当前武器标号 {#添加数据成员-保存当前武器标号}

`private` <br/>
和CurrentWeapon相对应 <br/>
`ShootThemUp: Components/STUWeaponComponent.h`         <br/>

```cpp
int32 CurrentWeaponIndex = 0;
```


#### EquipWeapon定义 {#equipweapon定义}

-   `ShootThemUp: Components/STUWeaponComponent.h` <br/>
    `private` <br/>
    ```cpp
    void EquipWeapon(int32 WeaponIndex);
    ```
-   `ShootThemUp: Components/STUWeaponComponent.cpp` <br/>
    设置CurrentWeapon指针, 将武器挂载到WeaponEquipSocketName <br/>
    ```cpp
    void USTUWeaponComponent::EquipWeapon(int32 WeaponIndex)
    {
        ACharacter *Character = Cast<ACharacter>(GetOwner());
        if (!Character) return;
    
        if (CurrentWeapon)
        {
            AttachWeaponToSocket(CurrentWeapon, Character->GetMesh(), WeaponArmorySocketName);               
        }
    
        CurrentWeapon = Weapons[WeaponIndex];
        AttachWeaponToSocket(CurrentWeapon, Character->GetMesh(), WeaponEquipSocketName);
    }
    ```


#### 动态生成武器后, 需装载武器 {#动态生成武器后-需装载武器}

`ShootThemUp: Components/STUWeaponComponent.cpp`         <br/>

```cpp
// BeginPlay

CurrentWeaponIndex = 0;
EquipWeapon(CurrentWeaponIndex);
```


## 实现切换武器回调函数 {#实现切换武器回调函数}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
void USTUWeaponComponent::NextWeapon()
{
    CurrentWeaponIndex = (1 + CurrentWeaponIndex) % Weapons.Num();
    EquipWeapon(CurrentWeaponIndex);
}
```


## 查看 {#查看}

1.  设置游戏角色武器类属性数组 <br/>
    
    <img src="/pic/武器/切换武器/武器类属性数组.png" width="700" /> <br/> <br/>
2.  武器切换和使用正常 <br/>
    
    <img src="/pic/武器/切换武器/查看.png" width="1000" /> <br/> <br/>


## 游戏角色死亡时, 销毁武器 {#游戏角色死亡时-销毁武器}

-   对游戏角色调用Destroy, 会对游戏角色调用EndPlay <br/>
-   先调用组件的EndPlay, 再对游戏角色调用EndPlay <br/>
-   覆写EndPlay, 销毁武器Actor <br/>

`ShootThemUp: Components/STUWeaponComponent.h` <br/>
`protected` <br/>

```cpp
virtual void EndPlay(const EEndPlayReason::Type EndPlayReason) override;
```

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
void USTUWeaponComponent::EndPlay(const EEndPlayReason::Type EndPlayReason)
{
    CurrentWeapon = nullptr;
    for (auto Weapon : Weapons)
    {
        // 卸载Actor的网格体, 与AttachToComponent相反
        Weapon->DetachFromActor(FDetachmentTransformRules::KeepWorldTransform); // 此处是静态结构体, 不是枚举成员

        // 销毁Actor
        Weapon->Destroy();
    }
    Weapons.Empty(); // 清空数组

    // 也可以关闭武器的物理碰撞, 将武器保留在关卡, 几秒钟后销毁武器
    Super::EndPlay(EndPlayReason);
}
```


## 处理Rifle开火定时器 {#处理rifle开火定时器}


### 切换武器时, 关闭定时器 {#切换武器时-关闭定时器}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
// EquipWeapon

 if (CurrentWeapon)
 {
     // 其他处理
     CurrentWeapon->FireStop();
 }
```


### 游戏角色死亡后, 关闭定时器 {#游戏角色死亡后-关闭定时器}

`ShootThemUp: Player/STUBaseCharacter.cpp` <br/>

```cpp
// OnDeath
WeaponComponent->FireStop();
```

