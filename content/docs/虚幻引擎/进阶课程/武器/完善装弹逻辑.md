---
title: "完善装弹逻辑"
date: 2023-09-07T21:53:27
lastmod: 2023-10-05T14:48:06+08:00
draft: false
weight: 2023
---

## 说明 {#说明}

1.  自动装弹时播放动画 <br/>
2.  手动装弹时更新弹药库存 <br/>


## 概览 {#概览}

-   [X] 定义委托类型, 用于自动装弹 <br/>
-   [X] 提取封装装弹逻辑, 供手动/自动装弹时使用 <br/>


## 在武器类定义委托, 需要更换弹夹时进行通知 {#在武器类定义委托-需要更换弹夹时进行通知}


### 定义委托, 在弹药用完时行通知客户端 {#定义委托-在弹药用完时行通知客户端}

`ShootThemUp: Weapon/STUBaseWeapon.h`      <br/>

```cpp
DECLARE_MULTICAST_DELEGATE(FOnClipEmptySignature);
```


### 添加数据成员 {#添加数据成员}

`public`       <br/>
`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>

```cpp
FOnClipEmptySignature OnClipEmpty;
```


### 弹药用完时, 通知客户端, 由客户端负责后续处理 {#弹药用完时-通知客户端-由客户端负责后续处理}

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
// DecreaseAmmo

if (IsClipEmpty() && !IsAmmoEmpty())
{
    // ChangeClip();
    OnClipEmpty.Broadcast();
}
```


### 将ChangeClip改为public, 供武器组件在处理函数中调用 {#将changeclip改为public-供武器组件在处理函数中调用}

`ShootThemUp: Weapon/STUBaseWeapon.h`       <br/>


## 在武器类中添加接口 {#在武器类中添加接口}


### 是否满足手动更换弹夹条件 {#是否满足手动更换弹夹条件}

-   当前弹夹不是满的 <br/>
-   还有其他弹夹 <br/>

`ShootThemUp: Weapon/STUBaseWeapon.h` <br/>
`public` <br/>

```cpp
bool CanReload();
```

`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
bool ASTUBaseWeapon::CanReload()
{
    return CurrentAmmo.Bullets < DefaultAmmo.Bullets && CurrentAmmo.Clips > 0;
}
```


### 更换弹夹时, 检查剩余弹夹数 {#更换弹夹时-检查剩余弹夹数}

DecreaseAmmo中调用ChangeClip时, 已检查过弹药库存; 手动装弹时需要该判断 <br/>
`ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>

```cpp
void ASTUBaseWeapon::ChangeClip()
{
    if (!CurrentAmmo.Infinite)
    {
        if (CurrentAmmo.Clips == 0)
        {
            UE_LOG(LogBaseWeapon, Warning, TEXT("No more clips"));
            return;
        }
        --CurrentAmmo.Clips;
    }
    CurrentAmmo.Bullets = DefaultAmmo.Bullets;    
    UE_LOG(LogBaseWeapon, Display, TEXT("---------Change Clip----------"));
}
```


### 减少子弹时, 检查子弹数 {#减少子弹时-检查子弹数}

_在MakeShot中调用DecreaseAmmo, 已检查过弹药库存_ <br/>
`ShootThemUp: Weapon/STUBaseWeapon.cpp`       <br/>

```cpp
// DecreaseAmmo

if (CurrentAmmo.Bullets == 0)
{
    UE_LOG(LogBaseWeapon, Warning, TEXT("Clips is empty"));
    return;
}
```


## 武器组件注册更换弹夹通知服务 {#武器组件注册更换弹夹通知服务}


### 添加空的处理函数 {#添加空的处理函数}

`private` <br/>
`ShootThemUp: Components/STUWeaponComponent.h` <br/>

```cpp
void OnEmptyClip();
```

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
void USTUWeaponComponent::OnEmptyClip() {}
```


### 创建武器后, 为武器注册服务 {#创建武器后-为武器注册服务}

`ShootThemUp: Components/STUWeaponComponent.cpp`       <br/>

```cpp
Weapon->OnClipEmpty.AddUObject(this, &USTUWeaponComponent::OnEmptyClip);        
```


## 实现装弹逻辑 {#实现装弹逻辑}


### 装弹检查时, 检查弹药库存 {#装弹检查时-检查弹药库存}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
// CanReload

return CurrentWeapon //
  && !EquipAnimInProgress //
  && !ReloadAnimInProgress //
  && CurrentWeapon->CanReload();
```


### 添加接口, 实现更换弹夹逻辑 {#添加接口-实现更换弹夹逻辑}

1.  关闭连续开火定时器 <br/>
2.  调用武器更换弹夹逻辑 <br/>

`ShootThemUp: Components/STUWeaponComponent.h` <br/>
`private`       <br/>

```cpp
void ChangeClip();
```

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
void USTUWeaponComponent::ChangeClip()
{
    if (!CanReload()) return;
    CurrentWeapon->FireStop();
    CurrentWeapon->ChangeClip();
    ReloadAnimInProgress = true;
    PlayAnimMontage(CurrentReloadAnimMontage);
}
```


## 手动装弹时, 调用ChangeClip {#手动装弹时-调用changeclip}

屏蔽Reload原逻辑 <br/>
`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
// Reload

ChangeClip();
```


## 自动装弹时, 调用ChangeClip {#自动装弹时-调用changeclip}

`ShootThemUp: Components/STUWeaponComponent.cpp` <br/>

```cpp
// OnEmptyClip

ChangeClip();
```


## 查看 {#查看}

当弹夹里的子弹只剩最后一个时, 持续射击, 自动更换完弹夹后, 射击继续 <br/>

| -         |                            |               |                          |
|-----------|----------------------------|---------------|--------------------------|
| FireStart | MakeShot &gt; DecreaseAmmo | 子弹数减为0, 通知客户端 | OnEmptyClip中更换了弹夹并关闭了定时器 |
|           | 开启定时器                 |               |                          |


### 解决方法 {#解决方法}

1.  FireStart中, 先开启定时器, 再射击 <br/>
    `ShootThemUp: Weapon/STURifleWeapon.cpp` <br/>
    ```cpp
    // FireStart
    
    GetWorldTimerManager().SetTimer(ShotTimerHandle, this, &ASTURifleWeapon::MakeShot, TimeBetweenShots, true);
    MakeShot();           
    ```
2.  通知弹夹为空之前, 关闭开火定时器 <br/>
    `ShootThemUp: Weapon/STUBaseWeapon.cpp` <br/>
    ```cpp
    // DecreaseAmmo
    
    if (IsClipEmpty() && !IsAmmoEmpty())
    {
        FireStop();
        OnClipEmpty.Broadcast();
    }
    ```

