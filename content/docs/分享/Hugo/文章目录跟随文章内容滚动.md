---
title: "文章目录跟随文章内容滚动"
date: 2023-06-10T10:46:13
lastmod: 2023-08-16T02:58:00+08:00
draft: false
weight: 1004
---

## 说明 {#说明}

1.  监听滚动事件, 触发定时器, 到时实现文章目录滚动跟随 <br/>
2.  浏览器支持 <br/>
    
    | -       | docs-toc scrollTop | my-toc scrollTop | 文章目录跳转                    |
    |---------|--------------------|------------------|---------------------------|
    | Safari  | O                  | X                | -                               |
    | Firefox | O                  | X                | -                               |
    | Chrome  | O                  | O                | docs-toc需要定时器, 延时要求大于文章目录跳转最大耗时 |


## 滚动监听 {#滚动监听}

1.  window添加事件监听 <br/>
    ```javascript
    window.addEventListener('scroll', () => {
        // 处理
      });
    ```
2.  window注册滚动处理 <br/>
    ```javascript
    window.onscroll = function () {
        // 处理
    };
    ```


## 进入判断 {#进入判断}

```javascript
document.addEventListener('DOMContentLoaded', () => {
  const myToc = document.querySelector('.my-toc');
  const fullToc = document.querySelector('.docs-toc');
  if (!myToc || !fullToc) return;

  // 后续处理  
});
```


## 滚动计算 {#滚动计算}


### 为标题排序, 厘清高亮标题相对位置 {#为标题排序-厘清高亮标题相对位置}

```javascript
let i = 0;
myToc.querySelectorAll('a').forEach(entry => {
    entry.setAttribute('scrollIdx', i++);
});
```


### 文章目录结构 {#文章目录结构}

.my-toc嵌套在.docs-toc中, .docs-toc多一个"文章目录"提示 <br/>

1.  根据.my-toc的滚动高度和其容纳的标题个数计算单个标题的高度 <br/>
    ```javascript
    function computeHeadingHeight() {
      const toc = document.querySelector('.my-toc');
      return toc.scrollHeight / toc.querySelectorAll('a').length;
    }
    ```
2.  计算页面能容纳的标题数，经过测试，取其1/6，可以使得高亮标题在文章目录偏上位置 <br/>
    ```javascript
    function computeUpIdx() {
      const fullToc = document.querySelector('.docs-toc');
      const myToc = document.querySelector('.my-toc');
      const offset = fullToc.scrollHeight - myToc.scrollHeight;
      const max = parseInt((window.innerHeight - offset) / headingHeight);
      return parseInt(max / 6);
    }
    ```
3.  添加全局变量, 保存单个标题高度和高亮标题理想位置 <br/>
    ```javascript
    let headingHeight, upIdx;
    
    headingHeight = computeHeadingHeight();
    upIdx = computeUpIdx();
    ```


### 注册监听处理, 开启定时器, 延时文章目录滚动 {#注册监听处理-开启定时器-延时文章目录滚动}

```javascript
const followTimerInterval = 300;
let followTimer = null; // 全局

window.onscroll = function () {
    clearTimeout(followTimer);
    followTimer = setTimeout(function () {
        // 文章目录滚动
        scrollFollow();
    }, followTimerInterval);
};
```


### 实现文章目录滚动 {#实现文章目录滚动}

1.  无标题高亮, 不作处理 <br/>
2.  多个标题高亮时, 选择第一个标题计算滚动偏移 <br/>

<!--listend-->

```javascript
function scrollFollow() {
  const activeHeadings = document.querySelector('.my-toc').querySelectorAll('a.active');
  if (activeHeadings.length > 0) {
    const heading = activeHeadings.item(0);
    const idx = heading.getAttribute('scrollIdx');
    const scrollTarget = idx - upIdx;
    document.querySelector('.docs-toc').scrollTop = headingHeight * scrollTarget;
  }
}
```


## 完整JavaScript代码 {#完整javascript代码}

```javascript
const followTimerInterval = 300;
let headingHeight, upIdx;
let followTimer = null;

function computeHeadingHeight() {
  const toc = document.querySelector('.my-toc');
  return toc.scrollHeight / toc.querySelectorAll('a').length;
}

function computeUpIdx() {
  const fullToc = document.querySelector('.docs-toc');
  const myToc = document.querySelector('.my-toc');
  const offset = fullToc.scrollHeight - myToc.scrollHeight;
  const max = parseInt((window.innerHeight - offset) / headingHeight);
  return parseInt(max / 6);
}

function scrollFollow() {
  const activeHeadings = document.querySelector('.my-toc').querySelectorAll('a.active');
  if (activeHeadings.length > 0) {
    const heading = activeHeadings.item(0);
    const idx = heading.getAttribute('scrollIdx');
    const scrollTarget = idx - upIdx;
    document.querySelector('.docs-toc').scrollTop = headingHeight * scrollTarget;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const myToc = document.querySelector('.my-toc');
  const fullToc = document.querySelector('.docs-toc');
  if (!myToc || !fullToc) return;

  let i = 0;
  myToc.querySelectorAll('a').forEach(entry => {
    entry.setAttribute('scrollIdx', i++);
  });

  headingHeight = computeHeadingHeight();
  upIdx = computeUpIdx();

  window.onscroll = function () {
    clearTimeout(followTimer);
    followTimer = setTimeout(function () {
      scrollFollow();
    }, followTimerInterval);
  };
});
```

