---
title: "文章目录标题高亮"
date: 2023-06-12T12:00:38
lastmod: 2023-08-15T21:43:03+08:00
draft: false
weight: 1003
---

## 说明 {#说明}

1.  设置高亮样式 `css` <br/>
2.  使用Intersection Observer实现 `JavaScript` <br/>
3.  文章目录设置 <br/>
    
    | -          |   |
    |------------|---|
    | startLevel | 2 |
    | endLevel   | 3 |
4.  另一个实现思路为Scrollspy <br/>
5.  移植到Doks主题 <br/>


## 便签 {#便签}

| -                                                                                                                             |                                       |
|-------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
| [文章目录滚动高亮](https://atpx.com/blog/typecho-to-hugo/#3-%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95%E6%BB%9A%E5%8A%A8%E9%AB%98%E4%BA%AE) | 1. 为文章目录设置类                   |
|                                                                                                                               | 2. 高亮样式                           |
|                                                                                                                               | 3. 一种实现                           |
| [高亮样式](https://blog.csdn.net/dangbai01_/article/details/120130875)                                                        | 当前标题底部加横线                    |
| [滚动高亮](https://johnmu.com/dynamic-toc-io/)                                                                                | 设置元素的父元素                      |
| [滚动高亮](https://tj.ie/building-a-table-of-contents-with-the-intersection-observer-api/)                                    | option和intersectionObserver的callback |
| [IntersectionObserver API](https://www.ruanyifeng.com/blog/2016/11/intersectionobserver_api.html)                             | 1. 添加观察元素: observe              |
|                                                                                                                               | 2. intersectionRatio                  |
|                                                                                                                               | 3. target                             |
| [querySelectorAll用法](https://www.runoob.com/jsref/met-document-queryselectorall.html)                                       | 1. 获取有指定属性的元素: "a[target]"  |
|                                                                                                                               | 2. 获取指定父元素的元素: "div &gt; p" |
|                                                                                                                               | 3. 获取多个分类元素: "h2[id], h3[id]" |
| [获取元素的方式](https://www.jianshu.com/p/6fefda57b51f)                                                                      | 1. id: getElementById, 上下文要求时documnet |
|                                                                                                                               | 2. name: getElementsByName, 一组      |


## 文章目录 {#文章目录}

-   Doks主题通过设置startLevel和endLevel限制ToC显示的标题。endLevel上限为4，startLevel一般从2开始 <br/>
-   高亮的是ToC中的链接 <br/>


### 高亮样式 {#高亮样式}

-   设置颜色 <br/>
-   加粗 <br/>
-   过渡 <br/>
-   暗色主题 <br/>

assets/scss/common/_global.scss   <br/>

```css
.my-toc a.active {
    color: $primary;
    font-weight: 800;
    transition: all .25s ease-in-out
}
```

assets/scss/common/_dark.scss <br/>

```css
[data-dark-mode] .my-toc a.active {
    // color: $link-color-dark;
    color: $zdoc-highlight-dark;
}
```


### 为ToC设置类 {#为toc设置类}

layouts/partials/sidebar/docs-toc.html:23 <br/>

```css
<nav class="my-toc">
  {{ .TableOfContents }}
</nav>
```


## 正文标题 {#正文标题}

只关注显示在文章目录的标题, 筛选时, 要求标题的下级链接有类anchor <br/>

```javascript
const headings = Array.apply(null, document.querySelectorAll('h2[id], h3[id]')).filter(function (value, index, arr) {
    return arr[index].querySelector('.anchor');
});
```


## 文章目录标题 {#文章目录标题}

获取有类my-toc的元素的链接 <br/>

```javascript
const toc = document.querySelector('.my-toc').querySelectorAll('a');
```


## 将文章目录和正文标题关联 {#将文章目录和正文标题关联}

当二者标题数一致时, 认为一一对应, 设置标号; 否则就此结束 <br/>

```javascript
function addHeadingIdx(list) {
  let i = 0;
  list.forEach((item) => {
    item.setAttribute('headingIdx', i++);
  });
}

if (toc.length === headings.length) {
    addHeadingIdx(toc);
    addHeadingIdx(headings);

    // 其他处理
}
```


## 搭建交叉观察框架 {#搭建交叉观察框架}

1.  触发条件：当标题的intersectionRatio变为1，或者不再为1时，对标题进行处理 <br/>
    ```javascript
    const intersectionOptions = {
      threshold: 1.0
    }
    ```
2.  创建观察器 <br/>
    ```javascript
    const headingObserver = new IntersectionObserver(headings => {
        headings.forEach(heading => {
            // 处理标题
        })
    }, intersectionOptions); 
    ```
3.  将正文标题添加到观察列表 <br/>
    ```javascript
    headings.forEach((heading) => {
        headingObserver.observe(heading);
    });
    ```


## 为当前标题添加/移除高亮 {#为当前标题添加-移除高亮}

1.  标题的intersectionRatio满足阈值，isIntersecting为true，intersectionRatio不满足阈值，其为false <br/>
2.  若标题isIntersecting变为true, 为其添加高亮; 变为false，若当前只一个标题高亮, 不作处理, 否则, 移除高亮 <br/>


### 添加全局数组，保存标题高亮状态，初始值为false {#添加全局数组-保存标题高亮状态-初始值为false}

```javascript
let headingFlag;

headingFlag = new Array(headings.length).fill(false);
```


### 添加变量，统计高亮标题个数 {#添加变量-统计高亮标题个数}

```javascript
let headingCnt = 0;
```


### 进入观察器回调函数时，更新标题高亮状态; 标题满足阈值，或者高亮标题个数大于1，根据高亮状态设置标题，更新高亮个数 {#进入观察器回调函数时-更新标题高亮状态-标题满足阈值-或者高亮标题个数大于1-根据高亮状态设置标题-更新高亮个数}

```javascript
function refreshHighlight() {
    headingCnt = 0;
    for (var i = 0; i < headingFlag.length; ++i) {
        if (headingFlag[i]) {
            headingCnt++;
            document.querySelector(`.my-toc a[headingIdx="${i}"]`).classList.add('active');
        }
        else
        {
            document.querySelector(`.my-toc a[headingIdx="${i}"]`).classList.remove('active');
        }
    }
}

const idx = heading.target.getAttribute('headingIdx');
if ((headingFlag[idx] = heading.isIntersecting) || (headingCnt !== 1)) {
    refreshHighlight();
}
```


## 完整Javascript代码 {#完整javascript代码}

assets/js/toc.js <br/>

```javascript
function addHeadingIdx(list) {
  let i = 0;
  list.forEach((item) => {
    item.setAttribute('headingIdx', i++);
  });
}

let headingFlag;
let headingCnt = 0;

function refreshHighlight() {
  headingCnt = 0;
  for (var i = 0; i < headingFlag.length; ++i) {
    if (headingFlag[i]) {
      headingCnt++;
      document.querySelector(`.my-toc a[headingIdx="${i}"]`).classList.add('active');
    }
    else
    {
      document.querySelector(`.my-toc a[headingIdx="${i}"]`).classList.remove('active');
    }
  }
}

const intersectionOptions = {
  threshold: 1.0
}

document.addEventListener('DOMContentLoaded', () => {
  const headings = Array.apply(null, document.querySelectorAll('h2[id], h3[id]')).filter(function (value, index, arr) {
    return arr[index].querySelector('.anchor');
  });
  const toc = document.querySelector('.my-toc').querySelectorAll('a');

  if (toc.length === headings.length) {
    addHeadingIdx(toc);
    addHeadingIdx(headings);

    const headingObserver = new IntersectionObserver(headings => {
      headings.forEach(heading => {
        // console.log('ratio', heading.target.getAttribute('id'), heading.intersectionRatio, heading.isIntersecting, headingCnt);
        const idx = heading.target.getAttribute('headingIdx');
        if ((headingFlag[idx] = heading.isIntersecting) || (headingCnt !== 1)) {
          refreshHighlight();
        }
      });
    }, intersectionOptions); 

    headings.forEach((heading) => {
      headingObserver.observe(heading);
    });

    headingFlag = new Array(headings.length).fill(false);
  }
});
```


## Doks主题执行JavaScript脚本 {#doks主题执行javascript脚本}

参考assets/highlight.js的执行 <br/>

`layouts/partials/footer/script-footer.html`     <br/>

1.  `10` <br/>
    ```html
    {{ $toc := resources.Get "js/toc.js" -}}
    {{ $toc := $toc | js.Build -}}
    ```
2.  `86` <br/>
    ```html
    <script src="{{ $toc.RelPermalink }}" defer></script>
    ```
3.  `103` <br/>
    ```html
    {{ $toc := $toc | minify | fingerprint "sha512" -}}         
    ```
4.  `113` <br/>
    ```html
    <script src="{{ $toc.RelPermalink }}" integrity="{{ $toc.Data.Integrity }}" crossorigin="anonymous" defer></script>
    ```

